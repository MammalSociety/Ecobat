---
title: "Bat Activity Analysis"
subtitle: 'Site Name: `r params$SiteName`'
author: 'Author: `r params$Author`'
date: '`r strftime(Sys.time(), format = "%d/%m/%Y")`'
output: 
    word_document:
      reference_docx: stylesdoc.docx
params:
  n: NA
  Author: NA
  SiteName: NA
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message=FALSE, comment=NULL)

#Libraries used
library(tidyverse) # Enables a consistent approach to data science
library(rmarkdown)
library(knitr) # needed for rmarkdown 
library(dplyr) # used for all data wrangling (execpt percentiles)
library(plyr) # percentiles code uses plyr as its older (needs updating)
library(suncalc) # Suntimes
library(lubridate) # best package for working with dates and times
library(ggplot2) # plotting graphs
library(ggforce) # needed for facet_wrap_paginate for plotting graphs on diff pages
library(pander) # useful for table creation in the markdown doc
library(reshape2) # used for wide/short data format conversions
library(janitor) # used to add totals rows to bottoms of tables
library(RColorBrewer) # used for colourblind friendly colour scales on figures
library(rcompanion)
library(png)
library(grid)

```

```{r test data}

# TESTING - load in test data

#B_data <- read.csv("../Data/RiggedHill.csv")
#B_data <- read.csv("//smbhome.uscs.susx.ac.uk/brs28/Downloads/Bchrist.csv")
#B_data <- read.csv("./test_data.csv")
#B_data <- read.csv("//smbhome.uscs.susx.ac.uk/brs28/Desktop/download.csv")



```

```{r data}
# SHINY

#this is here for when the script is finalised and the Shiny app is deployed
#read data in from shiny

B_data <- params$n

```


```{r variables}

# Standardize Variables@


# Output CSV from Ecobat puts weird symbol in front of location name, so need to remove:
cnames <- names(B_data)
cnames[grepl('location_name$', cnames)] <- 'location_name'
names(B_data) <- cnames


# if there is a separate column for date and time then join together to form a new column called Timestamp
if (("date" %in% colnames(B_data) == TRUE) &
  ("time" %in% colnames(B_data) == TRUE)) {

B_data$timestamp <- paste(B_data$date, B_data$time) }

# format correctly and specify timezone
# "Europe/London" accounts for daylight savings
B_data$DateTime <- lubridate::ymd_hms(B_data$timestamp, tz = "Europe/London")

# if above code gives NA, date format is dmy not ymd so do this:
if (NA %in% B_data$DateTime) {
  B_data$DateTime <- lubridate::dmy_hms(B_data$timestamp, tz = "Europe/London")
}


# Create Useful Variables

# `Night` date at dusk
# `Month` month of observation `Jan, Feb, Mar....`
# `JustTime` time hh:mm of bat observation (12 hours added so plots correctly as `Night` i.e. dusk to dawn)

B_data2 <- B_data %>% 
  mutate(Night = DateTime - lubridate::hours(12)) %>% # DateTime minus 12 hours
  mutate(Night = lubridate::as_date(Night)) %>%
  mutate(Month = lubridate::month(Night, label = T)) %>% # Make Month of observation
  filter(!is.na(species)) 

```




```{r suntimes}

# Create suntimes

# Use package `suncalcs` to make `sunset` and `sunrise` columns for each `Night` and the location (`lat` and `lon`) of the bat survey.

# Get number nights between first and last bat observation (plus 1 for dawn)
num_nights <- as.integer(difftime(max(B_data2$Night) , 
                                  min(B_data2$Night) , 
                                  units = c("days"))) + 1

# Make a date vector of nights between first and last bat observation.
nightlist <- seq.Date(from=min(B_data2$Night), 
                   length.out = num_nights +1, 
                   by='days')

# Get suntimes for date vector and Location (lat and lon)
setdata <- getSunlightTimes(date = nightlist, 
                            lat = median(B_data2$lat, na.rm = T), 
                            lon = median(B_data2$lon, na.rm = T), 
                            tz = "Europe/London")

# Duplicate data.frame to make sunrise data
risedata <- setdata

# Select  sunset date and time
setdata2 <- setdata %>% 
  select(date, sunset) %>% 
  mutate(date = lubridate::as_date(date))

# Select  sunrise date and time
risedata2 <- risedata %>% 
  select(date, sunrise) %>% 
  mutate(date = lubridate::as_date(date)) %>%
  mutate(date = date - lubridate::days(1))


# Combine sunset and risedata by 
sun_data <- dplyr::full_join(setdata2, risedata2, by="date")

# Rename date as Night
colnames(sun_data) <- c("Night", "sunset", "sunrise")

sun_data <- sun_data %>% 
  mutate(night_length_hr = as.numeric(difftime(sunrise, sunset, units='hours')),
         night_length_min = as.numeric(difftime(sunrise, sunset, units='mins')))


# Join bat data with the sundata by Night
joined_data <- dplyr::left_join(B_data2, sun_data, by="Night")

```


```{r}
#  ## Create Variables Relative to Suntimes and Bat Observation 
# 
#  Variables relative to suntimes and bat observation   
# 
# * `post_set_min` bat observation time minutes after sunset  
#  * `pre_rise_min` bat observation time minutes before sunrise   
#  * `post_set_hr` bat observation time hours after sunset  
#  * `pre_rise_hr` bat observation time hours before sunrise   
#  * `post_set_hr_int` bat observation time as an integer (hour) after sunset  
#      + `-0.5` to `0.49` hours is `0` hour   
#      + `0.5` to `1.49` hours is `1` hour   
#      + `1.5` to `2.49` hours is `2` hour   
#      + `2.5` to `3.49` hours is `3` hour ect...  

#  * `pre_rise_hr_int` bat observation time as an integer (hour) before sunrise  
#      + `-0.5` to `0.49` hours is `0` hour   
#      + `0.5` to `1.49` hours is `1` hour   
#      + `1.5` to `2.49` hours is `2` hour   
#      + `2.5` to `3.49` hours is `3` hour ect...   
#  * `night_length_hr`  length of the night in hours    


# To make sure difference is in minutes/hours etc... use difftime 
All_data <- joined_data %>% 
  mutate(post_set_min = as.numeric(difftime(DateTime, sunset, units='mins')),
         pre_rise_min = as.numeric(difftime(sunrise, DateTime, units='mins')),
         post_set_hr = as.numeric(difftime(DateTime, sunset, units='hours')),
         pre_rise_hr = as.numeric(difftime(sunrise, DateTime, units='hours')),
         post_set_hr_int = as.integer(round(post_set_hr, digits = 0)),
         pre_rise_hr_int = as.integer(round(pre_rise_hr, digits = 0)))

```

```{r roost emergence}

#Russ(2012) Bat roost emergence times minutes after sunset

# correspond a common name to each scientific name
species <- c("Barbastella barbastellus",
              "Eptesicus serotinus",
              "Eptesicus",
              "Myotis alcathoe",
              "Myotis bechsteinii",
              "Myotis brandtii",
              "Myotis daubentonii",
              "Myotis mystacinus",
              "Myotis nattereri",
              "Myotis",
              "Nyctalus leisleri",
              "Nyctalus noctula",
              "Nyctalus",
              "Nyctaloid",
              "Pipistrellus nathusii",
              "Pipistrellus pipistrellus",
              "Pipistrellus pygmaeus",
              "Pipistrellus",
              "Plecotus auritus",
              "Plecotus austriacus",
              "Plecotus",
              "Rhinolophus ferrumequinum",
              "Rhinolophus hipposideros",
              "Rhinolophus")

Spp <- c("Barbastelle",
         "Serotine",
         "Serotine",
         "Alcathoe",
         "Bechstein's",
         "Brandt's",
         "Daubenton's",
         "Whiskered",
         "Natterer's",
         "Myotis",
         "Leisler's",
         "Noctule",
         "Nyctalus",
         "Nyctaloid",
         "Nathusius'",
         "Common pipistrelle",
         "Soprano pipistrelle",
         "Pipistrellus",
         "Brown long-eared",
         "Grey long-eared",
         "Long-eared bats",
         "Greater horseshoe",
         "Lesser horseshoe",
         "Horseshoe bats")


# create a table of roost emergence times for each species
lower <- c(25, 20, 20, 30, 30, 30, 50, 30, 35, 30, 8, 5, 5, 5, 18, 22, 22, 18, 40, 40, 40, 35, 35, 35)
upper <- c(60, 25, 25, 35, 33, 35, 70, 35, 55, 70, 18, 9, 18, 25, 28, 32, 28, 32, 60, 60, 60, 48, 50, 50)
russ <- tibble(species, Spp, lower, upper)


```


```{r more variables}
#Join with Jon Russ data with bat observation data All_data
All_data <- dplyr::left_join(All_data, russ, by = "species")

# add a column for bat passes per hour
All_data$passes.per.hour <- round((All_data$passes/All_data$night_length_hr),
                                  digits = 2)


# create lists to be used for tables and graphs later:

# list of all of the unique locations in the dataset
Dets <- c(unique(All_data$location_name))

# list of all of the different species in the dataset
species_list <- unique(All_data$species)
Spp_list <- unique(All_data$Spp)

# dataframe of survey days 
Surv.days <- as.data.frame(unique(All_data$Night)) #all unique survey nights

Surv.days.N <- length(Surv.days$`unique(All_data$Night)`) #count of survey nights

Surv.days.M <- Surv.days %>%
  mutate(Month = lubridate::month((unique(All_data$Night)), label = T)) %>%
  dplyr::count(Month) #count of survey days per month


colourCount <- length(unique(All_data$Spp))
getPalette <- colorRampPalette(brewer.pal(9, "RdBu"))



# specify order for the species to be listed in

All_data$Spp <- factor(All_data$Spp,levels=c("Pipistrellus", "Common pipistrelle", "Soprano pipistrelle", "Nathusius'", "Noctule", "Leisler's", "Nyctalus", "Serotine", "Nyctaloid", "Brown long-eared", "Grey long-eared", "Long-eared bats", "Myotis","Alcathoe", "Bechstein's",  "Brandt's", "Daubenton's","Whiskered", "Natterer's", "Barbastelle", "Greater horseshoe", "Lesser horseshoe", "Horseshoe bats"))
         
```


# Summary

Bats were detected on **`r Surv.days.N`** nights between **`r min(All_data$Night)`** and **`r max(All_data$Night)`**, using **`r (length(Dets))`** static bat detectors. Throughout this period **`r (length(species_list))`** species were recorded. Detectors were placed at the following locations:

```{r det locations}

Table <- All_data %>%
  dplyr::select(location_name, lat, lon) %>%
  dplyr::group_by(location_name, lat, lon) %>%
  dplyr::distinct() %>%
  dplyr::rename("Detector ID" = location_name, "Latitude" = lat,
                "Longitude" = lon)

knitr::kable(Table, align = "l")


```

##### Page Break

# Survey Nights
The number of nights that bats were detected on each recorder. This is not the same as the number of nights that detectors were active if there were nights when no bats were detected.

```{r table}

Table <- All_data %>%
  dplyr::group_by(location_name) %>%
  dplyr::summarise(count = n_distinct(Night)) %>%
  dplyr::arrange(location_name) %>%
  dplyr::rename("Detector ID" = location_name) %>%
  dplyr::rename("No. of nights" = count)

knitr::kable(Table, align = "l")

```

##### Page Break

# Survey Nights
Horizontal bars show nights when acoustic detectors recorded bats.
\newline

```{r fig.width=12, fig.height=6}

Effort <- All_data %>%
  dplyr::arrange(location_name, Night) %>%
  dplyr::group_by(location_name, Night) %>%
  dplyr::filter(row_number()==1) %>%
  dplyr::ungroup() %>%
  dplyr::select(location_name, Night) %>%
  dplyr::group_by(location_name) %>%
  dplyr::mutate(diff_days = round(as.numeric(difftime(Night, lag(Night), units='days')), digits = 1)) %>%
  replace(is.na(.), 0) %>%
  dplyr::mutate(start = if_else(diff_days == 0 | diff_days > 1, paste(as.Date(Night)), "")) %>%
  dplyr::mutate(end = if_else(start != "", paste(lag(as.Date(Night))), "")) %>%
  dplyr::mutate(end = ifelse(row_number()==n(), paste(as.Date(Night)), end)) %>%
  dplyr::filter(start != "" | end != "") %>%
  dplyr::mutate_at(c("end"), funs(lead), n=1) %>%
  replace(is.na(.), 0) %>%
  dplyr::mutate_at(c("end"), funs(ifelse(. == 0, paste(as.Date(start)), .))) %>%
  dplyr::filter(end != "NA")


Effort$start <- as.Date(Effort$start)
Effort$end <- as.Date(Effort$end)
Effort$location_name <- as.character(Effort$location_name)


Effort %>%
  ggplot() +
  geom_segment(aes(x=start, xend=end, y=location_name, yend=location_name), size = 4) +
  geom_point(aes(start, location_name), colour = "black",  shape = 16, size = 3.6) +
  geom_point(aes(end, location_name),  colour = "black", shape = 16, size = 3.6) +
  xlab("\nDate") +
  ylab("Detector ID\n") +
  scale_x_date(date_labels = "%b %d") +
  theme_bw() +
  theme(legend.position = "none") +
  theme (axis.title.y = element_text(colour="black", size=16,
                                     face="bold")) +
  theme (axis.title.x = element_text(colour="black", size=16,
                                     face="bold")) +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_rect(colour="black", linetype="solid"),
        axis.line=element_line(size=0.5, colour="black",
                               linetype="solid")) +
  theme(axis.text.x = element_text(size=14, hjust=1, vjust=0.5,
                                   colour = "black", angle = 90)) +
  theme(axis.text.y = element_text(size = 14, colour = "black")) +
  theme(legend.text=element_text(size=14)) +
  theme(legend.title=element_text(size=16))



```

##### Page Break

```{r}

# PERCENTILES 

# only select one of each group and remove time, this leaves a df where each row is a nightly summary
df <- All_data %>%
  dplyr::group_by(location_name, Night, Spp) %>%
  dplyr::top_n(1) %>%
  filter(row_number()==1) %>%
  dplyr::select(-time)

df$location_name <- as.character(df$location_name)


recordsum <- ddply(df, c("location_name", "Spp"), summarise, 
                   surv = length(species))
#now merge this back into the original csv - we don't want to delete any files at this stage
wp <- merge(df, recordsum, c("location_name","Spp")) #merge with original dataset - adds surv column onto end of dataset



spn<-length(unique(df$Spp))
loc<-length(unique(df$location_name))
locs<-length(unique(df$site_name))

# for the dates graphs, when >1 loc & >1 spp
n_pages <- ceiling(nrow(unique(df[,c("species", "location_name")]))/8)

# when 1 loc & >1 spp
n_pages1 <- ceiling(nrow(unique(df[,c("species", "location_name")]))/5)

n_pages2 <- ceiling(nrow(unique(df[,c("species")]))/4)


cbbPalette <- c("#D55E00", "#0072B2","#56B4E9","#009E73","#E69F00") #set colour palette for graphs
```

## PART 1: Percentiles Analysis

The reference range dataset was stratified to include:

`r if('1' %in% df$date_filter) {'* Only records from within 30 days of the survey date.  '}`

`r if('0' %in% df$date_filter) {'* Records from any time of year.  '}`

`r if('200' %in% df$location_filter) {'* Only records from within 200km^2^ of the survey location.  '}`

`r if('100' %in% df$location_filter) {'* Only records from within 100km^2^ of the survey location.  '}`

`r if("NO" %in% df$location_filter) {'* Records from across the entire UK.  '}`

`r if("No" %in% df$detector_make_filter) {'* Records using any make of bat detector.  '}`

`r if("Batbox" %in% df$detector_make_filter) {'* Only records using Batbox bat detectors.  '}`

`r if("Ciel" %in% df$detector_make_filter) {'* Only records using Ciel bat detectors.  '}`

`r if("Courtpan" %in% df$detector_make_filter) {'* Only records using Courtpan bat detectors.  '}`

`r if("Elekon" %in% df$detector_make_filter) {'* Only records using Elekon bat detectors.  '}`

`r if("Magenta" %in% df$detector_make_filter) {'* Only records using Magenta bat detectors.  '}`

`r if("Peersonic" %in% df$detector_make_filter) {'* Only records using Peersonic bat detectors.  '}`

`r if("Pettersson" %in% df$detector_make_filter) {'* Only records using Pettersson bat detectors.  '}`

`r if("Titley Scientific" %in% df$detector_make_filter) {'* Only records using Titley Scientific bat detectors.  '}`

`r if("Wildlife Acoustics" %in% df$detector_make_filter) {'* Only records using Wildlife Acoustics bat detectors.  '}`

## PER DETECTOR

#### Table 1

Summary table showing the number of nights recorded bat activity fell into each activity band for each species.
```{r}
library(plyr)
actdata <- plyr::ddply(df, c("location_name", "species"), summarise,
                 Nights.high = sum(activity_level=="high"),
                 Nights.modhigh = sum(activity_level=="medium/high"),
                 Nights.mod = sum(activity_level=="medium"),
                 Nights.lowmod = sum(activity_level=="low/medium"),
                 Nights.low = sum(activity_level=="low"))

#rename columns
names(actdata)[names(actdata)=="location_name"] <- "Detector ID"
names(actdata)[names(actdata)=="species"] <- "Species/Species Group"
names(actdata)[names(actdata)=="Nights.high"] <- "Nights of High Activity"
names(actdata)[names(actdata)=="Nights.modhigh"] <- "Nights of Moderate/ High Activity"
names(actdata)[names(actdata)=="Nights.mod"] <- "Nights of Moderate Activity"
names(actdata)[names(actdata)=="Nights.lowmod"] <- "Nights of Low/ Moderate Activity"
names(actdata)[names(actdata)=="Nights.low"] <- "Nights of Low Activity"                  

library(knitr)
results='asis'#important to run this as it ensures the raw table output isn't processed further by knitr
datatable2<-actdata
emphasize.italics.cols(2) #second column needs to be in italics i.e. species names
panderOptions("table.split.table", Inf) #don't split table
pander(datatable2, style = 'rmarkdown', keep.line.breaks=TRUE)
```


#### Table 2

Summary table showing key metrics for each species recorded.
```{r}

if (mean(wp$surv) >= 2) {

con<-subset(wp, surv>=2) #subset dataset to only include records with more than one night of surveying
confint<-groupwiseMedian(percentile ~ location_name + Spp, #code to get confidence intervals
                          data       = con, 
                          conf       = 0.95, 
                          R          = 1000,
                          wilcox =   TRUE, 
                          bca        = FALSE, 
                          digits     = 3)

confint <- transform(confint, Wilcox.lower = ifelse(Wilcox.lower == "NaN", Median, Wilcox.lower))
confint <- transform(confint, Wilcox.upper = ifelse(Wilcox.upper == "NaN", Median, Wilcox.upper))


mm<-merge(con, confint) #merge with subsetted dataset to put columns with the confidence intervals on the end
mm$confint = paste(mm$Wilcox.lower, mm$Wilcox.upper, sep=" - ") #add a new column with CIs merged

non<-subset(wp,surv=="1") #subset dataset to only include records with one night of surveying
if(nrow(non)>0) {
  non$n <- 0 #add empty columns to enable merger
non$Median <- 0
non$Wilcox.upper <- 0
non$Wilcox.lower <- 0
non$confint <- 0}

please<-rbind(mm, non) #join the two datasets back together

library(plyr) #ddply as normal
mdata2 <- plyr::ddply(please, c("location_name", "species"), summarise,
               Median.percentile = ceiling(median(percentile)),#finds median percentile
               conf = max(confint),
               Highest.perc = max(percentile), #returns max percentiles
               Number.nights = length(date), #returns how many nights of data in the dataset
               Reference.range.size = mean(reference_range_size)) #returns reference range size - i used mean as it should be the 
#same in each row because same species same location
names(mdata2)[names(mdata2)=="location_name"] <- "Detector ID"
names(mdata2)[names(mdata2)=="species"] <- "Species/Species Group"
names(mdata2)[names(mdata2)=="Median.percentile"] <- "Median Percentile"
names(mdata2)[names(mdata2)=="conf"] <- "95% CIs"
names(mdata2)[names(mdata2)=="Highest.perc"] <- "Max Percentile"
names(mdata2)[names(mdata2)=="Number.nights"] <- "Nights Recorded"
names(mdata2)[names(mdata2)=="Reference.range.size"] <- "Reference Range"

library(knitr)
library(pander)
results='asis' #important to run this as it ensures the raw table output isn't processed further by knitr
medtable2<-mdata2
emphasize.italics.cols(2)
panderOptions("table.split.table", Inf)
panderOptions("table.split.cells", Inf)
pander(medtable2, style = 'multiline', keep.line.breaks=TRUE,justify = c('right', 'left', 'centre', 'centre', 'centre', 'centre', 'centre'))

}



if (mean(wp$surv) == 1) {
  
non<-subset(wp,surv=="1") #subset dataset to only include records with one night of surveying
if(nrow(non)>0) {
non$n <- 0 #add empty columns to enable merger
non$Median <- 0
non$Wilcox.upper <- 0
non$Wilcox.lower <- 0
non$confint <- 0}

library(plyr) #ddply as normal
mdata2 <- plyr::ddply(non, c("location_name", "species"), summarise,
               Median.percentile = ceiling(median(percentile)),#finds median percentile
               conf = max(confint),
               Highest.perc = max(percentile), #returns max percentiles
               Number.nights = length(date), #returns how many nights of data in the dataset
               Reference.range.size = mean(reference_range_size)) #returns reference range size - i used mean as it should be the 
#same in each row because same species same location
names(mdata2)[names(mdata2)=="location_name"] <- "Detector ID"
names(mdata2)[names(mdata2)=="species"] <- "Species/Species Group"
names(mdata2)[names(mdata2)=="Median.percentile"] <- "Median Percentile"
names(mdata2)[names(mdata2)=="conf"] <- "95% CIs"
names(mdata2)[names(mdata2)=="Highest.perc"] <- "Max Percentile"
names(mdata2)[names(mdata2)=="Number.nights"] <- "Nights Recorded"
names(mdata2)[names(mdata2)=="Reference.range.size"] <- "Reference Range"

library(knitr)
library(pander)
results='asis' #important to run this as it ensures the raw table output isn't processed further by knitr
medtable2<-mdata2
emphasize.italics.cols(2)
panderOptions("table.split.table", Inf)
panderOptions("table.split.cells", Inf)
pander(medtable2, style = 'multiline', keep.line.breaks=TRUE,justify = c('right', 'left', 'centre', 'centre', 'centre', 'centre', 'centre'))

}

```



###Figures

```{r fig.width=9, fig.height=6}

#boxplot if 1 location

if(loc=="1") {graphbox<-ggplot(df, aes(x=Spp, y=percentile))+ #add lines first
  geom_hline(aes(yintercept=0), linetype="dashed", color="#000000") +
  geom_hline(aes(yintercept=20), linetype="dashed", color="#0072B2") +
  geom_hline(aes(yintercept=40), linetype="dashed", color="#56B4E9") +
  geom_hline(aes(yintercept=60), linetype="dashed", color="#009E73") +
  geom_hline(aes(yintercept=80), linetype="dashed", color="#E69F00") +
  geom_boxplot(df, mapping = aes(fill=species))+
  xlab("Species")+
  ylab("Bat Activity Level (Percentile)")+
  scale_fill_grey(start = 0.35, end = 1)+
  scale_x_discrete(drop=FALSE) +
  scale_y_continuous(breaks=seq(0,100,20)) +
  expand_limits(y=c(0,100))+
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_rect(linetype="blank"),
        axis.line=element_line(size=0.5, colour="black", linetype="solid"),
        axis.title.x=element_text(size=18),
        axis.text.x  = element_text(angle=90, face="italic", size=14, hjust=1, vjust=0),
        axis.text.y  = element_text(size=12),
        axis.line.x = element_line(color="black", size = 0.5),
        axis.line.y = element_line(color="black", size = 0.5),
        axis.title.y=element_text(size=16),
        legend.position="none")
graphbox}

#endcode for boxplot
```

`r if(loc=="1") {'**Figure 1.**\n The recorded activity of bats during the survey. The centre line indicates the median activity level whereas the box represents the interquartile range (the spread of the middle 50% of nights of activity)  '}`

```{r fig.width=9, fig.height=6}

#boxplot if 2-5 location but only one species

if(loc>2 & loc<5 & spn=="1") {graphboxb<-ggplot(df, aes(x=location_name, y=percentile))+ #add lines first
  geom_hline(aes(yintercept=0), linetype="dashed", color="#000000") +
  geom_hline(aes(yintercept=20), linetype="dashed", color="#0072B2") +
  geom_hline(aes(yintercept=40), linetype="dashed", color="#56B4E9") +
  geom_hline(aes(yintercept=60), linetype="dashed", color="#009E73") +
  geom_hline(aes(yintercept=80), linetype="dashed", color="#E69F00") +
  geom_boxplot(df, mapping = aes(fill=location_name))+
  xlab("Detector ID")+
  ylab("Bat Activity Level (Percentile)")+
  scale_fill_grey(start = 0.35, end = 1)+
  scale_x_discrete(drop=FALSE) +
  scale_y_continuous(breaks=seq(0,100,20), limits=c(0,100)) +
  expand_limits(y=c(0,100))+
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_rect(linetype="blank"),
        axis.line=element_line(size=0.5, colour="black", linetype="solid"),
        axis.title.x=element_text(size=18),
        axis.text.x  = element_text(size=16),
        axis.text.y  = element_text(size=12),
        axis.line.x = element_line(color="black", size = 0.5),
        axis.line.y = element_line(color="black", size = 0.5),
        axis.title.y=element_text(size=18),
        legend.position="none")
graphboxb}

#endcode for boxplot
```

`r if(loc>2 & loc<5 & spn=="1") {'**Figure 1.**\n Differences in activity of bats between static detector locations. The centre line indicates the median activity level whereas the box represents the interquartile range (the spread of the middle 50% of nights of activity)  '}`

```{r fig.width=9, fig.height=6}

#boxplot if 2-5 location and more one species

if(loc>2 & loc<5 & spn>1) {graphboxb<-ggplot(df, aes(x=location_name, y=percentile))+ #add lines first
  geom_hline(aes(yintercept=0), linetype="dashed", color="#000000") +
  geom_hline(aes(yintercept=20), linetype="dashed", color="#0072B2") +
  geom_hline(aes(yintercept=40), linetype="dashed", color="#56B4E9") +
  geom_hline(aes(yintercept=60), linetype="dashed", color="#009E73") +
  geom_hline(aes(yintercept=80), linetype="dashed", color="#E69F00") +
  geom_boxplot(df, mapping = aes(fill=location_name))+
  xlab("Detector ID")+
  ylab("Bat Activity Level (Percentile)")+
  scale_fill_grey(start = 0.35, end = 1)+
  scale_x_discrete(drop=FALSE) +
  scale_y_continuous(breaks=seq(0,100,20), limits=c(0,100)) +
  expand_limits(y=c(0,100))+
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_rect(linetype="blank"),
        axis.line=element_line(size=0.5, colour="black", linetype="solid"),
        axis.title.x=element_text(size=18),
        axis.text.x  = element_text(size=16, angle=90, hjust=1, vjust=0),
        axis.text.y  = element_text(size=12),
        axis.line.x = element_line(color="black", size = 0.5),
        axis.line.y = element_line(color="black", size = 0.5),
        axis.title.y=element_text(size=18),
        legend.position="none")+
  facet_wrap( ~ species, ncol=3) +
    theme(strip.text.x = element_text(size=16, face="italic"))
graphboxb}

#endcode for boxplot
```

`r if(loc>2 & loc<5 & spn>1) {'**Figure 1.**\n Differences in bat activity between static detector locations. The centre line indicates the median activity level whereas the box represents the interquartile range (the spread of the middle 50% of nights of activity)  '}`

```{r fig.width=9, fig.height=8}

#boxplot if more than 5 location and one species

if(loc>=5 & spn=="1") {graphboxc<-ggplot(df, aes(x=location_name, y=percentile))+ #add lines first
  geom_hline(aes(yintercept=0), linetype="dashed", color="#000000") +
  geom_hline(aes(yintercept=20), linetype="dashed", color="#0072B2") +
  geom_hline(aes(yintercept=40), linetype="dashed", color="#56B4E9") +
  geom_hline(aes(yintercept=60), linetype="dashed", color="#009E73") +
  geom_hline(aes(yintercept=80), linetype="dashed", color="#E69F00") +
  geom_boxplot(df, mapping = aes(fill=location_name))+
  xlab("Detector ID")+
  ylab("Bat Activity Level (Percentile)")+
  scale_fill_grey(start = 0.35, end = 1)+
  scale_x_discrete(drop=FALSE) +
  scale_y_continuous(breaks=seq(0,100,20), limits=c(0,100)) +
  expand_limits(y=c(0,100))+
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_rect(colour="black", linetype="solid"),
        axis.line=element_line(size=0.5, colour="black", linetype="solid"),
        axis.title.x=element_text(size=18),
        axis.text.x  = element_text(size=16, angle=90, vjust=0, hjust=1),
        axis.text.y  = element_text(size=12),
        axis.line.x = element_line(color="black", size = 0.5),
        axis.line.y = element_line(color="black", size = 0.5),
        axis.title.y=element_text(size=18),
        legend.position="none")+
  facet_wrap( ~ species, ncol=3) +
    theme(strip.text.x = element_text(size=16, face="italic"))
graphboxc}

#endcode for boxplot
```

`r if(loc>=5 & spn=="1") {'**Figure 1.**\n Differences in activity between static detector locations, split by species and location. The centre line indicates the median activity level whereas the box represents the interquartile range (the spread of the middle 50% of nights of activity)  '}`

```{r fig.width=9, fig.height=8}

#boxplot if more than or equal to 5 but less than 10 location and more than one species

if(loc>=5 & loc<10 & spn>"1") {graphboxc<-ggplot(df, aes(x=location_name, y=percentile))+ #add lines first
  geom_hline(aes(yintercept=0), linetype="dashed", color="#000000") +
  geom_hline(aes(yintercept=20), linetype="dashed", color="#0072B2") +
  geom_hline(aes(yintercept=40), linetype="dashed", color="#56B4E9") +
  geom_hline(aes(yintercept=60), linetype="dashed", color="#009E73") +
  geom_hline(aes(yintercept=80), linetype="dashed", color="#E69F00") +
  geom_boxplot(df, mapping = aes(fill=location_name))+
  xlab("Detector ID")+
  ylab("Bat Activity Level (Percentile)")+
  scale_fill_grey(start = 0.35, end = 1)+
  scale_x_discrete(drop=FALSE) +
  scale_y_continuous(breaks=seq(0,100,20), limits=c(0,100)) +
  expand_limits(y=c(0,100))+
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_rect(colour="black", linetype="solid"),
        axis.line=element_line(size=0.5, colour="black", linetype="solid"),
        axis.title.x=element_text(size=18),
        axis.text.x  = element_text(size=16, angle=90, hjust=1, vjust=0),
        axis.text.y  = element_text(size=12),
        axis.line.x = element_line(color="black", size = 0.5),
        axis.line.y = element_line(color="black", size = 0.5),
        axis.title.y=element_text(size=18),
        legend.position="none")+
  facet_wrap( ~ species, ncol=3) +
    theme(strip.text.x = element_text(size=16, face="italic"))
graphboxc}

#endcode for boxplot
```

`r if(loc>=5 & loc<10 & spn>1) {'**Figure 1.**\n Differences in activity between static detector locations, split by species and location. The centre line indicates the median activity level whereas the box represents the interquartile range (the spread of the middle 50% of nights of activity)  '}`


```{r fig.width=9, fig.height=8}

#boxplot if more than 10 locations and more than one species

if(loc>10 & spn>"1") {graphboxc<-ggplot(df, aes(x=location_name, y=percentile))+ #add lines first
  geom_hline(aes(yintercept=0), linetype="dashed", color="#000000") +
  geom_hline(aes(yintercept=20), linetype="dashed", color="#0072B2") +
  geom_hline(aes(yintercept=40), linetype="dashed", color="#56B4E9") +
  geom_hline(aes(yintercept=60), linetype="dashed", color="#009E73") +
  geom_hline(aes(yintercept=80), linetype="dashed", color="#E69F00") +
  geom_boxplot(df, mapping = aes(fill=location_name))+
  xlab("\nDetector ID")+
  ylab("Bat Activity Level (Percentile)\n")+
  scale_fill_grey(start = 0.35, end = 1)+
  scale_x_discrete(drop=FALSE) +
  scale_y_continuous(breaks=seq(0,100,20), limits=c(0,100)) +
  expand_limits(y=c(0,100))+
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_rect(colour="black", linetype="solid"),
        axis.line=element_line(size=0.5, colour="black", linetype="solid"),
        axis.title.x=element_text(size=18),
        axis.text.x  = element_text(size=10, angle=90, hjust=1, vjust=0),
        axis.text.y  = element_text(size=12),
        axis.line.x = element_line(color="black", size = 0.5),
        axis.line.y = element_line(color="black", size = 0.5),
        axis.title.y=element_text(size=18),
        legend.position="none")+
  facet_wrap( ~ species, ncol=3) +
    theme(strip.text.x = element_text(size=16, face="italic"))
graphboxc}

#endcode for boxplot
```


`r if(loc>10 & spn>1) {'**Figure 1.**\n Differences in activity between static detector locations, split by species and location. The centre line indicates the median activity level whereas the box represents the interquartile range (the spread of the middle 50% of nights of activity)  '}`


```{r fig.width=9, fig.height=8}
## Night ~ percentile graph if 1 location, 1 species
#if less than 21 days

if((difftime(max(df$Night),min(df$Night), units='days')<=21) & loc=="1" & spn=="1"){ graphD<-ggplot(df, aes(x= Night, y= percentile)) +
  geom_point(df, size=3, shape=1,
             mapping = aes(x=Night, y= percentile, color=activity_level))+
  xlab("Night")+ #set x-axis
  ylab("Bat Activity Level (Percentile)")+
  scale_colour_manual(values=cbbPalette, name="Activity\nLevel",
                      breaks=c("High","Moderate/High","Moderate",
                               "Low/Moderate","Low"))+
  scale_y_continuous(breaks=seq(0,100,20), limits=c(0,100)) + 
  scale_x_date(name = "Date", date_breaks = "3 days", date_labels = "%d %b %Y")+
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_rect(linetype="blank"),
        axis.line=element_line(size=0.5, colour="black", linetype="solid"),
        axis.title.x=element_text(size=18),
        axis.text.x  = element_text(angle=90,size=16, hjust=1, vjust=0),
        axis.text.y  = element_text(size=12),
        axis.line.x = element_line(color="black", size = 0.5),
        axis.line.y = element_line(color="black", size = 0.5),
        axis.title.y=element_text(size=18)) +
  geom_hline(aes(yintercept=20), linetype="dashed", color="#0072B2") +
  geom_hline(aes(yintercept=40), linetype="dashed", color="#56B4E9") +
  geom_hline(aes(yintercept=60), linetype="dashed", color="#009E73") +
  geom_hline(aes(yintercept=80), linetype="dashed", color="#E69F00")
  graphD}

##end code for Night graph
```

`r if((difftime(max(df$Night),min(df$Night), units='days')<=21) & loc=="1" & spn=="1") {'**Figure 2.**\n The activity level (percentile) of bats recorded across each night of the bat survey.  '}`

```{r fig.width=9, fig.height=8}
## Night ~ percentile graph if 1 location, >1 species
#if less than 21 days

if((difftime(max(df$Night),min(df$Night), units='days')<=21) & loc=="1" & spn>1) {
  
  for (i in seq_len(n_pages1)) {
  
  print(ggplot(df, aes(x= Night, y= percentile))+
  geom_point(df, size=3, shape=1, 
             mapping = aes(x=Night, y= percentile, color=activity_level))+
  xlab("Night")+ #set x-axis
  ylab("Bat Activity Level (Percentile)")+
  scale_colour_manual(values=cbbPalette, name="Activity\nLevel",
                      breaks=c("High","Moderate/High","Moderate",
                               "Low/Moderate","Low"))+
  scale_y_continuous(breaks=seq(0,100,20), limits=c(0,100)) +
  scale_x_date(name = "Date", date_breaks = "3 days", date_labels = "%d %b %Y")+
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_rect(colour="black", linetype="solid"),
        axis.line=element_line(size=0.5, colour="black", linetype="solid"),
        axis.title.x=element_text(size=18),
        axis.text.x  = element_text(angle=90,size=16, hjust=1, vjust=0),
        axis.text.y  = element_text(size=12),
        axis.line.x = element_line(color="black", size = 0.5),
        axis.line.y = element_line(color="black", size = 0.5),
        axis.title.y=element_text(size=18)) +
  geom_hline(aes(yintercept=20), linetype="dashed", color="#0072B2") +
  geom_hline(aes(yintercept=40), linetype="dashed", color="#56B4E9") +
  geom_hline(aes(yintercept=60), linetype="dashed", color="#009E73") +
  geom_hline(aes(yintercept=80), linetype="dashed", color="#E69F00") +
  facet_grid_paginate(species ~ ., ncol=1, nrow=5, scales="fixed", page=i) +
  theme(strip.text.y = element_text(size=16, face="italic")))
  }
}  

##end code for Night graph
```

`r if((difftime(max(df$Night),min(df$Night), units='days')<=21) & loc=="1" & spn>1) {'**Figure 2.**\n The activity level (percentile) of bats recorded across each night of the bat survey, split by species.  '}`

```{r fig.width=9, fig.height=8}
## Night ~ percentile graph if 2-5 locations + >1 species
#less than 21 days 

if((difftime(max(df$Night),min(df$Night), units='days')<=21) & loc>1 & loc<5 & spn>1) {
  
  for (i in seq_len(n_pages)) {
  
  print(ggplot(df, aes(x= Night, y= percentile))+
  geom_point(df, size=3, shape=1,
             mapping = aes(x=df$Night, y= percentile, color=activity_level))+
  xlab("Night")+ #set x-axis
  ylab("Bat Activity Level (Percentile)")+
  scale_colour_manual(values=cbbPalette, name="Activity\nLevel",
                      breaks=c("High","Moderate/High","Moderate",
                               "Low/Moderate","Low"))+
  scale_y_continuous(breaks=seq(0,100,20), limits=c(0,100)) + 
  scale_x_date(name = "Date", date_breaks = "1 week", date_labels = "%d %b %Y")+
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_rect(colour="black", linetype="solid"),
        axis.line=element_line(size=0.5, colour="black", linetype="solid"),
        axis.title.x=element_text(size=18),
        axis.text.x  = element_text(angle=90,size=16, hjust=1, vjust=0),
        axis.text.y  = element_text(size=12),
        axis.line.x = element_line(color="black", size = 0.5),
        axis.line.y = element_line(color="black", size = 0.5),
        axis.title.y=element_text(size=18)) +
  geom_hline(aes(yintercept=20), linetype="dashed", color="#0072B2") +
  geom_hline(aes(yintercept=40), linetype="dashed", color="#56B4E9") +
  geom_hline(aes(yintercept=60), linetype="dashed", color="#009E73") +
  geom_hline(aes(yintercept=80), linetype="dashed", color="#E69F00") +
  facet_wrap_paginate(species ~ location_name, ncol=2, nrow=4, scales="fixed", page=i) +
  theme(strip.text.y = element_text(size=16, face="italic"),
        strip.text.x = element_text(size=16)))
  }
}

#end code for Night graph
```
`r if((difftime(max(df$Night),min(df$Night), units='days')<=21) & loc>1 & loc<5 & spn>1) {'**Figure 2.**\n The activity level (percentile) of bats recorded across each night of the bat survey, split by location and species.  '}`

```{r fig.width=9, fig.height=10}
# Night ~ percentile graph if 1 species and 2-5 locations
#less than 21 days 

if((difftime(max(df$Night),min(df$Night), units='days')<=21) & loc>1 & loc<5 & spn=="1") {graphE<-ggplot(df, aes(x= Night, y= percentile))+
  geom_point(df, size=3, shape=1, 
             mapping = aes(x=Night, y= percentile, color=activity_level))+
  xlab("Night")+ #set x-axis
  ylab("Bat Activity Level (Percentile)")+
  scale_colour_manual(values=cbbPalette, name="Activity\nLevel",
                      breaks=c("High","Moderate/High","Moderate",
                               "Low/Moderate","Low"))+
  scale_y_continuous(breaks=seq(0,100,20), limits=c(0,100)) + 
  scale_x_date(name = "Date", date_breaks = "1 week", date_labels = "%d %b %Y")+
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_rect(colour="black", linetype="solid"),
        axis.line=element_line(size=0.5, colour="black", linetype="solid"),
        axis.title.x=element_text(size=18),
        axis.text.x  = element_text(angle=90,size=16, hjust=1, vjust=0),
        axis.text.y  = element_text(size=12),
        axis.line.x = element_line(color="black", size = 0.5),
        axis.line.y = element_line(color="black", size = 0.5),
        axis.title.y=element_text(size=18))+
  geom_hline(aes(yintercept=20), linetype="dashed", color="#0072B2") +
  geom_hline(aes(yintercept=40), linetype="dashed", color="#56B4E9") +
  geom_hline(aes(yintercept=60), linetype="dashed", color="#009E73") +
  geom_hline(aes(yintercept=80), linetype="dashed", color="#E69F00") +
  facet_grid(. ~ location_name) +
  theme(strip.text.x = element_text(size=16))
graphE}

#end code for Night graph
```
`r if((difftime(max(df$Night),min(df$Night), units='days')<=21) & loc>1 & loc<5 & spn=="1") {'**Figure 2.**\n The activity level (percentile) of bats recorded across each night of the bat survey, split by location.  '}`

```{r fig.width=9, fig.height=10}
## Night ~ percentile graph if >5 location + >1 species
#less than 21 days

if((difftime(max(df$Night),min(df$Night), units='days')<=21) & loc>=5 & spn>1) {
  
  for (i in seq_len(n_pages)) { 
    
  print(ggplot(df, aes(x= df$Night, y= percentile))+
  geom_point(df, size=3, shape=1,
             mapping = aes(x=df$Night, y= percentile, color=activity_level))+
  xlab("Night")+ #set x-axis
  ylab("Bat Activity Level (Percentile)")+
  scale_colour_manual(values=cbbPalette, name="Activity\nLevel",
                      breaks=c("High","Moderate/High","Moderate",
                               "Low/Moderate","Low"))+
  scale_y_continuous(breaks=seq(0,100,20), limits=c(0,100)) + 
  scale_x_date(name = "Date", date_breaks = "1 week", date_labels = "%d %b %Y")+
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_rect(colour="black", linetype="solid"),
        axis.line=element_line(size=0.5, colour="black", linetype="solid"),
        axis.title.x=element_text(size=18),
        axis.text.x  = element_text(angle=90,size=16, hjust=1, vjust=0),
        axis.text.y  = element_text(size=12),
        axis.line.x = element_line(color="black", size = 0.5),
        axis.line.y = element_line(color="black", size = 0.5),
        axis.title.y=element_text(size=18)) +
  geom_hline(aes(yintercept=20), linetype="dashed", color="#0072B2") +
  geom_hline(aes(yintercept=40), linetype="dashed", color="#56B4E9") +
  geom_hline(aes(yintercept=60), linetype="dashed", color="#009E73") +
  geom_hline(aes(yintercept=80), linetype="dashed", color="#E69F00") +
  facet_wrap_paginate(species ~ location_name, ncol=2, nrow=4, page=i) +
  theme(strip.text.y = element_text(size=16, face="italic"),
        strip.text.x = element_text(size=16)))
  }
}
#end code for Night graph
```

`r if((difftime(max(df$Night),min(df$Night), units='days')<=21) & loc>=5 & spn>1) {'**Figure 2.**\n The activity level (percentile) of bats recorded across each night of the bat survey, split by location and species.  '}`


```{r fig.width=9, fig.height=12}
# Night ~ percentile graph if 1 species and >5 location
#less than 21 days

if((difftime(max(df$Night),min(df$Night), units='days')<=21) & loc>=5 & spn=="1") { 
  
  for (i in seq_len(n_pages)) { 
    print(ggplot(df, aes(x= Night, y= percentile))+
  geom_point(df, size=3, shape=1, 
             mapping = aes(x=Night, y= percentile, color=activity_level))+
  xlab("Night")+ #set x-axis
  ylab("Bat Activity Level (Percentile)")+
  scale_colour_manual(values=cbbPalette, name="Activity\nLevel",
                      breaks=c("High","Moderate/High","Moderate",
                               "Low/Moderate","Low"))+
  scale_y_continuous(breaks=seq(0,100,20), limits=c(0,100)) + 
  scale_x_date(name = "Date", date_breaks = "1 week", date_labels = "%d %b %Y")+
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_rect(colour="black", linetype="solid"),
        axis.line=element_line(size=0.5, colour="black", linetype="solid"),
        axis.title.x=element_text(size=18),
        axis.text.x  = element_text(angle=90,size=16, hjust=1, vjust=0),
        axis.text.y  = element_text(size=12),
        axis.line.x = element_line(color="black", size = 0.5),
        axis.line.y = element_line(color="black", size = 0.5),
        axis.title.y=element_text(size=18))+
  geom_hline(aes(yintercept=20), linetype="dashed", color="#0072B2") +
  geom_hline(aes(yintercept=40), linetype="dashed", color="#56B4E9") +
  geom_hline(aes(yintercept=60), linetype="dashed", color="#009E73") +
  geom_hline(aes(yintercept=80), linetype="dashed", color="#E69F00") +
  facet_wrap_paginate(species ~ location_name, ncol=2, nrow=4,    scales="fixed", page=i) +
  theme(strip.text.x = element_text(size=16)))
  }
}
#end code for Night graph
```

`r if((difftime(max(df$Night),min(df$Night), units='days')<=21) & loc>=5 & spn=="1") {'**Figure 2.**\n The activity level (percentile) of bats recorded across each night of the bat survey, split by location.  '}`

```{r fig.width=9, fig.height=8}
## Night ~ percentile graph if 1 location, 1 species
#if time difference is between 21 and 50 days 

if((difftime(max(df$Night),min(df$Night), units='days')>21) & (difftime(max(df$Night),min(df$Night), units='days')<50) & loc=="1" & spn=="1"){ graphG<-ggplot(df, aes(x= Night, y= percentile)) +
  geom_point(df, size=3, 
             mapping = aes(x=Night, y= percentile, color=activity_level, shape=1))+
  xlab("Night")+ #set x-axis
  ylab("Bat Activity Level (Percentile)")+
  scale_colour_manual(values=cbbPalette, name="Activity\nLevel",
                      breaks=c("High","Moderate/High","Moderate",
                               "Low/Moderate","Low"))+
  scale_y_continuous(breaks=seq(0,100,20), limits=c(0,100)) + 
  scale_x_date(name = "Date", date_breaks = "1 week", date_labels = "%d %b %Y")+
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_rect(linetype="blank"),
        axis.line=element_line(size=0.5, colour="black", linetype="solid"),
        axis.title.x=element_text(size=18),
        axis.text.x  = element_text(angle=90,size=16, hjust=1, vjust=0),
        axis.text.y  = element_text(size=12),
        axis.line.x = element_line(color="black", size = 0.5),
        axis.line.y = element_line(color="black", size = 0.5),
        axis.title.y=element_text(size=18)) +
  geom_hline(aes(yintercept=20), linetype="dashed", color="#0072B2") +
  geom_hline(aes(yintercept=40), linetype="dashed", color="#56B4E9") +
  geom_hline(aes(yintercept=60), linetype="dashed", color="#009E73") +
  geom_hline(aes(yintercept=80), linetype="dashed", color="#E69F00") +
  graphG}

##end code for Night graph
```

`r if((difftime(max(df$Night),min(df$Night), units='days')>21) & (difftime(max(df$Night),min(df$Night), units='days')<50) & loc=="1" & spn=="1") {'**Figure 2.**\n The activity level (percentile) of bats recorded across each night of the bat survey.  '}`

```{r fig.width=9, fig.height=8}
## Night ~ percentile graph if 1 location, >1 species
#if time difference is between 21 and 50 days 

if((difftime(max(df$Night),min(df$Night), units='days')>21) & (difftime(max(df$Night),min(df$Night), units='days')<50) & loc=="1" & spn>1) { 
  
  for (i in seq_len(n_pages1)) {
  
  print(ggplot(df, aes(x= Night, y= percentile))+
  geom_point(df, size=3, shape=1,
             mapping = aes(x=Night, y= percentile, color=activity_level))+
  xlab("Night")+ #set x-axis
  ylab("Bat Activity Level (Percentile)")+
  scale_colour_manual(values=cbbPalette, name="Activity\nLevel",
                      breaks=c("High","Moderate/High","Moderate",
                               "Low/Moderate","Low"))+
  scale_y_continuous(breaks=seq(0,100,20), limits=c(0,100)) +
  scale_x_date(name = "Date", date_breaks = "1 week", date_labels = "%d %b %y")+
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_rect(colour="black", linetype="solid"),
        axis.line=element_line(size=0.5, colour="black", linetype="solid"),
        axis.title.x=element_text(size=18),
        axis.text.x  = element_text(angle=90,size=16, hjust=1, vjust=0),
        axis.text.y  = element_text(size=12),
        axis.line.x = element_line(color="black", size = 0.5),
        axis.line.y = element_line(color="black", size = 0.5),
        axis.title.y=element_text(size=18)) +
  geom_hline(aes(yintercept=20), linetype="dashed", color="#0072B2") +
  geom_hline(aes(yintercept=40), linetype="dashed", color="#56B4E9") +
  geom_hline(aes(yintercept=60), linetype="dashed", color="#009E73") +
  geom_hline(aes(yintercept=80), linetype="dashed", color="#E69F00") +
  facet_grid_paginate(species ~ ., ncol=1, nrow=5, scales="fixed", page=i) +
  theme(strip.text.y = element_text(size=16, face="italic")))
  }
}
##end code for Night graph
```

`r if((difftime(max(df$Night),min(df$Night), units='days')>21) & (difftime(max(df$Night),min(df$Night), units='days')<50) & loc=="1" & spn>1) {'**Figure 2.**\n The activity level (percentile) of bats recorded across each night of the bat survey, split by species.  '}`

```{r fig.width=10, fig.height=10}
## Night ~ percentile graph if 2-5 locations + >1 species
#if time difference is between 21 and 50 days 

if((difftime(max(df$Night),min(df$Night), units='days')>21) & (difftime(max(df$Night),min(df$Night), units='days')<50) & loc>1 & loc<5 & spn>1){
  
  for (i in seq_len(n_pages)) {
  
  print(ggplot(df, aes(x= Night, y= percentile))+
  geom_point(df, size=3, shape=1,
             mapping = aes(x=df$Night, y= percentile, color=activity_level))+
  xlab("Night")+ #set x-axis
  ylab("Bat Activity Level (Percentile)")+
  scale_colour_manual(values=cbbPalette, name="Activity\nLevel",
                      breaks=c("High","Moderate/High","Moderate",
                               "Low/Moderate","Low"))+
  scale_y_continuous(breaks=seq(0,100,20), limits=c(0,100)) + 
  scale_x_date(name = "Date", date_breaks = "1 week", date_labels = "%d %b %Y")+
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_rect(colour="black", linetype="solid"),
        axis.line=element_line(size=0.5, colour="black", linetype="solid"),
        axis.title.x=element_text(size=18),
        axis.text.x  = element_text(angle=90,size=16, hjust=1, vjust=0),
        axis.text.y  = element_text(size=12),
        axis.line.x = element_line(color="black", size = 0.5),
        axis.line.y = element_line(color="black", size = 0.5),
        axis.title.y=element_text(size=18)) +
  geom_hline(aes(yintercept=20), linetype="dashed", color="#0072B2") +
  geom_hline(aes(yintercept=40), linetype="dashed", color="#56B4E9") +
  geom_hline(aes(yintercept=60), linetype="dashed", color="#009E73") +
  geom_hline(aes(yintercept=80), linetype="dashed", color="#E69F00") +
  facet_wrap_paginate(species ~ location_name, ncol=2, nrow=4, scales="fixed", page=i) +
  theme(strip.text.y = element_text(size=10, face="italic"),
        strip.text.x = element_text(size=16)))
  }
}

#end code for Night graph
```

`r if((difftime(max(df$Night),min(df$Night), units='days')>21) & (difftime(max(df$Night),min(df$Night), units='days')<50) & loc>1 & loc<5 & spn>1) {'**Figure 2.**\n The activity level (percentile) of bats recorded across each night of the bat survey, split by location and species.  '}`


```{r fig.width=9, fig.height=10}
# Night ~ percentile graph if 1 species and 2-5 locations
#if time difference is between 21 and 50 days 

if((difftime(max(df$Night),min(df$Night), units='days')>21) & (difftime(max(df$Night),min(df$Night), units='days')<50) & loc>1 & loc<5 & spn=="1"){ graphh<-ggplot(df, aes(x= Night, y= percentile))+
  geom_point(df, size=3, shape=1, 
             mapping = aes(x=Night, y= percentile, color=activity_level))+
  xlab("Night")+ #set x-axis
  ylab("Bat Activity Level (Percentile)")+
  scale_colour_manual(values=cbbPalette, name="Activity\nLevel",
                      breaks=c("High","Moderate/High","Moderate",
                               "Low/Moderate","Low"))+
  scale_y_continuous(breaks=seq(0,100,20), limits=c(0,100)) + 
  scale_x_date(name = "Date", date_breaks = "1 week", date_labels = "%d %b %Y")+
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_rect(colour="black", linetype="solid"),
        axis.line=element_line(size=0.5, colour="black", linetype="solid"),
        axis.title.x=element_text(size=18),
        axis.text.x  = element_text(angle=90,size=16, hjust=1, vjust=0),
        axis.text.y  = element_text(size=12),
        axis.line.x = element_line(color="black", size = 0.5),
        axis.line.y = element_line(color="black", size = 0.5),
        axis.title.y=element_text(size=18))+
  geom_hline(aes(yintercept=20), linetype="dashed", color="#0072B2") +
  geom_hline(aes(yintercept=40), linetype="dashed", color="#56B4E9") +
  geom_hline(aes(yintercept=60), linetype="dashed", color="#009E73") +
  geom_hline(aes(yintercept=80), linetype="dashed", color="#E69F00") +
  facet_grid(. ~ location_name) +
  theme(strip.text.x = element_text(size=16))
graphh}

#end code for Night graph
```

`r if((difftime(max(df$Night),min(df$Night), units='days')>21) & (difftime(max(df$Night),min(df$Night), units='days')<50) & loc>1 & loc<5 & spn=="1") {'**Figure 2.**\n The activity level (percentile) of bats recorded across each night of the bat survey, split by location.  '}`

```{r fig.width=9, fig.height=10}
## Night ~ percentile graph if >5 location + >1 species
#if time difference is between 21 and 50 days 

if((difftime(max(df$Night),min(df$Night), units='days')>21) & (difftime(max(df$Night),min(df$Night), units='days')<50) & loc>=5 & spn>1) {
  
  for (i in seq_len(n_pages)) { 
    
    print(ggplot(df, aes(x= df$Night, y= percentile))+
  geom_point(df, size=3, shape=1,
             mapping = aes(x=df$Night, y= percentile, color=activity_level))+
  xlab("Night")+ #set x-axis
  ylab("Bat Activity Level (Percentile)")+
  scale_colour_manual(values=cbbPalette, name="Activity\nLevel",
                      breaks=c("High","Moderate/High","Moderate",
                               "Low/Moderate","Low"))+
  scale_y_continuous(breaks=seq(0,100,20), limits=c(0,100)) + 
  scale_x_date(name = "Date", date_breaks = "1 week", date_labels = "%d %b %Y")+
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_rect(colour="black", linetype="solid"),
        axis.line=element_line(size=0.5, colour="black", linetype="solid"),
        axis.title.x=element_text(size=18),
        axis.text.x  = element_text(angle=90,size=16, hjust=1, vjust=0),
        axis.text.y  = element_text(size=12),
        axis.line.x = element_line(color="black", size = 0.5),
        axis.line.y = element_line(color="black", size = 0.5),
        axis.title.y=element_text(size=18)) +
  geom_hline(aes(yintercept=20), linetype="dashed", color="#0072B2") +
  geom_hline(aes(yintercept=40), linetype="dashed", color="#56B4E9") +
  geom_hline(aes(yintercept=60), linetype="dashed", color="#009E73") +
  geom_hline(aes(yintercept=80), linetype="dashed", color="#E69F00") +
  facet_wrap_paginate(species ~ location_name, ncol=2, nrow=4, scales="fixed", page=i) +
  theme(strip.text.y = element_text(size=16, face="italic"),
        strip.text.x = element_text(size=16)))
  }
}
#end code for Night graph
```

`r if((difftime(max(df$Night),min(df$Night), units='days')>21) & (difftime(max(df$Night),min(df$Night), units='days')<50) & loc>=5 & spn>1) {'**Figure 2.**\n The activity level (percentile) of bats recorded across each night of the bat survey, split by location and species.  '}`


```{r fig.width=9, fig.height=12}
# Night ~ percentile graph if 1 species and >5 location
#if time difference is between 21 and 50 days 

if((difftime(max(df$Night),min(df$Night), units='days')>21) & (difftime(max(df$Night),min(df$Night), units='days') <50) & loc>=5 & spn=="1"){
  
  for (i in seq_len(n_pages)) { 
    
    print(ggplot(df, aes(x= Night, y= percentile))+
  geom_point(df, size=3, shape=1, 
             mapping = aes(x=Night, y= percentile, color=activity_level))+
  xlab("Night")+ #set x-axis
  ylab("Bat Activity Level (Percentile)")+
  scale_colour_manual(values=cbbPalette, name="Activity\nLevel",
                      breaks=c("High","Moderate/High","Moderate",
                               "Low/Moderate","Low"))+
  scale_y_continuous(breaks=seq(0,100,20), limits=c(0,100)) + 
  scale_x_date(name = "Date", date_breaks = "1 week", date_labels = "%d %b %Y")+
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_rect(colour="black", linetype="solid"),
        axis.line=element_line(size=0.5, colour="black", linetype="solid"),
        axis.title.x=element_text(size=18),
        axis.text.x  = element_text(angle=90,size=16, hjust=1, vjust=0),
        axis.text.y  = element_text(size=12),
        axis.line.x = element_line(color="black", size = 0.5),
        axis.line.y = element_line(color="black", size = 0.5),
        axis.title.y=element_text(size=18))+
  geom_hline(aes(yintercept=20), linetype="dashed", color="#0072B2") +
  geom_hline(aes(yintercept=40), linetype="dashed", color="#56B4E9") +
  geom_hline(aes(yintercept=60), linetype="dashed", color="#009E73") +
  geom_hline(aes(yintercept=80), linetype="dashed", color="#E69F00") +
  facet_wrap_paginate(species ~ location_name, ncol=2, nrow=4, scales="fixed", page=i) +
  theme(strip.text.x = element_text(size=16)))
  }
}
#end code for Night graph
```

`r if((difftime(max(df$Night),min(df$Night), units='days')>21) & (difftime(max(df$Night),min(df$Night), units='days') <50) & loc>=5 & spn=="1") {'**Figure 2.**\n The activity level (percentile) of bats recorded across each night of the bat survey, split by location.  '}`

```{r fig.width=9, fig.height=8}
## Night ~ percentile graph if 1 location, 1 species
#if time diff between 50 and 300 days

if((difftime(max(df$Night),min(df$Night), units='days')>50) & (difftime(max(df$Night),min(df$Night), units='days')<300) & loc=="1" & spn=="1"){ ggplot(df, aes(x= Night, y= percentile)) +
   geom_point(df, size=3, shape=1, 
             mapping = aes(x=Night, y= percentile, color=activity_level))+
  xlab("Night")+ #set x-axis
  ylab("Bat Activity Level (Percentile)")+
  scale_colour_manual(values=cbbPalette, name="Activity\nLevel",
                      breaks=c("High","Moderate/High","Moderate",
                               "Low/Moderate","Low"))+
  scale_y_continuous(breaks=seq(0,100,20), limits=c(0,100)) + 
  scale_x_date(name = "Date", date_breaks = "3 weeks", date_labels = "%d %b %y")+
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_rect(linetype="blank"),
        axis.line=element_line(size=0.5, colour="black", linetype="solid"),
        axis.title.x=element_text(size=18),
        axis.text.x  = element_text(angle=90,size=16, hjust=1, vjust=0),
        axis.text.y  = element_text(size=12),
        axis.line.x = element_line(color="black", size = 0.5),
        axis.line.y = element_line(color="black", size = 0.5),
        axis.title.y=element_text(size=18)) +
  geom_hline(aes(yintercept=20), linetype="dashed", color="#0072B2") +
  geom_hline(aes(yintercept=40), linetype="dashed", color="#56B4E9") +
  geom_hline(aes(yintercept=60), linetype="dashed", color="#009E73") +
  geom_hline(aes(yintercept=80), linetype="dashed", color="#E69F00")
  }

##end code for Night graph
```

`r if((difftime(max(df$Night),min(df$Night), units='days')>50) & (difftime(max(df$Night),min(df$Night), units='days') <300) & loc=="1" & spn=="1") {'**Figure 2.**\n The activity level (percentile) of bats recorded across each night of the bat survey.  '}`

```{r fig.width=9, fig.height=10}
## Night ~ percentile graph if 1 location, >1 species
#if time diff between 50 and 300 days

if((difftime(max(df$Night),min(df$Night), units='days')>50) & (difftime(max(df$Night),min(df$Night), units='days')<300) & loc=="1" & spn>1) {
  
  for (i in seq_len(n_pages1)) {
  
  print(ggplot(df, aes(x= Night, y= percentile))+
  geom_point(df, size=3, shape = 1,
             mapping = aes(x=Night, y= percentile, color=activity_level))+
  xlab("Night")+ #set x-axis
  ylab("Bat Activity Level (Percentile)")+
  scale_colour_manual(values=cbbPalette, name="Activity\nLevel",
                      breaks=c("High","Moderate/High","Moderate",
                               "Low/Moderate","Low"))+
  scale_y_continuous(breaks=seq(0,100,20), limits=c(0,100)) +
  scale_x_date(name = "Date", date_breaks = "3 weeks", date_labels = "%d %b %y")+
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_rect(colour="black", linetype="solid"),
        axis.line=element_line(size=0.5, colour="black", linetype="solid"),
        axis.title.x=element_text(size=18),
        axis.text.x  = element_text(angle=90,size=16, hjust=1, vjust=0),
        axis.text.y  = element_text(size=12),
        axis.line.x = element_line(color="black", size = 0.5),
        axis.line.y = element_line(color="black", size = 0.5),
        axis.title.y=element_text(size=18)) +
  geom_hline(aes(yintercept=20), linetype="dashed", color="#0072B2") +
  geom_hline(aes(yintercept=40), linetype="dashed", color="#56B4E9") +
  geom_hline(aes(yintercept=60), linetype="dashed", color="#009E73") +
  geom_hline(aes(yintercept=80), linetype="dashed", color="#E69F00") +
  facet_grid_paginate(species ~ ., ncol=1, nrow=5, scales="fixed", page=i) +
  theme(strip.text.y = element_text(size=16, face="italic")))
 }
}

##end code for Night graph
```

`r if((difftime(max(df$Night),min(df$Night), units='days')>50) & (difftime(max(df$Night),min(df$Night), units='days') <300) & loc=="1" & spn>1) {'**Figure 2.**\n The activity level (percentile) of bats recorded across each night of the bat survey, split by species.  '}`

```{r fig.width=9, fig.height=10}
## Night ~ percentile graph if 2-5 locations + >1 species
#if time diff between 50 and 300 days

if((difftime(max(df$Night),min(df$Night), units='days')>50) & (difftime(max(df$Night),min(df$Night), units='days')<300) & loc>1 & loc<5 & spn>1) {
  
  for (i in seq_len(n_pages)) {
  
  print(ggplot(df, aes(x= df$Night, y= percentile))+
  geom_point(df, size=3, shape=1,
             mapping = aes(x=df$Night, y= percentile, color=activity_level))+
  xlab("Night")+ #set x-axis
  ylab("Bat Activity Level (Percentile)")+
   scale_colour_manual(values=cbbPalette, name="Activity\nLevel",
                      breaks=c("High","Moderate/High","Moderate",
                               "Low/Moderate","Low"))+
  scale_y_continuous(breaks=seq(0,100,20), limits=c(0,100)) + 
  scale_x_date(name = "Date", date_breaks = "3 weeks", date_labels = "%d %b %y")+
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_rect(colour="black", linetype="solid"),
        axis.line=element_line(size=0.5, colour="black", linetype="solid"),
        axis.title.x=element_text(size=18),
        axis.text.x  = element_text(angle=90,size=16, hjust=1, vjust=0),
        axis.text.y  = element_text(size=12),
        axis.line.x = element_line(color="black", size = 0.5),
        axis.line.y = element_line(color="black", size = 0.5),
        axis.title.y=element_text(size=18)) +
  geom_hline(aes(yintercept=20), linetype="dashed", color="#0072B2") +
  geom_hline(aes(yintercept=40), linetype="dashed", color="#56B4E9") +
  geom_hline(aes(yintercept=60), linetype="dashed", color="#009E73") +
  geom_hline(aes(yintercept=80), linetype="dashed", color="#E69F00") +
  facet_wrap_paginate(species ~ location_name, ncol=2, nrow=4, scales="fixed", page=i) +
  theme(strip.text.y = element_text(size=16, face="italic"),
        strip.text.x = element_text(size=16)))
  }
}

#end code for Night graph
```

`r if((difftime(max(df$Night),min(df$Night), units='days')>50) & (difftime(max(df$Night),min(df$Night), units='days') <300) & loc>1 & loc<5 & spn>1) {'**Figure 2.**\n The activity level (percentile) of bats recorded across each night of the bat survey, split by location and species.  '}`


```{r fig.width=9, fig.height=10}
# Night ~ percentile graph if 1 species and 2-5 locations
#if time diff between 50 and 300 days

if((difftime(max(df$Night),min(df$Night), units='days')>50) & (difftime(max(df$Night),min(df$Night), units='days')<300) & loc>1 & loc<5 & spn=="1"){ graphk<-ggplot(df, aes(x= Night, y= percentile))+
  geom_point(df, size=3, shape=1, 
             mapping = aes(x=Night, y= percentile, color=activity_level))+
  xlab("Night")+ #set x-axis
  ylab("Bat Activity Level (Percentile)")+
  scale_colour_manual(values=cbbPalette, name="Activity\nLevel",
                      breaks=c("High","Moderate/High","Moderate",
                               "Low/Moderate","Low"))+
  scale_y_continuous(breaks=seq(0,100,20), limits=c(0,100)) + 
  scale_x_date(name = "Date", date_breaks = "3 weeks", date_labels = "%d %b %y")+
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_rect(colour="black", linetype="solid"),
        axis.line=element_line(size=0.5, colour="black", linetype="solid"),
        axis.title.x=element_text(size=18),
        axis.text.x  = element_text(angle=90,size=16, hjust=1, vjust=0),
        axis.text.y  = element_text(size=12),
        axis.line.x = element_line(color="black", size = 0.5),
        axis.line.y = element_line(color="black", size = 0.5),
        axis.title.y=element_text(size=18))+
  geom_hline(aes(yintercept=20), linetype="dashed", color="#0072B2") +
  geom_hline(aes(yintercept=40), linetype="dashed", color="#56B4E9") +
  geom_hline(aes(yintercept=60), linetype="dashed", color="#009E73") +
  geom_hline(aes(yintercept=80), linetype="dashed", color="#E69F00") +
  facet_grid(. ~ location_name) +
  theme(strip.text.x = element_text(size=16))
graphk}

#end code for Night graph
```

`r if((difftime(max(df$Night),min(df$Night), units='days')>50) & (difftime(max(df$Night),min(df$Night), units='days') <300) & loc>1 & loc<5 & spn=="1") {'**Figure 2.**\n The activity level (percentile) of bats recorded across each night of the bat survey, split by location.  '}`

```{r fig.width=9, fig.height=12}
## Night ~ percentile graph if >5 location + >1 species
#if time diff between 50 and 300 days

if((difftime(max(df$Night),min(df$Night), units='days')>50) & (difftime(max(df$Night),min(df$Night), units='days') <300) & loc>=5 & spn>1) {
  
for (i in seq_len(n_pages)) {
  
  print(ggplot(df, aes(x= df$Night, y= percentile))+
  geom_point(df, size=3, shape=1,
             mapping = aes(x=df$Night, y= percentile, color=activity_level))+
  xlab("Night")+ #set x-axis
  ylab("Bat Activity Level (Percentile)")+
  scale_colour_manual(values=cbbPalette, name="Activity\nLevel",
                      breaks=c("High","Moderate/High","Moderate",
                               "Low/Moderate","Low"))+
  scale_y_continuous(breaks=seq(0,100,20), limits=c(0,100)) + 
  scale_x_date(name = "Date", date_breaks = "3 weeks", date_labels = "%d %b %y")+
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_rect(colour="black", linetype="solid"),
        axis.line=element_line(size=0.5, colour="black", linetype="solid"),
        axis.title.x=element_text(size=18),
        axis.text.x  = element_text(angle=90,size=16, hjust=1, vjust=0),
        axis.text.y  = element_text(size=12),
        axis.line.x = element_line(color="black", size = 0.5),
        axis.line.y = element_line(color="black", size = 0.5),
        axis.title.y=element_text(size=18)) +
  geom_hline(aes(yintercept=20), linetype="dashed", color="#0072B2") +
  geom_hline(aes(yintercept=40), linetype="dashed", color="#56B4E9") +
  geom_hline(aes(yintercept=60), linetype="dashed", color="#009E73") +
  geom_hline(aes(yintercept=80), linetype="dashed", color="#E69F00") +
  facet_wrap_paginate(species ~ location_name, ncol=2, nrow=4, scales="fixed", page=i) +
  theme(strip.text.y = element_text(size=16, face="italic"),
        strip.text.x = element_text(size=16)))
  }
}

#end code for Night graph
```

`r if((difftime(max(df$Night),min(df$Night), units='days')>50) & (difftime(max(df$Night),min(df$Night), units='days') <300) & loc>=5 & spn>1) {'**Figure 2.**\n The activity level (percentile) of bats recorded across each night of the bat survey, split by location and species.  '}`


```{r fig.width=9, fig.height=12}
# Night ~ percentile graph if 1 species and >5 location
#if time diff between 50 and 300 days

if((difftime(max(df$Night),min(df$Night), units='days')>50) & (difftime(max(df$Night),min(df$Night), units='days') <300) & loc>=5 & spn=="1") {
  
   for (i in seq_len(n_pages)) { 
     
  print(ggplot(df, aes(x= Night, y= percentile))+
  geom_point(df, size=3, shape=1, 
             mapping = aes(x=Night, y= percentile, color=activity_level))+
  xlab("Night")+ #set x-axis
  ylab("Bat Activity Level (Percentile)")+
  scale_colour_manual(values=cbbPalette, name="Activity\nLevel",
                      breaks=c("High","Moderate/High","Moderate",
                               "Low/Moderate","Low"))+
  scale_y_continuous(breaks=seq(0,100,20), limits=c(0,100)) + 
  scale_x_date(name = "Date", date_breaks = "3 weeks", date_labels = "%d %b %y")+
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_rect(colour="black", linetype="solid"),
        axis.line=element_line(size=0.5, colour="black", linetype="solid"),
        axis.title.x=element_text(size=18),
        axis.text.x  = element_text(angle=90,size=16),
        axis.text.y  = element_text(size=12),
        axis.line.x = element_line(color="black", size = 0.5),
        axis.line.y = element_line(color="black", size = 0.5),
        axis.title.y=element_text(size=18))+
  geom_hline(aes(yintercept=20), linetype="dashed", color="#0072B2") +
  geom_hline(aes(yintercept=40), linetype="dashed", color="#56B4E9") +
  geom_hline(aes(yintercept=60), linetype="dashed", color="#009E73") +
  geom_hline(aes(yintercept=80), linetype="dashed", color="#E69F00") +
  facet_wrap_paginate(species ~ location_name, ncol=2, nrow=4, scales="fixed", page=i) +
  theme(strip.text.x = element_text(size=16)))
  }
}
#end code for Night graph
```

`r if((difftime(max(df$Night),min(df$Night), units='days')>50) & (difftime(max(df$Night),min(df$Night), units='days') <300) & loc>=5 & spn=="1") {'**Figure 2.**\n The activity level (percentile) of bats recorded across each night of the bat survey, split by location.  '}`

```{r fig.width=9, fig.height=8}
## Night ~ percentile graph if 1 location, 1 species
#if data spans more than a year

if((difftime(max(df$Night),min(df$Night), units='days')>=300) & loc=="1" & spn=="1") {graphm<-ggplot(df, aes(x= Night, y= percentile)) +
  geom_point(df, size=3, 
             mapping = aes(x=Night, y= percentile, color=activity_level, shape=1))+
  xlab("Night")+ #set x-axis
  ylab("Bat Activity Level (Percentile)")+
  scale_colour_manual(values=cbbPalette, name="Activity\nLevel",
                      breaks=c("High","Moderate/High","Moderate",
                               "Low/Moderate","Low"))+
  scale_y_continuous(breaks=seq(0,100,20), limits=c(0,100)) + 
  scale_x_date(name = "Date", date_breaks = "12 weeks", date_labels = "%d %b %Y")+
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_rect(linetype="blank"),
        axis.line=element_line(size=0.5, colour="black", linetype="solid"),
        axis.title.x=element_text(size=18),
        axis.text.x  = element_text(angle=90,size=16),
        axis.text.y  = element_text(size=12),
        axis.line.x = element_line(color="black", size = 0.5),
        axis.line.y = element_line(color="black", size = 0.5),
        axis.title.y=element_text(size=18)) +
  geom_hline(aes(yintercept=20), linetype="dashed", color="#0072B2") +
  geom_hline(aes(yintercept=40), linetype="dashed", color="#56B4E9") +
  geom_hline(aes(yintercept=60), linetype="dashed", color="#009E73") +
  geom_hline(aes(yintercept=80), linetype="dashed", color="#E69F00") +
  graphm}

##end code for Night graph
```

`r if((difftime(max(df$Night),min(df$Night), units='days')>=300) & loc=="1" & spn=="1") {'**Figure 2.**\n The activity level (percentile) of bats recorded across each night of the bat survey.  '}`

```{r fig.width=9, fig.height=8}
## Night ~ percentile graph if 1 location, >1 species
#if data spans more than a year

if((difftime(max(df$Night),min(df$Night), units='days')>=300) & loc=="1" & spn>1) {
  
  for (i in seq_len(n_pages1)) {
  
  print(ggplot(df, aes(x= Night, y= percentile))+
  geom_point(df, size=3, 
             mapping = aes(x=Night, y= percentile, color=activity_level, shape=1))+
  xlab("Night")+ #set x-axis
  ylab("Bat Activity Level (Percentile)")+
  scale_colour_manual(values=cbbPalette, name="Activity\nLevel",
                      breaks=c("High","Moderate/High","Moderate",
                               "Low/Moderate","Low"))+
  scale_y_continuous(breaks=seq(0,100,20), limits=c(0,100)) + 
  scale_x_discrete(labels=abbreviate)+
  scale_x_date(name = "Date", date_breaks = "12 weeks", date_labels = "%d %b %Y")+
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_rect(colour="black", linetype="solid"),
        axis.line=element_line(size=0.5, colour="black", linetype="solid"),
        axis.title.x=element_text(size=18),
        axis.text.x  = element_text(angle=90,size=16),
        axis.text.y  = element_text(size=12),
        axis.line.x = element_line(color="black", size = 0.5),
        axis.line.y = element_line(color="black", size = 0.5),
        axis.title.y=element_text(size=18)) +
  geom_hline(aes(yintercept=20), linetype="dashed", color="#0072B2") +
  geom_hline(aes(yintercept=40), linetype="dashed", color="#56B4E9") +
  geom_hline(aes(yintercept=60), linetype="dashed", color="#009E73") +
  geom_hline(aes(yintercept=80), linetype="dashed", color="#E69F00") +
  facet_grid_paginate(species ~ ., ncol=1, nrow=5, scales="fixed", page=i) +
  theme(strip.text.y = element_text(size=16, face="italic")))
  }
}

##end code for Night graph
```

`r if((difftime(max(df$Night),min(df$Night), units='days')>=300) & loc=="1" & spn>1) {'**Figure 2.**\n The activity level (percentile) of bats recorded across each night of the bat survey, split by species.  '}`


```{r fig.width=9, fig.height=10}
## Night ~ percentile graph if 2-5 locations + >1 species
#if data spans more than a year

if((difftime(max(df$Night),min(df$Night), units='days')>=300) & loc>1 & loc<5 & spn>1) {
  
  for (i in seq_len(n_pages)) {
  
  print(ggplot(df, aes(x= Night, y= percentile))+
  geom_point(df, size=3, shape=1,
             mapping = aes(x=Night, y= percentile, color=activity_level))+
  xlab("Night")+ #set x-axis
  ylab("Bat Activity Level (Percentile)")+
  scale_colour_manual(values=cbbPalette, name="Activity\nLevel",
                      breaks=c("High","Moderate/High","Moderate",
                               "Low/Moderate","Low"))+
  scale_y_continuous(breaks=seq(0,100,20), limits=c(0,100)) + 
  scale_x_date(name = "Date", date_breaks = "12 weeks", date_labels = "%d %b %Y")+
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_rect(colour="black", linetype="solid"),
        axis.line=element_line(size=0.5, colour="black", linetype="solid"),
        axis.title.x=element_text(size=18),
        axis.text.x  = element_text(angle=90,size=16),
        axis.text.y  = element_text(size=12),
        axis.line.x = element_line(color="black", size = 0.5),
        axis.line.y = element_line(color="black", size = 0.5),
        axis.title.y=element_text(size=18)) +
  geom_hline(aes(yintercept=20), linetype="dashed", color="#0072B2") +
  geom_hline(aes(yintercept=40), linetype="dashed", color="#56B4E9") +
  geom_hline(aes(yintercept=60), linetype="dashed", color="#009E73") +
  geom_hline(aes(yintercept=80), linetype="dashed", color="#E69F00") +
  facet_wrap_paginate(species ~ location_name, ncol=2, nrow=4, scales="fixed", page=i) +
  theme(strip.text.y = element_text(size=16, face="italic"),
        strip.text.x = element_text(size=16)))
  }
}

#end code for Night graph
```

`r if((difftime(max(df$Night),min(df$Night), units='days')>=300) & loc>1 & loc<5 & spn>1) {'**Figure 2.**\n The activity level (percentile) of bats recorded across each night of the bat survey, split by location and species.  '}`


```{r fig.width=9, fig.height=10}
# Night ~ percentile graph if 1 species and 2-5 locations
#if data spans more than a year

if((difftime(max(df$Night),min(df$Night), units='days')>=300) & loc>1 & loc<5 & spn=="1") {graphn<-ggplot(df, aes(x= Night, y= percentile))+
  geom_point(df, size=3, shape=1, 
             mapping = aes(x=Night, y= percentile, color=activity_level))+
  xlab(expression("Night"))+ #set x-axis
  ylab("Bat Activity Level (Percentile)")+
  scale_colour_manual(values=cbbPalette, name="Activity\nLevel",
                      breaks=c("High","Moderate/High","Moderate",
                               "Low/Moderate","Low"))+
  scale_y_continuous(breaks=seq(0,100,20), limits=c(0,100)) + 
  scale_x_date(name = "Date", date_breaks = "12 weeks", date_labels = "%d %b %Y")+
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_rect(colour="black", linetype="solid"),
        axis.line=element_line(size=0.5, colour="black", linetype="solid"),
        axis.title.x=element_text(size=18),
        axis.text.x  = element_text(angle=90,size=16),
        axis.text.y  = element_text(size=12),
        axis.line.x = element_line(color="black", size = 0.5),
        axis.line.y = element_line(color="black", size = 0.5),
        axis.title.y=element_text(size=18))+
  geom_hline(aes(yintercept=20), linetype="dashed", color="#0072B2") +
  geom_hline(aes(yintercept=40), linetype="dashed", color="#56B4E9") +
  geom_hline(aes(yintercept=60), linetype="dashed", color="#009E73") +
  geom_hline(aes(yintercept=80), linetype="dashed", color="#E69F00") +
  facet_grid(. ~ location_name) +
  theme(strip.text.x = element_text(size=16))
graphn}

#end code for Night graph
```

`r if((difftime(max(df$Night),min(df$Night), units='days')>=300) & loc>1 & loc<5 & spn=="1") {'**Figure 2.**\n The activity level (percentile) of bats recorded across each night of the bat survey, split by location.  '}`


```{r fig.width=9, fig.height=10}
## Night ~ percentile graph if >5 location + >1 species
#if data spans more than a year

if((difftime(max(df$Night),min(df$Night), units='days')>=300) & loc>=5 & spn>1) {
  
   for (i in seq_len(n_pages)) { 
    
  print(ggplot(df, aes(x= Night, y= percentile))+
  geom_point(df, size=3, shape=1,
             mapping = aes(x=Night, y= percentile, color=activity_level))+
  xlab("Night")+ #set x-axis
  ylab("Bat Activity Level (Percentile)")+
  scale_colour_manual(values=cbbPalette, name="Activity\nLevel",
                      breaks=c("High","Moderate/High","Moderate",
                               "Low/Moderate","Low"))+
  scale_y_continuous(breaks=seq(0,100,20), limits=c(0,100)) + 
  scale_x_date(name = "Date", date_breaks = "12 weeks", date_labels = "%d %b %Y")+
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_rect(colour="black", linetype="solid"),
        axis.line=element_line(size=0.5, colour="black", linetype="solid"),
        axis.title.x=element_text(size=18),
        axis.text.x  = element_text(angle=90,size=16),
        axis.text.y  = element_text(size=12),
        axis.line.x = element_line(color="black", size = 0.5),
        axis.line.y = element_line(color="black", size = 0.5),
        axis.title.y=element_text(size=18)) +
  geom_hline(aes(yintercept=20), linetype="dashed", color="#0072B2") +
  geom_hline(aes(yintercept=40), linetype="dashed", color="#56B4E9") +
  geom_hline(aes(yintercept=60), linetype="dashed", color="#009E73") +
  geom_hline(aes(yintercept=80), linetype="dashed", color="#E69F00") +
  facet_wrap_paginate(species ~ location_name, ncol=2, nrow=4,  scales="fixed", page=i) +
  theme(strip.text.y = element_text(size=16, face="italic"),
        strip.text.x = element_text(size=16)))
  }
}
#end code for Night graph
```

`r if((difftime(max(df$Night),min(df$Night), units='days')>=300) & loc>=5 & spn=="1") {'**Figure 2.**\n The activity level (percentile) of bats recorded across each night of the bat survey, split by location and species.  '}`


```{r fig.width=9, fig.height=8}

# Night ~ percentile graph if 1 species and >5 location
#if data spans more than a year
df$Night<-as.Date(df$Night, format = "%d/%m/%Y")

if((difftime(max(df$Night),min(df$Night), units='days')>=300) & loc>=5 & spn=="1"){ 
  
  for(i in seq_len(n_pages)) {
  
  print(ggplot(df, aes(x= Night, y= percentile))+
  geom_point(df, size=3, shape=1, 
             mapping = aes(x=Night, y= percentile, color=activity_level))+
  xlab("Night")+ #set x-axis
  ylab("Bat Activity Level (Percentile)")+
  scale_colour_manual(values=cbbPalette, name="Activity\nLevel",
                      breaks=c("High","Moderate/High","Moderate",
                               "Low/Moderate","Low"))+
  scale_y_continuous(breaks=seq(0,100,20), limits=c(0,100)) + 
  scale_x_date(name = "Date", date_breaks = "12 weeks", date_labels = "%d %b %Y")+
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_rect(colour="black", linetype="solid"),
        axis.line=element_line(size=0.5, colour="black", linetype="solid"),
        axis.title.x=element_text(size=18),
        axis.text.x  = element_text(angle=90,size=16),
        axis.text.y  = element_text(size=12),
        axis.line.x = element_line(color="black", size = 0.5),
        axis.line.y = element_line(color="black", size = 0.5),
        axis.title.y=element_text(size=18))+
  geom_hline(aes(yintercept=20), linetype="dashed", color="#0072B2") +
  geom_hline(aes(yintercept=40), linetype="dashed", color="#56B4E9") +
  geom_hline(aes(yintercept=60), linetype="dashed", color="#009E73") +
  geom_hline(aes(yintercept=80), linetype="dashed", color="#E69F00") +
  facet_wrap_paginate(species ~ location_name, ncol=2, nrow=4, scales="fixed", page=i) +
  theme(strip.text.x = element_text(size=16)))
  }
}
#end code for Night graph
```

`r if((difftime(max(df$Night),min(df$Night), units='days')>=300) & loc>5 & spn=="1") {'**Figure 2.**\n The activity level (percentile) of bats recorded across each night of the bat survey, split by location.  '}`



## PER DETECTOR, PER MONTH


#### Table 1

Summary table showing the number of nights recorded bat activity fell into each activity band for each species at each detector during each month.
```{r}

actdata <- plyr::ddply(df, c("location_name", "species", "Month"), summarise,
                 Nights.high = sum(activity_level=="high"),
                 Nights.modhigh = sum(activity_level=="medium/high"),
                 Nights.mod = sum(activity_level=="medium"),
                 Nights.lowmod = sum(activity_level=="low/medium"),
                 Nights.low = sum(activity_level=="low"))

#rename columns
names(actdata)[names(actdata)=="location_name"] <- "Detector ID"
names(actdata)[names(actdata)=="species"] <- "Species/Species Group"
names(actdata)[names(actdata)=="Nights.high"] <- "Nights of High Activity"
names(actdata)[names(actdata)=="Nights.modhigh"] <- "Nights of Moderate/ High Activity"
names(actdata)[names(actdata)=="Nights.mod"] <- "Nights of Moderate Activity"
names(actdata)[names(actdata)=="Nights.lowmod"] <- "Nights of Low/ Moderate Activity"
names(actdata)[names(actdata)=="Nights.low"] <- "Nights of Low Activity"                  

results='asis'#important to run this as it ensures the raw table output isn't processed further by knitr
datatable2<-actdata
emphasize.italics.cols(2) #second column needs to be in italics i.e. species names
panderOptions("table.split.table", Inf) #don't split table
pander(datatable2, style = 'rmarkdown', keep.line.breaks=TRUE) 
  

```


#### Table 2

Summary table showing key metrics for each species recorded per month. Please note that the reference range is not split by month.
```{r}

if (mean(wp$surv) >=2) {

con<-subset(wp, surv>=2) #subset dataset to only include records with more than one night of surveying
confint<-groupwiseMedian(percentile ~ location_name + Spp, #code to get confidence intervals
                          data       = con, 
                          conf       = 0.95, 
                          R          = 1000,
                          wilcox =   TRUE, 
                          bca        = FALSE, 
                          digits     = 3)

confint <- transform(confint, Wilcox.lower = ifelse(Wilcox.lower == "NaN", Median, Wilcox.lower))
confint <- transform(confint, Wilcox.upper = ifelse(Wilcox.upper == "NaN", Median, Wilcox.upper))


mm<-merge(con, confint) #merge with subsetted dataset to put columns with the confidence intervals on the end
mm$confint = paste(mm$Wilcox.lower, mm$Wilcox.upper, sep=" - ") #add a new column with CIs merged

non<-subset(wp,surv=="1") #subset dataset to only include records with one night of surveying
if(nrow(non)>0) {
  non$n <- 0 #add empty columns to enable merger
non$Median <- 0
non$Wilcox.upper <- 0
non$Wilcox.lower <- 0
non$confint <- 0}

please<-rbind(mm, non) #join the two datasets back together

library(plyr) #ddply as normal
mdata2 <- plyr::ddply(please, c("location_name", "species", "Month"), summarise,
               Median.percentile = ceiling(median(percentile)),#finds median percentile
               conf = max(confint),
               Highest.perc = max(percentile), #returns max percentiles
               Number.nights = length(date), #returns how many nights of data in the dataset
               Reference.range.size = mean(reference_range_size)) #returns reference range size - i used mean as it should be the 
#same in each row because same species same location
names(mdata2)[names(mdata2)=="location_name"] <- "Detector ID"
names(mdata2)[names(mdata2)=="species"] <- "Species/Species Group"
names(mdata2)[names(mdata2)=="Median.percentile"] <- "Median Percentile"
names(mdata2)[names(mdata2)=="conf"] <- "95% CIs"
names(mdata2)[names(mdata2)=="Highest.perc"] <- "Max Percentile"
names(mdata2)[names(mdata2)=="Number.nights"] <- "Nights Recorded"
names(mdata2)[names(mdata2)=="Reference.range.size"] <- "Reference Range"

library(knitr)
library(pander)
results='asis' #important to run this as it ensures the raw table output isn't processed further by knitr
medtable2<-mdata2
emphasize.italics.cols(2)
panderOptions("table.split.table", Inf)
panderOptions("table.split.cells", Inf)
pander(medtable2, style = 'multiline', keep.line.breaks=TRUE,justify = c('centre', 'centre', 'centre', 'centre', 'centre', 'centre', 'centre', 'centre'))

}

if (mean(wp$surv) == 1) {
  
non<-subset(wp,surv=="1") #subset dataset to only include records with one night of surveying
if(nrow(non)>0) {
  non$n <- 0 #add empty columns to enable merger
non$Median <- 0
non$Wilcox.upper <- 0
non$Wilcox.lower <- 0
non$confint <- 0}


library(plyr) #ddply as normal
mdata2 <- plyr::ddply(non, c("location_name", "species", "Month"), summarise,
               Median.percentile = ceiling(median(percentile)),#finds median percentile
               conf = max(confint),
               Highest.perc = max(percentile), #returns max percentiles
               Number.nights = length(date), #returns how many nights of data in the dataset
               Reference.range.size = mean(reference_range_size)) #returns reference range size - i used mean as it should be the 
#same in each row because same species same location
names(mdata2)[names(mdata2)=="location_name"] <- "Detector ID"
names(mdata2)[names(mdata2)=="species"] <- "Species/Species Group"
names(mdata2)[names(mdata2)=="Median.percentile"] <- "Median Percentile"
names(mdata2)[names(mdata2)=="conf"] <- "95% CIs"
names(mdata2)[names(mdata2)=="Highest.perc"] <- "Max Percentile"
names(mdata2)[names(mdata2)=="Number.nights"] <- "Nights Recorded"
names(mdata2)[names(mdata2)=="Reference.range.size"] <- "Reference Range"

library(knitr)
library(pander)
results='asis' #important to run this as it ensures the raw table output isn't processed further by knitr
medtable2<-mdata2
emphasize.italics.cols(2)
panderOptions("table.split.table", Inf)
panderOptions("table.split.cells", Inf)
pander(medtable2, style = 'multiline', keep.line.breaks=TRUE,justify = c('centre', 'centre', 'centre', 'centre', 'centre', 'centre', 'centre', 'centre'))

}



```



## PER SITE

#### Table 1

Summary table showing the number of nights recorded bat activity fell into each activity band for each species.
```{r}
library(plyr)
actdata <- plyr::ddply(df, c("species"), summarise,
                 Nights.high = sum(activity_level=="high"),
                 Nights.modhigh = sum(activity_level=="medium/high"),
                 Nights.mod = sum(activity_level=="medium"),
                 Nights.lowmod = sum(activity_level=="low/medium"),
                 Nights.low = sum(activity_level=="low"))

#rename columns
names(actdata)[names(actdata)=="species"] <- "Species/Species Group"
names(actdata)[names(actdata)=="Nights.high"] <- "Nights of High Activity"
names(actdata)[names(actdata)=="Nights.modhigh"] <- "Nights of Moderate/ High Activity"
names(actdata)[names(actdata)=="Nights.mod"] <- "Nights of Moderate Activity"
names(actdata)[names(actdata)=="Nights.lowmod"] <- "Nights of Low/ Moderate Activity"
names(actdata)[names(actdata)=="Nights.low"] <- "Nights of Low Activity"                  

library(knitr)
results='asis'#important to run this as it ensures the raw table output isn't processed further by knitr
datatable2<-actdata
emphasize.italics.cols(2) #second column needs to be in italics i.e. species names
panderOptions("table.split.table", Inf) #don't split table
pander(datatable2, style = 'rmarkdown', keep.line.breaks=TRUE)
```


#### Table 2

Summary table showing key metrics for each species recorded.
```{r}

if (mean(wp$surv) >= 2) {

con<-subset(wp, surv>=2) #subset dataset to only include records with more than one night of surveying
confint<-groupwiseMedian(percentile ~ location_name + Spp, #code to get confidence intervals
                          data       = con, 
                          conf       = 0.95, 
                          R          = 1000,
                          wilcox =   TRUE, 
                          bca        = FALSE, 
                          digits     = 3)

confint <- transform(confint, Wilcox.lower = ifelse(Wilcox.lower == "NaN", Median, Wilcox.lower))
confint <- transform(confint, Wilcox.upper = ifelse(Wilcox.upper == "NaN", Median, Wilcox.upper))


mm<-merge(con, confint) #merge with subsetted dataset to put columns with the confidence intervals on the end
mm$confint = paste(mm$Wilcox.lower, mm$Wilcox.upper, sep=" - ") #add a new column with CIs merged

non<-subset(wp,surv=="1") #subset dataset to only include records with one night of surveying
if(nrow(non)>0) {
  non$n <- 0 #add empty columns to enable merger
non$Median <- 0
non$Wilcox.upper <- 0
non$Wilcox.lower <- 0
non$confint <- 0}

please<-rbind(mm, non) #join the two datasets back together

library(plyr) #ddply as normal
mdata2 <- plyr::ddply(please, c("species"), summarise,
               Median.percentile = ceiling(median(percentile)),#finds median percentile
               conf = max(confint),
               Highest.perc = max(percentile), #returns max percentiles
               Number.nights = length(date), #returns how many nights of data in the dataset
               Reference.range.size = mean(reference_range_size)) #returns reference range size - i used mean as it should be the 
#same in each row because same species same location
names(mdata2)[names(mdata2)=="species"] <- "Species/Species Group"
names(mdata2)[names(mdata2)=="Median.percentile"] <- "Median Percentile"
names(mdata2)[names(mdata2)=="conf"] <- "95% CIs"
names(mdata2)[names(mdata2)=="Highest.perc"] <- "Max Percentile"
names(mdata2)[names(mdata2)=="Number.nights"] <- "Nights Recorded"
names(mdata2)[names(mdata2)=="Reference.range.size"] <- "Reference Range"

library(knitr)
library(pander)
results='asis' #important to run this as it ensures the raw table output isn't processed further by knitr
medtable2<-mdata2
emphasize.italics.cols(1)
panderOptions("table.split.table", Inf)
panderOptions("table.split.cells", Inf)
pander(medtable2, style = 'multiline', keep.line.breaks=TRUE,justify = c('right', 'left', 'centre', 'centre', 'centre', 'centre'))
}


if (mean(wp$surv) == 1) {

  non<-subset(wp,surv=="1") #subset dataset to only include records with one night of surveying
if(nrow(non)>0) {
  non$n <- 0 #add empty columns to enable merger
non$Median <- 0
non$Wilcox.upper <- 0
non$Wilcox.lower <- 0
non$confint <- 0}


mdata2 <- plyr::ddply(non, c("species"), summarise,
               Median.percentile = ceiling(median(percentile)),#finds median percentile
               conf = max(confint),
               Highest.perc = max(percentile), #returns max percentiles
               Number.nights = length(date), #returns how many nights of data in the dataset
               Reference.range.size = mean(reference_range_size)) #returns reference range size - i used mean as it should be the 
#same in each row because same species same location
names(mdata2)[names(mdata2)=="species"] <- "Species/Species Group"
names(mdata2)[names(mdata2)=="Median.percentile"] <- "Median Percentile"
names(mdata2)[names(mdata2)=="conf"] <- "95% CIs"
names(mdata2)[names(mdata2)=="Highest.perc"] <- "Max Percentile"
names(mdata2)[names(mdata2)=="Number.nights"] <- "Nights Recorded"
names(mdata2)[names(mdata2)=="Reference.range.size"] <- "Reference Range"

library(knitr)
library(pander)
results='asis' #important to run this as it ensures the raw table output isn't processed further by knitr
medtable2<-mdata2
emphasize.italics.cols(1)
panderOptions("table.split.table", Inf)
panderOptions("table.split.cells", Inf)
pander(medtable2, style = 'multiline', keep.line.breaks=TRUE,justify = c('right', 'left', 'centre', 'centre', 'centre', 'centre'))
  
}

```



###Figures

```{r fig.width=9, fig.height=6}

#boxplot if 1 location

graphbox<-ggplot(df, aes(x=Spp, y=percentile))+ #add lines first
  geom_hline(aes(yintercept=0), linetype="dashed", color="#000000") +
  geom_hline(aes(yintercept=20), linetype="dashed", color="#0072B2") +
  geom_hline(aes(yintercept=40), linetype="dashed", color="#56B4E9") +
  geom_hline(aes(yintercept=60), linetype="dashed", color="#009E73") +
  geom_hline(aes(yintercept=80), linetype="dashed", color="#E69F00") +
  geom_boxplot(df, mapping = aes(fill=species))+
  xlab("\nSpecies")+
  ylab("Bat Activity Level (Percentile)\n")+
  scale_fill_grey(start = 0.35, end = 1)+
  scale_x_discrete(drop=FALSE) +
  scale_y_continuous(breaks=seq(0,100,20)) +
  expand_limits(y=c(0,100))+
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_rect(linetype="blank"),
        axis.line=element_line(size=0.5, colour="black", linetype="solid"),
        axis.title.x=element_text(size=18),
        axis.text.x  = element_text(angle=90, face="italic", size=14, hjust=1, vjust=0),
        axis.text.y  = element_text(size=12),
        axis.line.x = element_line(color="black", size = 0.5),
        axis.line.y = element_line(color="black", size = 0.5),
        axis.title.y=element_text(size=16),
        legend.position="none")
graphbox

#endcode for boxplot
```

`r '**Figure 1.**\n The activity level (percentile) of bats recorded across each night of the bat survey for the entire site.  '`


```{r fig.width=9, fig.height=6}

#boxplot if 1 location

graphbox<-ggplot(df, aes(x=Spp, y=percentile))+ #add lines first
  geom_hline(aes(yintercept=0), linetype="dashed", color="#000000") +
  geom_hline(aes(yintercept=20), linetype="dashed", color="#0072B2") +
  geom_hline(aes(yintercept=40), linetype="dashed", color="#56B4E9") +
  geom_hline(aes(yintercept=60), linetype="dashed", color="#009E73") +
  geom_hline(aes(yintercept=80), linetype="dashed", color="#E69F00") +
  geom_boxplot(df, mapping = aes(fill=species))+
  xlab("\nSpecies")+
  ylab("Bat Activity Level (Percentile)\n")+
  scale_fill_grey(start = 0.35, end = 1)+
  scale_x_discrete(drop=FALSE) +
  scale_y_continuous(breaks=seq(0,100,20)) +
  expand_limits(y=c(0,100))+
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_rect(linetype="blank"),
        axis.line=element_line(size=0.5, colour="black", linetype="solid"),
        axis.title.x=element_text(size=18),
        axis.text.x  = element_text(angle=90, face="italic", size=10, hjust=1, vjust=0),
        axis.text.y  = element_text(size=12),
        axis.line.x = element_line(color="black", size = 0.5),
        axis.line.y = element_line(color="black", size = 0.5),
        axis.title.y=element_text(size=16),
        legend.position="none") +
  facet_wrap(~Month)
graphbox

#endcode for boxplot
```

`r '**Figure 2.**\n The activity level (percentile) of bats recorded across each night of the bat survey for the entire site, but split between months.  '`


```{r median medians}

df$percentiles <- as.numeric(df$percentile)

medians <- df %>%
  dplyr::select(location_name, Night, Spp, percentiles,
                activity_level, species) %>%
  dplyr::group_by(Night, Spp) %>%
  dplyr::mutate(med = median(percentiles)) %>%
  dplyr::arrange(Night)


```


```{r fig.width=9, fig.height=8}
## Night ~ med graph if 1 location, 1 species
#if less than 21 days

if((difftime(max(medians$Night),min(medians$Night), units='days')<=21) & locs=="1" & spn=="1"){ graphD<-ggplot(medians, aes(x= Night, y= (median(med)))) +
  geom_point(medians, size=3, shape=1,
             mapping = aes(x=Night, y= med, color=activity_level))+
  xlab("Night")+ #set x-axis
  ylab("Bat Activity Level (med)")+
  scale_colour_manual(values=cbbPalette, name="Activity\nLevel",
                      breaks=c("High","Moderate/High","Moderate",
                               "Low/Moderate","Low"))+
  scale_y_continuous(breaks=seq(0,100,20), limits=c(0,100)) + 
  scale_x_date(name = "Date", date_breaks = "3 days", date_labels = "%d %b %Y")+
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_rect(linetype="blank"),
        axis.line=element_line(size=0.5, colour="black", linetype="solid"),
        axis.title.x=element_text(size=18),
        axis.text.x  = element_text(angle=90,size=16, hjust=1, vjust=0),
        axis.text.y  = element_text(size=12),
        axis.line.x = element_line(color="black", size = 0.5),
        axis.line.y = element_line(color="black", size = 0.5),
        axis.title.y=element_text(size=18)) +
  geom_hline(aes(yintercept=20), linetype="dashed", color="#0072B2") +
  geom_hline(aes(yintercept=40), linetype="dashed", color="#56B4E9") +
  geom_hline(aes(yintercept=60), linetype="dashed", color="#009E73") +
  geom_hline(aes(yintercept=80), linetype="dashed", color="#E69F00")
  graphD}

##end code for Night graph
```

```{r fig.width=9, fig.height=8}
## Night ~ med graph if 1 location, >1 species
#if less than 21 days

if((difftime(max(medians$Night),min(medians$Night), units='days')<=21) & locs=="1" & spn>1) {
  
  for (i in seq_len(n_pages2)) {
  
  print(ggplot(medians, aes(x= Night, y= med))+
  geom_point(medians, size=3, shape=1, 
             mapping = aes(x=Night, y= med, color=activity_level))+
  xlab("Night")+ #set x-axis
  ylab("Bat Activity Level (med)")+
  scale_colour_manual(values=cbbPalette, name="Activity\nLevel",
                      breaks=c("High","Moderate/High","Moderate",
                               "Low/Moderate","Low"))+
  scale_y_continuous(breaks=seq(0,100,20), limits=c(0,100)) +
  scale_x_date(name = "Date", date_breaks = "3 days", date_labels = "%d %b %Y")+
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_rect(colour="black", linetype="solid"),
        axis.line=element_line(size=0.5, colour="black", linetype="solid"),
        axis.title.x=element_text(size=18),
        axis.text.x  = element_text(angle=90,size=16, hjust=1, vjust=0),
        axis.text.y  = element_text(size=12),
        axis.line.x = element_line(color="black", size = 0.5),
        axis.line.y = element_line(color="black", size = 0.5),
        axis.title.y=element_text(size=18)) +
  geom_hline(aes(yintercept=20), linetype="dashed", color="#0072B2") +
  geom_hline(aes(yintercept=40), linetype="dashed", color="#56B4E9") +
  geom_hline(aes(yintercept=60), linetype="dashed", color="#009E73") +
  geom_hline(aes(yintercept=80), linetype="dashed", color="#E69F00") +
  facet_grid_paginate(species ~ ., ncol=1, nrow=4, scales="fixed", page=i) +
  theme(strip.text.y = element_text(size=16, face="italic")))
  }
}  

##end code for Night graph
```


```{r fig.width=9, fig.height=8}
## Night ~ med graph if 1 location, 1 species
#if time difference is between 21 and 50 days 

if((difftime(max(medians$Night),min(medians$Night), units='days')>21) & (difftime(max(medians$Night),min(medians$Night), units='days')<50) & locs=="1" & spn=="1"){ graphG<-ggplot(medians, aes(x= Night, y= med)) +
  geom_point(medians, size=3, 
             mapping = aes(x=Night, y= med, color=activity_level, shape=1))+
  xlab("Night")+ #set x-axis
  ylab("Bat Activity Level (med)")+
  scale_colour_manual(values=cbbPalette, name="Activity\nLevel",
                      breaks=c("High","Moderate/High","Moderate",
                               "Low/Moderate","Low"))+
  scale_y_continuous(breaks=seq(0,100,20), limits=c(0,100)) + 
  scale_x_date(name = "Date", date_breaks = "1 week", date_labels = "%d %b %Y")+
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_rect(linetype="blank"),
        axis.line=element_line(size=0.5, colour="black", linetype="solid"),
        axis.title.x=element_text(size=18),
        axis.text.x  = element_text(angle=90,size=16, hjust=1, vjust=0),
        axis.text.y  = element_text(size=12),
        axis.line.x = element_line(color="black", size = 0.5),
        axis.line.y = element_line(color="black", size = 0.5),
        axis.title.y=element_text(size=18)) +
  geom_hline(aes(yintercept=20), linetype="dashed", color="#0072B2") +
  geom_hline(aes(yintercept=40), linetype="dashed", color="#56B4E9") +
  geom_hline(aes(yintercept=60), linetype="dashed", color="#009E73") +
  geom_hline(aes(yintercept=80), linetype="dashed", color="#E69F00") +
  graphG}

##end code for Night graph
```

```{r fig.width=9, fig.height=8}
## Night ~ med graph if 1 location, >1 species
#if time difference is between 21 and 50 days 

if((difftime(max(medians$Night),min(medians$Night), units='days')>21) & (difftime(max(medians$Night),min(medians$Night), units='days')<50) & locs=="1" & spn>1) { 
  
  for (i in seq_len(n_pages2)) {
  
  print(ggplot(medians, aes(x= Night, y= med))+
  geom_point(medians, size=3, shape=1,
             mapping = aes(x=Night, y= med, color=activity_level))+
  xlab("Night")+ #set x-axis
  ylab("Bat Activity Level (med)")+
  scale_colour_manual(values=cbbPalette, name="Activity\nLevel",
                      breaks=c("High","Moderate/High","Moderate",
                               "Low/Moderate","Low"))+
  scale_y_continuous(breaks=seq(0,100,20), limits=c(0,100)) +
  scale_x_date(name = "Date", date_breaks = "1 week", date_labels = "%d %b %y")+
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_rect(colour="black", linetype="solid"),
        axis.line=element_line(size=0.5, colour="black", linetype="solid"),
        axis.title.x=element_text(size=18),
        axis.text.x  = element_text(angle=90,size=16, hjust=1, vjust=0),
        axis.text.y  = element_text(size=12),
        axis.line.x = element_line(color="black", size = 0.5),
        axis.line.y = element_line(color="black", size = 0.5),
        axis.title.y=element_text(size=18)) +
  geom_hline(aes(yintercept=20), linetype="dashed", color="#0072B2") +
  geom_hline(aes(yintercept=40), linetype="dashed", color="#56B4E9") +
  geom_hline(aes(yintercept=60), linetype="dashed", color="#009E73") +
  geom_hline(aes(yintercept=80), linetype="dashed", color="#E69F00") +
  facet_grid_paginate(species ~ ., ncol=1, nrow=4, scales="fixed", page=i) +
  theme(strip.text.y = element_text(size=16, face="italic")))
  }
}
##end code for Night graph
```


```{r fig.width=9, fig.height=8}
## Night ~ med graph if 1 location, 1 species
#if time diff between 50 and 300 days

if((difftime(max(medians$Night),min(medians$Night), units='days')>50) & (difftime(max(medians$Night),min(medians$Night), units='days')<300) & locs=="1" & spn=="1"){ ggplot(medians, aes(x= Night, y= med)) +
   geom_point(medians, size=3, shape=1, 
             mapping = aes(x=Night, y= med, color=activity_level))+
  xlab("Night")+ #set x-axis
  ylab("Bat Activity Level (med)")+
  scale_colour_manual(values=cbbPalette, name="Activity\nLevel",
                      breaks=c("High","Moderate/High","Moderate",
                               "Low/Moderate","Low"))+
  scale_y_continuous(breaks=seq(0,100,20), limits=c(0,100)) + 
  scale_x_date(name = "Date", date_breaks = "3 weeks", date_labels = "%d %b %y")+
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_rect(linetype="blank"),
        axis.line=element_line(size=0.5, colour="black", linetype="solid"),
        axis.title.x=element_text(size=18),
        axis.text.x  = element_text(angle=90,size=16, hjust=1, vjust=0),
        axis.text.y  = element_text(size=12),
        axis.line.x = element_line(color="black", size = 0.5),
        axis.line.y = element_line(color="black", size = 0.5),
        axis.title.y=element_text(size=18)) +
  geom_hline(aes(yintercept=20), linetype="dashed", color="#0072B2") +
  geom_hline(aes(yintercept=40), linetype="dashed", color="#56B4E9") +
  geom_hline(aes(yintercept=60), linetype="dashed", color="#009E73") +
  geom_hline(aes(yintercept=80), linetype="dashed", color="#E69F00")
  }

##end code for Night graph
```

```{r fig.width=9, fig.height=10}
## Night ~ med graph if 1 location, >1 species
#if time diff between 50 and 300 days

if((difftime(max(medians$Night),min(medians$Night), units='days')>50) & (difftime(max(medians$Night),min(medians$Night), units='days')<300) & locs=="1" & spn>1) {
  
  for (i in seq_len(n_pages2)) {
  
  print(ggplot(medians, aes(x= Night, y= med))+
  geom_point(medians, size=3, shape = 1,
             mapping = aes(x=Night, y= med, color=activity_level))+
  xlab("Night")+ #set x-axis
  ylab("Bat Activity Level (med)")+
  scale_colour_manual(values=cbbPalette, name="Activity\nLevel",
                      breaks=c("High","Moderate/High","Moderate",
                               "Low/Moderate","Low"))+
  scale_y_continuous(breaks=seq(0,100,20), limits=c(0,100)) +
  scale_x_date(name = "Date", date_breaks = "3 weeks", date_labels = "%d %b %y")+
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_rect(colour="black", linetype="solid"),
        axis.line=element_line(size=0.5, colour="black", linetype="solid"),
        axis.title.x=element_text(size=18),
        axis.text.x  = element_text(angle=90,size=16, hjust=1, vjust=0),
        axis.text.y  = element_text(size=12),
        axis.line.x = element_line(color="black", size = 0.5),
        axis.line.y = element_line(color="black", size = 0.5),
        axis.title.y=element_text(size=18)) +
  geom_hline(aes(yintercept=20), linetype="dashed", color="#0072B2") +
  geom_hline(aes(yintercept=40), linetype="dashed", color="#56B4E9") +
  geom_hline(aes(yintercept=60), linetype="dashed", color="#009E73") +
  geom_hline(aes(yintercept=80), linetype="dashed", color="#E69F00") +
  facet_grid_paginate(species ~ ., ncol=1, nrow=4, scales="fixed", page=i) +
  theme(strip.text.y = element_text(size=16, face="italic")))
 }
}

##end code for Night graph
```


```{r fig.width=9, fig.height=8}
## Night ~ med graph if 1 location, 1 species
#if data spans more than a year

if((difftime(max(medians$Night),min(medians$Night), units='days')>=300) & locs=="1" & spn=="1") {graphm<-ggplot(medians, aes(x= Night, y= med)) +
  geom_point(medians, size=3, 
             mapping = aes(x=Night, y= med, color=activity_level, shape=1))+
  xlab("Night")+ #set x-axis
  ylab("Bat Activity Level (med)")+
  scale_colour_manual(values=cbbPalette, name="Activity\nLevel",
                      breaks=c("High","Moderate/High","Moderate",
                               "Low/Moderate","Low"))+
  scale_y_continuous(breaks=seq(0,100,20), limits=c(0,100)) + 
  scale_x_date(name = "Date", date_breaks = "12 weeks", date_labels = "%d %b %Y")+
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_rect(linetype="blank"),
        axis.line=element_line(size=0.5, colour="black", linetype="solid"),
        axis.title.x=element_text(size=18),
        axis.text.x  = element_text(angle=90,size=16),
        axis.text.y  = element_text(size=12),
        axis.line.x = element_line(color="black", size = 0.5),
        axis.line.y = element_line(color="black", size = 0.5),
        axis.title.y=element_text(size=18)) +
  geom_hline(aes(yintercept=20), linetype="dashed", color="#0072B2") +
  geom_hline(aes(yintercept=40), linetype="dashed", color="#56B4E9") +
  geom_hline(aes(yintercept=60), linetype="dashed", color="#009E73") +
  geom_hline(aes(yintercept=80), linetype="dashed", color="#E69F00") +
  graphm}

##end code for Night graph
```


```{r fig.width=9, fig.height=8}
## Night ~ med graph if 1 location, >1 species
#if data spans more than a year

if((difftime(max(medians$Night),min(medians$Night), units='days')>=300) & locs=="1" & spn>1) {
  
  for (i in seq_len(n_pages2)) {
  
  print(ggplot(medians, aes(x= Night, y= med))+
  geom_point(medians, size=3, shape=1,
             mapping = aes(x=Night, y= med, color=activity_level))+
  xlab("Night")+ #set x-axis
  ylab("Bat Activity Level (med)")+
  scale_colour_manual(values=cbbPalette, name="Activity\nLevel",
                      breaks=c("High","Moderate/High","Moderate",
                               "Low/Moderate","Low"))+
  scale_y_continuous(breaks=seq(0,100,20), limits=c(0,100)) + 
  scale_x_discrete(labels=abbreviate)+
  scale_x_date(name = "Date", date_breaks = "12 weeks", date_labels = "%d %b %Y")+
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_rect(colour="black", linetype="solid"),
        axis.line=element_line(size=0.5, colour="black", linetype="solid"),
        axis.title.x=element_text(size=18),
        axis.text.x  = element_text(angle=90,size=16),
        axis.text.y  = element_text(size=12),
        axis.line.x = element_line(color="black", size = 0.5),
        axis.line.y = element_line(color="black", size = 0.5),
        axis.title.y=element_text(size=18)) +
  geom_hline(aes(yintercept=20), linetype="dashed", color="#0072B2") +
  geom_hline(aes(yintercept=40), linetype="dashed", color="#56B4E9") +
  geom_hline(aes(yintercept=60), linetype="dashed", color="#009E73") +
  geom_hline(aes(yintercept=80), linetype="dashed", color="#E69F00") +
  facet_grid_paginate(species ~ ., ncol=1, nrow=4, scales="fixed", page=i) +
  theme(strip.text.y = element_text(size=16, face="italic")))
  }
}

##end code for Night graph
```

`r '**Figure 3.**\n The activity level (percentile) of bats recorded across each night of the bat survey, split by species.  '`


## PER SITE, PER MONTH


#### Table 1

Summary table showing the number of nights recorded bat activity fell into each activity band for each species during each month.
```{r}

actdata <- plyr::ddply(df, c("species", "Month"), summarise,
                 Nights.high = sum(activity_level=="high"),
                 Nights.modhigh = sum(activity_level=="medium/high"),
                 Nights.mod = sum(activity_level=="medium"),
                 Nights.lowmod = sum(activity_level=="low/medium"),
                 Nights.low = sum(activity_level=="low"))

#rename columns
names(actdata)[names(actdata)=="species"] <- "Species/Species Group"
names(actdata)[names(actdata)=="Nights.high"] <- "Nights of High Activity"
names(actdata)[names(actdata)=="Nights.modhigh"] <- "Nights of Moderate/ High Activity"
names(actdata)[names(actdata)=="Nights.mod"] <- "Nights of Moderate Activity"
names(actdata)[names(actdata)=="Nights.lowmod"] <- "Nights of Low/ Moderate Activity"
names(actdata)[names(actdata)=="Nights.low"] <- "Nights of Low Activity"                  

results='asis'#important to run this as it ensures the raw table output isn't processed further by knitr
datatable2<-actdata
emphasize.italics.cols(1) #second column needs to be in italics i.e. species names
panderOptions("table.split.table", Inf) #don't split table
pander(datatable2, style = 'rmarkdown', keep.line.breaks=TRUE) 
  

```


#### Table 2

Summary table showing key metrics for each species recorded per month. Please note that the reference range is not split by month.
```{r}

if (mean(wp$surv) >= 2) {

con<-subset(wp, surv>=2) #subset dataset to only include records with more than one night of surveying
confint<-groupwiseMedian(percentile ~ location_name + Spp, #code to get confidence intervals
                          data       = con, 
                          conf       = 0.95, 
                          R          = 1000,
                          wilcox =   TRUE, 
                          bca        = FALSE, 
                          digits     = 3)

confint <- transform(confint, Wilcox.lower = ifelse(Wilcox.lower == "NaN", Median, Wilcox.lower))
confint <- transform(confint, Wilcox.upper = ifelse(Wilcox.upper == "NaN", Median, Wilcox.upper))


mm<-merge(con, confint) #merge with subsetted dataset to put columns with the confidence intervals on the end
mm$confint = paste(mm$Wilcox.lower, mm$Wilcox.upper, sep=" - ") #add a new column with CIs merged

non<-subset(wp,surv=="1") #subset dataset to only include records with one night of surveying
if(nrow(non)>0) {
  non$n <- 0 #add empty columns to enable merger
non$Median <- 0
non$Wilcox.upper <- 0
non$Wilcox.lower <- 0
non$confint <- 0}

please<-rbind(mm, non) #join the two datasets back together

library(plyr) #ddply as normal
mdata2 <- plyr::ddply(please, c("species", "Month"), summarise,
               Median.percentile = ceiling(median(percentile)),#finds median percentile
               conf = max(confint),
               Highest.perc = max(percentile), #returns max percentiles
               Number.nights = length(date), #returns how many nights of data in the dataset
               Reference.range.size = mean(reference_range_size)) #returns reference range size - i used mean as it should be the 
#same in each row because same species same location
names(mdata2)[names(mdata2)=="species"] <- "Species/Species Group"
names(mdata2)[names(mdata2)=="Median.percentile"] <- "Median Percentile"
names(mdata2)[names(mdata2)=="conf"] <- "95% CIs"
names(mdata2)[names(mdata2)=="Highest.perc"] <- "Max Percentile"
names(mdata2)[names(mdata2)=="Number.nights"] <- "Nights Recorded"
names(mdata2)[names(mdata2)=="Reference.range.size"] <- "Reference Range"

library(knitr)
library(pander)
results='asis' #important to run this as it ensures the raw table output isn't processed further by knitr
medtable2<-mdata2
emphasize.italics.cols(1)
panderOptions("table.split.table", Inf)
panderOptions("table.split.cells", Inf)
pander(medtable2, style = 'multiline', keep.line.breaks=TRUE,justify = c('right', 'left', 'centre', 'centre', 'centre', 'centre', 'centre'))

}


if (mean(wp$surv) ==1) {
  
  non<-subset(wp,surv=="1") #subset dataset to only include records with one night of surveying
if(nrow(non)>0) {
  non$n <- 0 #add empty columns to enable merger
non$Median <- 0
non$Wilcox.upper <- 0
non$Wilcox.lower <- 0
non$confint <- 0}

mdata2 <- plyr::ddply(non, c("species", "Month"), summarise,
               Median.percentile = ceiling(median(percentile)),#finds median percentile
               conf = max(confint),
               Highest.perc = max(percentile), #returns max percentiles
               Number.nights = length(date), #returns how many nights of data in the dataset
               Reference.range.size = mean(reference_range_size)) #returns reference range size - i used mean as it should be the 
#same in each row because same species same location
names(mdata2)[names(mdata2)=="species"] <- "Species/Species Group"
names(mdata2)[names(mdata2)=="Median.percentile"] <- "Median Percentile"
names(mdata2)[names(mdata2)=="conf"] <- "95% CIs"
names(mdata2)[names(mdata2)=="Highest.perc"] <- "Max Percentile"
names(mdata2)[names(mdata2)=="Number.nights"] <- "Nights Recorded"
names(mdata2)[names(mdata2)=="Reference.range.size"] <- "Reference Range"

library(knitr)
library(pander)
results='asis' #important to run this as it ensures the raw table output isn't processed further by knitr
medtable2<-mdata2
emphasize.italics.cols(1)
panderOptions("table.split.table", Inf)
panderOptions("table.split.cells", Inf)
pander(medtable2, style = 'multiline', keep.line.breaks=TRUE,justify = c('right', 'left', 'centre', 'centre', 'centre', 'centre', 'centre'))

}

```



###Figures

```{r fig.width=9, fig.height=6}

#boxplot if 1 location

graphbox<-ggplot(df, aes(x=Spp, y=percentile))+ #add lines first
  geom_hline(aes(yintercept=0), linetype="dashed", color="#000000") +
  geom_hline(aes(yintercept=20), linetype="dashed", color="#0072B2") +
  geom_hline(aes(yintercept=40), linetype="dashed", color="#56B4E9") +
  geom_hline(aes(yintercept=60), linetype="dashed", color="#009E73") +
  geom_hline(aes(yintercept=80), linetype="dashed", color="#E69F00") +
  geom_boxplot(df, mapping = aes(fill=species))+
  xlab("Species")+
  ylab("Bat Activity Level (Percentile)")+
  scale_fill_grey(start = 0.35, end = 1)+
  scale_x_discrete(drop=FALSE) +
  scale_y_continuous(breaks=seq(0,100,20)) +
  expand_limits(y=c(0,100))+
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_rect(linetype="blank"),
        axis.line=element_line(size=0.5, colour="black", linetype="solid"),
        axis.title.x=element_text(size=18),
        axis.text.x  = element_text(angle=90, face="italic", size=14, hjust=1, vjust=0),
        axis.text.y  = element_text(size=12),
        axis.line.x = element_line(color="black", size = 0.5),
        axis.line.y = element_line(color="black", size = 0.5),
        axis.title.y=element_text(size=16),
        legend.position="none") +
  facet_wrap(~Month, ncol=2)
graphbox

#endcode for boxplot
```

`r '**Figure 1.**\n The activity level (percentile) of bats recorded across each night of the bat survey for the entire site, but split between months.  '`











##### Page Break

## PART 2: Nightly Analysis


```{r infer zeros}

df_spr <- df %>%
  dplyr::select(location_name, lat, lon, Night, Spp, passes.per.hour) %>%
  spread(Spp, passes.per.hour)

df_gath <- df_spr %>%
  gather("Spp", "passes.per.hour", 5:(length(Spp_list)+4)) %>%
  replace(is.na(.), 0) %>%
  arrange(location_name, Night, Spp)


df_z <- df_gath %>%
  mutate(Month = lubridate::month(Night, label = T)) 

df_z2 <- dplyr::left_join(df_z, russ, by = "Spp")

df_passes <- df %>%
  select(Spp, Night, location_name, passes)

df_z3 <- dplyr::left_join(df_z2, df_passes, by = c("Night", "location_name",
                                                       "Spp")) 

df_zero <- df_z3 %>%
  replace(is.na(.), 0)

df_zero$Month <- as.character(df_zero$Month)


# df_spr_a <- df %>%
#   dplyr::select(-date, -species_tvk, -species, -passes, -percentile,
#                 -activity_level, -timestamp, -DateTime, -sunset, -sunrise,
#                 -night_length_min, -night_length_hr, -post_set_min,
#                 -post_set_hr, -pre_rise_min, -pre_rise_hr, -post_set_hr_int,
#                 -pre_rise_hr_int)

 # df_test <- right_join(df, df_gath, by = c("location_name", "Night", "Spp",
 #                                        "passes.per.hour")) %>%
 #   arrange(location_name, Night, Spp)


```


# ENTIRE SURVEY PERIOD

# Sunrise and Sunset Times  
**The times of sunset and sunrise the following morning for surveys beginning on the date shown.**

```{r}
Table <- All_data %>% 
  select(Night, sunset, sunrise) %>% 
  distinct() %>% 
  mutate(night_length = round(as.numeric(difftime(sunrise, sunset, units='hours')), digits = 1),
         sunset = stringr::str_sub(as.character(sunset), 11, 16),
         sunrise = stringr::str_sub(as.character(sunrise), 11, 16)) %>%
  arrange(Night)

colnames(Table) <- c("Night (y-m-d)", "Sunset (hh:mm)", "Sunrise (hh:mm)", "Night Length (hours)")


knitr::kable(Table, align = "cccc")

```


```{r post_set_hr}


# ##### Page Break
# 
# # Distribution of Bat Passes Across Hours of the Night
# ## All Detectors
# 
# **The total number of bat passes occuring during each hour after sunset.**
# 
# \newline  \newline

# ###### Hours After Sunset
# Table <- df %>%
#   dplyr::group_by(Spp, location_name, post_set_hr_int) %>%
#   dplyr::summarise(n = sum(passes)) %>%
#   spread(post_set_hr_int, n) %>%
#   replace(is.na(.), 0) %>%
#   dplyr::rename("Species" = Spp, "Detector ID" = location_name)
# 
# # simple table
# knitr::kable(Table)


```

##### Page Break

# Distribution of Bat Activity Across the Night through Time
## Per Detector

**Timing of bat calls plotted as minutes before/after sunset, whereby 0 on the y axis represents sunset. Sunrise throughout the survey period is depicted as the red dashed line. Colours indicate kernel densities, with darkest colours showing peaks of activity. These colours are comparative only within each plot, and do not account for overall activity.**


```{r, fig.width=10, fig.height=8}


for (i in unique(All_data$Spp)) {

print(All_data %>%
      dplyr::filter(Spp == i) %>%
        
  ggplot(aes(Night, post_set_min)) +
  stat_density2d(aes(alpha = ..level.., fill =..level..), geom="polygon") + 
  scale_fill_gradient(low = "yellow", high = "red") +
  geom_point(size=2, alpha = 0.5) +
  geom_line(data = sun_data, aes(Night, night_length_min),
            linetype = "dashed", colour = "red") +
  xlab("\nDate") + 
  ylab("Minutes after sunset\n") +
  theme_bw() +
  theme (legend.position = "none") +
  theme (axis.title.y = element_text(colour="black", size=18,
                                     face="bold")) +
  theme (axis.title.x = element_text(colour="black", size=18,
                                     face="bold")) +
  theme(strip.text.x = element_text(size=18, face="bold")) +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_rect(colour="black", linetype="solid"),
        axis.line=element_line(size=0.5, colour="black",
                               linetype="solid")) +
  theme(axis.text.x = element_text(angle=90, size=16, hjust=1, vjust=0.5,
                                   colour = "black")) +
  theme(axis.text.y = element_text(size = 16, colour = "black")) +
  facet_wrap(location_name~.) +
  ggtitle(i) +
  theme(plot.title = element_text(face = "bold.italic", size = 18)))
 
}


#position = position_jitter(w = 1, h = 0)) +

```


```{r, fig.width=12, fig.height=8}



# ##### Page Break
# 
# # Distribution of Bat Passes Across Hours of the Night
# ## All Detectors
# 
# **Cumulative number of bat passes throughout the night.**
# 
# \newline  \newline


# Table <- df %>%
#   dplyr::group_by(Spp, location_name, post_set_hr_int) %>%
#   dplyr::summarise(n = sum(passes)) %>%
#   spread(post_set_hr_int, n) %>%
#   replace(is.na(.), 0)
# 
# Table2 <- reshape2::melt(Table, id.vars = c("Spp", "location_name"))
# 
# Table3 <- Table2 %>%
#   dplyr::rename(ss_hr = variable, Passes = value) %>%
#   dplyr::arrange(Spp, location_name, ss_hr) %>%
#   dplyr::group_by(Spp, location_name) %>%
#   dplyr::mutate(cs = cumsum(Passes))
# 
# 
# 
# 
# for (i in (unique(All_data$Spp))) {
#   print(Table3 %>%
#         dplyr::filter(Spp == i) %>%
#         ggplot(aes(x = ss_hr, y = cs, group =1)) +
#         geom_point() +
#         geom_line() +
#         xlab("\nHours after Sunset") +
#         ylab("Total number of passes\n") +
#         scale_color_brewer(palette = "RdBu") +
#         theme_bw() +
#         theme (axis.title.y = element_text(colour="black", size=22,
#                                      face="bold")) +
#         theme (axis.title.x = element_text(colour="black", size=22,
#                                      face="bold")) +
#         theme(strip.text.x = element_text(size=22, face="bold")) +
#         theme(axis.text.x = element_text(size=20, colour = "black")) +
#         theme(axis.text.y = element_text(size = 20, colour = "black")) +
#         facet_wrap(~location_name) +
#         ggtitle(i) +
#         theme(plot.title = element_text(face = "bold.italic", size = 22))
# )
# }
# 


```




##### Page Break

# Roost Emergence Time and Bat Observation

Based on: _Russ, Jon. 2012. British Bat Calls a Guide to species Identification._ 
_Pelagic Publishing._

For more information see <https://rbats-blog.updog.co/2018/05/29/bat-emergence/>

\newline  \newline


## Bat Passes Potentially Indicating Close Proximity to a Roost (Russ 2012) - Table

**Number of bat calls recorded within the species-specific emergence time range, and which therefore may potentially indicate the presence of a nearby roost.**

\newline  \newline
```{r}
Table <- df %>% 
  dplyr::filter(post_set_min <= upper) %>% 
  dplyr::group_by(Night, Spp, location_name) %>% 
  dplyr::summarise(n = sum(passes)) %>%
  spread(Night, n) %>%
  dplyr::arrange(Spp, location_name) %>%
  dplyr::rename("Detector ID" = location_name) %>%
  dplyr::rename("Species" = Spp)

# Make all NA's = 0
Table[is.na(Table)] <- 0

# simple table

    results='asis' 
    panderOptions('table.split.table', 100)
    pander(Table, style = "multiline", justify = "left")

```

##### Page Break

### Bat Passes Potentially Indicating Close Proximity to a Roost (Russ 2012) - Figures

**Figures show time from 15 minutes before to 90 minutes after sunset. species-specific emergence time ranges are shown as grey bars. Bat passes overlapping species-specific grey bars may potentially indicate the presence of a nearby roost.**

\newline  \newline

```{r fig.width=22, fig.height=15}


for (i in seq_len(length(unique(All_data$location_name)))) {
  
print(ggplot(All_data, aes(x=post_set_min, y=Spp, colour=Spp)) +
    geom_segment(aes(x=lower, xend=upper, y=Spp, yend=Spp),
                 size = 25, colour="grey") +
  geom_point(size=5, alpha=0.7,  position = position_jitter(height = 0.3)) +
  xlab("\nTime after sunset (mins)") +
  scale_x_continuous(breaks=c(-15, 0, 15, 30, 45, 60, 75, 90),
                     limits = c(-15, 90)) +
  geom_hline(yintercept = c(seq_len(length(Spp_list)-1) + 0.5),
             colour = "black", linetype = "dotted") +
  scale_y_discrete(drop=TRUE) +
  scale_colour_brewer(palette = "Paired") +
  theme_bw() +
  theme(legend.position = "none") +
  theme(plot.caption = element_text(colour = "black", size = 34)) +
  theme(strip.text.x = element_text(size=34, face="bold")) +
  theme(axis.title.y = element_blank()) +
  theme(axis.title.x = element_text(colour = "black", size = 34,
                                     face = "bold")) +
  theme(axis.text.x = element_text(size = 28, hjust=0.5, vjust=1,
                                   colour = "black",
                                   face = "bold")) +
  theme(axis.text.y = element_text(size = 28, colour = "black",
                                   face = "bold")) +
  theme(panel.background = element_rect(fill = "white")) +
  theme(panel.grid.major.x = element_line(colour = "black",
                                          linetype = "dotted"), 
        panel.grid.minor.x = element_blank(),
        panel.grid.major.y = element_blank(), 
        panel.grid.minor.y = element_blank()) +
  theme (axis.ticks = element_blank()) +
  facet_wrap_paginate(~location_name, ncol=1, nrow=1, page=i))
}


```


```{r}

# adding a column for Day-Month to be used to see if maternity period is included or not

sun_data$month <- lubridate::month(sun_data$Night, label = TRUE)
sun_data$nday <- lubridate::day(sun_data$Night)
sun_data$Day <- paste(sun_data$nday, sun_data$month, sep = "-")


# also add this to All_data - WILL ADD CURRENT YEAR AS YEAR SO NEEDS CHANGING IN GGPLOT CODE BELOW AT THE TURN OF EACH NEW YEAR
All_data$month <- lubridate::month(All_data$Night)
All_data$nday <- lubridate::day(All_data$Night)
All_data$Day <- as.Date(paste(All_data$nday, All_data$month, sep = "-"), format = "%d-%m")

```

`r if ((is.element("15-Jun", sun_data$Day) == TRUE) || (is.element("30-Jul", sun_data$Day) == TRUE)) {'##### Page Break\n### Bat Passes Potentially Indicating Close Proximity to a Roost (Maternity Period Only)\n **Table:** \n *Maternity period defined as 15th June - 30th July.*' }`

```{r}

if ((is.element("15-Jun", sun_data$Day) == TRUE) || (is.element("30-Jul", sun_data$Day) == TRUE)) {

  Maternity <- All_data %>%
  dplyr::filter(Day >= "2019-06-15" & Day <= "2019-07-30") %>%
  dplyr::filter(post_set_min <= upper) %>%
  dplyr::group_by(Night, Spp, location_name) %>%
  dplyr::count() %>%
  spread(Night, n) %>%
  dplyr::arrange(Spp, location_name) %>%
  dplyr::rename("Detector ID" = location_name) %>%
  dplyr::rename("Species" = Spp) %>%
  replace(is.na(.), 0)
  
}

if (exists("Maternity") == TRUE){
  if (nrow(Maternity) > 1) {
 
    results='asis' 
    panderOptions('table.split.table', 100)
    pander(Maternity, style = "multiline", justify = "left")
  
  }
}



```
`r if (exists("Maternity") == TRUE) {if (nrow(Maternity) == 0) {'During the maternity period, no bat calls were detected at a time that would indicate proximity to a roost. Please see the figures below for a visual representation.'}}`

`r if ((is.element("15-Jun", sun_data$Day) == TRUE) || (is.element("30-Jul", sun_data$Day) == TRUE)) {'##### Page Break\n### Bat Passes Potentially Indicating Close Proximity to a Roost (Maternity Period Only)\n **Figures:** *Maternity period defined as 15th June - 30th July.*' }`

```{r fig.width=22, fig.height=15}


# if ((is.element("15-Jun", sun_data$Day) == TRUE) || (is.element("30-Jul", sun_data$Day) == TRUE)) {
# 
# for (i in seq_len(length(unique(All_data$location_name)))) {
# 
#  print(All_data %>%
#     dplyr::filter(Day >= "2019-06-15" & Day <= "2019-07-30") %>% #NEEDS CHANGING EACH YEAR!
#     ggplot(aes(x=post_set_min, y=Spp, colour=Spp)) +
#     geom_segment(aes(x=lower, xend=upper, y=Spp, yend=Spp),
#                  size = 25, colour="grey") +
#   geom_point(size=5, alpha=0.7,  position = position_jitter(height = 0.3)) +
#   xlab("\nTime after sunset (mins)") +
#   scale_x_continuous(breaks=c(-15, 0, 15, 30, 45, 60, 75, 90),
#                      limits = c(-15, 90)) +
#   geom_hline(yintercept = c(seq_len(length(Spp_list)-1) + 0.5),
#              colour = "black", linetype = "dotted") +
#   scale_y_discrete(drop=TRUE) +
#   scale_colour_brewer(palette = "Paired") +
#   theme_bw() +
#   theme(legend.position = "none") +
#   theme(plot.caption = element_text(colour = "black", size = 34)) +
#   theme(strip.text.x = element_text(size=34, face="bold")) +
#   theme(axis.title.y = element_blank()) +
#   theme(axis.title.x = element_text(colour = "black", size = 34,
#                                      face = "bold")) +
#   theme(axis.text.x = element_text(size = 28, hjust=0.5, vjust=1,
#                                    colour = "black",
#                                    face = "bold")) +
#   theme(axis.text.y = element_text(size = 28, colour = "black",
#                                    face = "bold")) +
#   theme(panel.background = element_rect(fill = "white")) +
#   theme(panel.grid.major.x = element_line(colour = "black",
#                                           linetype = "dotted"),
#         panel.grid.minor.x = element_blank(),
#         panel.grid.major.y = element_blank(),
#         panel.grid.minor.y = element_blank()) +
#   theme (axis.ticks = element_blank()) +
#   facet_wrap_paginate(~location_name, nrow=1, ncol=1, page=i))
# }
# 
# }


```



##### Page Break

# Counts of Bat Passes
## All detectors

**The total number of passes recorded for each species across all of the detectors.**
The 'Total' percentage may be slightly above 100% due to rounding of the percentages per species.

\newline  \newline
```{r}

# Aggregate data into species and count

Table <- df %>%
  dplyr::group_by(Spp) %>% 
  dplyr::summarise(passes = sum(passes)) %>%
  dplyr::mutate(Percentage = round((passes / sum(passes) *100), digits = 1)) %>%
  adorn_totals("row")


#Change column Names so more meaningful  
colnames(Table) <- c("Species", "Count (No)", "Percentage of total (%)")

# kable is a simple table generator
knitr::kable(Table, align = "llll")


```


`r if(length(Dets)>1) {'##### Page Break\n# Counts of Bat Passes\n## Per Detector\n **The number of passes recorded for each species at each detector.**\n\n' }`


```{r}

# Aggregate data into species and count

if(length(Dets) >1) {


# TO CREATE A TABLE WITH LOCATION AS A COLUMN
Table <- df %>%
  dplyr::select(Spp, location_name, passes) %>%
  dplyr::group_by(Spp, location_name) %>%
  dplyr::summarise(n = sum(passes)) %>%
  dplyr::ungroup() %>%
  dplyr::group_by(location_name) %>%
  dplyr::mutate(Percentage = round((n / sum(n) *100), digits = 1)) 


#Change column Names so more meaningful  
colnames(Table) <- c("Species", "Detector ID", "Count (No)", "Percentage by Detector (%)")

# kable is a simple table generator
knitr::kable(Table, align = 'lccc')
}

```

##### Page Break

# Species Composition of Passes at each Detector

\newline

```{r fig.height=8, fig.width=10}

# stacked bar plot for proportion of calls by species for each detector

Calls_perc <- df %>%
  dplyr::select(Spp, location_name, passes) %>%
  dplyr::group_by(Spp, location_name) %>%
  dplyr::summarise(n = sum(passes)) %>%
  dplyr::ungroup() %>%
  dplyr::group_by(location_name) %>%
  dplyr::mutate(Percentage = round((n / sum(n) *100), digits = 1))


ggplot(Calls_perc, aes(x = location_name, y = Percentage, fill = Spp)) +
  geom_bar(stat = "identity") +
  xlab("\nDetector ID") +
  ylab("Percentage of calls (%)\n") +
  scale_fill_manual(values = getPalette(colourCount)) +
  guides(fill=guide_legend(title="Species")) +
  theme_bw() +
  theme (axis.title.y = element_text(colour="black", size=20,
                                     face="bold")) +
  theme (axis.title.x = element_text(colour="black", size=20,
                                     face="bold")) +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_rect(colour="black", linetype="solid"),
        axis.line=element_line(size=0.5, colour="black",
                               linetype="solid")) +
  theme(axis.text.x = element_text(size=18, hjust=1, vjust=0.5,
                                   colour = "black", angle = 90)) +
  theme(axis.text.y = element_text(size = 18, colour = "black")) +
  theme(legend.text=element_text(size=18)) +
  theme(legend.title=element_text(size=20))

```

##### Page Break

## **PART 2a: Presence Only**

\newline

**THE NEXT SECTION OF THE REPORT FEATURES THE RAW DATA SUPPLIED TO ECOBAT AND ONLY TAKES INTO ACCOUNT THE PRESENCE, AND NOT THE ABSENCE, OF EACH BAT SPECIES. FOR EACH NIGHT, THERE IS NO 'ZERO DATA' FOR WHEN SPECIES WERE NOT DETECTED.**


##### Page Break


## Nightly Bat Pass Rate (Bat passes per hour)
# Median Per Detector

**The median Nightly Pass Rate (bat passes per hour, per night) of each species. If NA, then no bat passes.**

Bat pass rates are often highly variable between nights, with some nights having few or no passes and other nights having high activity.  In these circumstances, the median is likely to be a more useful summary of the 'average' activity than is the mean. For further information see: *Lintott, P. R., & Mathews, F. (2018). Basic mathematical errors may make ecological assessments unreliable. Biodiversity and Conservation, 27(1), 265-267.* <https://doi.org/10.1007/s10531-017-1418-5>

\newline  \newline

```{r}

Table <- df %>%
  dplyr::group_by(Spp, location_name) %>%
  dplyr::summarise(Median = round(median(passes.per.hour), digits = 1)) %>%
  dplyr::rename("Species" = Spp, "Detector ID" = location_name, 
                "Median Pass Rate" = Median)

  
results='asis' #important to run this as it ensures the raw table output isn't processed further by knitr

knitr::kable(Table, align="l")

```

##### Page Break

## Nightly Bat Pass Rate (Bat passes per hour)
# Mean per Detector

**The mean Nightly Pass Rate (bat passes per hour, per night) of each species at each detector. Values are given to 1 decimal place.**

\newline

We recommend using the median values given above, for the reasons stated above, but provide the mean values in the table below.


```{r}

Table <- df %>%
  dplyr::group_by(Spp, location_name) %>%
  dplyr::summarise(Mean = round(mean(passes.per.hour), digits = 1)) %>%
  dplyr::rename("Species" = Spp, "Detector ID" = location_name,
                "Mean Pass Rate" = Mean)

results='asis' #important to run this as it ensures the raw table output isn't processed further by knitr

knitr::kable(Table, align="l")

```

##### Page Break

# Nightly Bat Passes (Bat passes per hour)
## Per Detector - Figures

Figures show boxplots for the number of bat passes per hour each night, for each detector. The 'box' shows the interquartile range, which is where the middle 50% of the data lie. The line dividing the box is the median, the mid-point of the data. The 'whiskers' extend from the box and represent the ranges for the bottom 25% and the top 25% of the data values, excluding outliers. An outlier is any extreme value that lies further away from the box than 1.5 times the interquartile range. Outliers are shown as dots. Where very few passes are recorded it is not possible to produce the box, so the data are shown as a line.

```{r, fig.width=6, fig.height=5}

for (i in unique(df$Spp)) {
  
  new <- df %>%
  dplyr::filter(Spp == i)
  
  print(new %>%
  ggplot2::ggplot(aes(location_name, passes.per.hour)) +
  geom_boxplot(aes(fill=location_name)) +
  ylab("Nightly Pass Rate (passes/hr/night)\n") +
  xlab("\nDetector ID") +
  {if (length(unique(new$location_name))>1)scale_fill_brewer(palette = "RdBu")} +
  {if (max(new$n) > 0 & max(new$n) <=1)ylim(0,2)} +
  {if (max(new$n) > 1 & max(new$n) <=2)ylim(0,3.0)} +
  {if (max(new$n) > 2 & max(new$n) <=5)ylim(0,6)} +  
  {if (max(new$n) > 5 & max(new$n) <=10)ylim(0,11)} +
  {if (max(new$n) > 10 & max(new$n) <=20)ylim(0,22)} +
  {if (max(new$n) > 20 & max(new$n) <=50)ylim(0,55)} +
  {if (max(new$n) > 50 & max(new$n) <=100)ylim(0,110)} +
  {if (max(new$n) > 100 & max(new$n) <=200)ylim(0,220)} +
  theme_bw() +
  theme (axis.title.y = element_text(colour="black", size=16,
                                     face="bold")) +
  theme (axis.title.x = element_text(colour="black", size=16,
                                     face="bold")) +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_rect(colour="black", linetype="solid"),
        axis.line=element_line(size=0.5, colour="black",
                               linetype="solid")) +
  theme(axis.text.x = element_text(angle = 90, size=14, hjust=0.5, vjust=1,
                                   colour = "black")) +
  theme(axis.text.y = element_text(size = 14, colour = "black")) +
  ggtitle(i) +
  theme(plot.title = element_text(face = "bold.italic", size = 20)) +
  theme(legend.position="none"))
  
}

```



##### Page Break

# SPLIT BY MONTH

# Total Bat Passes per Detector, each Month 
## Per Detector

**The total number of bat passes of each species in each month at each detector.**
This table simply tells you how many bats of each species were recorded passing each detector during each month. These numbers are not standardised by the night length, or how many nights each detector was active for during each month.

\newline 
```{r}

Table <- df %>%
  dplyr::group_by(Spp, Month, location_name) %>%
  dplyr::summarise(n = sum(passes)) %>%
  spread(Month, n) %>%
  dplyr::rename("Detector ID" = location_name) %>%
  dplyr::rename("Species" = Spp)


# Make all NA's = 0
Table[is.na(Table)] <- 0

# Table2 <- Table %>% 
#   remove_rownames %>% 
#   column_to_rownames(var="species")


results='asis' #important to run this as it ensures the raw table output isn't processed further by knitr

panderOptions('table.split.table', 100)

pander(Table, style = "multiline", justify = "left")

```

##### Page Break

# Survey Effort
**The number of survey nights per month per detector.**

```{r}


Table <- All_data %>%
  dplyr::group_by(Month, location_name) %>%
  dplyr::summarise(count = n_distinct(Night)) %>%
  dplyr::arrange(Month, location_name) %>%
  dplyr::rename("No of Survey Nights" = count) %>%
  dplyr::rename("Detector ID" = location_name)

results='asis' #important to run this as it ensures the raw table output isn't processed further by knitr

knitr::kable(Table, align = "lc")

```

##### Page Break

## Nightly Bat Pass Rate for each Month 
# Median Per Detector

**The median Nightly Pass Rate (bat passes per hour, per night) of each species throughout each month. If NA, then no bat passes.**

Bat pass rates are often highly variable between nights, with some nights having few or no passes and other nights having high activity.  In these circumstances, the median is likely to be a more useful summary of the 'average' activity than is the mean. For further information see: *Lintott, P. R., & Mathews, F. (2018). Basic mathematical errors may make ecological assessments unreliable. Biodiversity and Conservation, 27(1), 265-267.* <https://doi.org/10.1007/s10531-017-1418-5>

\newline  \newline

```{r}

Table <- df %>%
  dplyr::group_by(Spp, Month, location_name) %>%
  dplyr::summarise(Median = round(median(passes.per.hour), digits = 1)) %>%
  spread(Month, Median) %>%
  dplyr::rename("Species" = Spp, "Detector ID" = location_name)

  
results='asis' #important to run this as it ensures the raw table output isn't processed further by knitr

knitr::kable(Table)

```

##### Page Break

## Nightly Bat Pass Rate for each Month 
# Mean per Detector

**The mean Nightly Pass Rate (bat passes per hour, per night) of each species throughout each month. Values are given to 1 decimal place.**

\newline

We recommend using the median values given above, for the reasons stated above, but provide the mean values in the table below.


```{r}

Table <- df %>%
  dplyr::group_by(Spp, Month, location_name) %>%
  dplyr::summarise(Mean = round(mean(passes.per.hour), digits = 1)) %>%
  spread(Month, Mean) %>%
  dplyr::rename("Species" = Spp, "Detector ID" = location_name)

results='asis' #important to run this as it ensures the raw table output isn't processed further by knitr

knitr::kable(Table, align="l")

```



##### Page Break

## Nightly Bat Pass Rate for each Month 
## Per Detector - Figures

Figures show boxplots for the number of bat passes per hour by detector, for each month. The 'box' shows the interquartile range, which is where the middle 50% of the data lie. The line dividing the box is the median, the mid-point of the data. The 'whiskers' extend from the box and represent the ranges for the bottom 25% and the top 25% of the data values, excluding outliers. An outlier is any extreme value that lies further away from the box than 1.5 times the interquartile range. Outliers are shown as dots. Where very few passes are recorded it is not possible to produce the box, so the data are shown as a line.

```{r, fig.width=10, fig.height=5}


for (i in unique(df$Spp)) {
  
  new <- df %>%
  dplyr::filter(Spp == i)
  
  print(new %>%
  ggplot2::ggplot(aes(location_name, passes.per.hour)) +
  geom_boxplot(aes(fill=location_name)) +
  ylab("Nightly Pass Rate (passes/hr/night)\n") +
  xlab("\nDetector ID") +
  {if (length(unique(new$location_name))>1)scale_fill_brewer(palette = "RdBu")} +
  {if (max(new$n) > 0 & max(new$n) <=1)ylim(0,2)} +
  {if (max(new$n) > 1 & max(new$n) <=2)ylim(0,3.0)} +
  {if (max(new$n) > 2 & max(new$n) <=5)ylim(0,6)} +  
  {if (max(new$n) > 5 & max(new$n) <=10)ylim(0,11)} +
  {if (max(new$n) > 10 & max(new$n) <=20)ylim(0,22)} +
  {if (max(new$n) > 20 & max(new$n) <=50)ylim(0,55)} +
  {if (max(new$n) > 50 & max(new$n) <=100)ylim(0,110)} +
  {if (max(new$n) > 100 & max(new$n) <=200)ylim(0,220)} +
  theme_bw() +
  theme (axis.title.y = element_text(colour="black", size=16,
                                     face="bold")) +
  theme (axis.title.x = element_text(colour="black", size=18,
                                     face="bold")) +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_rect(colour="black", linetype="solid"),
        axis.line=element_line(size=0.5, colour="black",
                               linetype="solid")) +
  theme(axis.text.x = element_text(angle = 90, size=16, hjust=1, vjust=0.5,
                                   colour = "black")) +
  theme(axis.text.y = element_text(size = 14, colour = "black")) +
  facet_wrap(~Month) +
  theme(strip.text.x = element_text(size=16)) +
  ggtitle(i) +
  theme(plot.title = element_text(face = "bold.italic", size = 22)) +
  theme(legend.position="none"))
  
}

```

##### Page Break

# Bat Activity per Detector Location

**Detector ID reference:**

```{r, fig.width=10, fig.height=8}

Detectors <- df %>%
  dplyr::group_by(location_name, lat, lon) %>%
  dplyr::summarise(n = sum(passes))
  

Detectors %>% 
  ggplot(aes(x=lon, y=lat)) +
  geom_point(aes(x=lon, y=lat), fill = "black", colour = "white") +
    geom_text(aes(x=lon, y=lat, label=location_name), size=10) +
    xlab("\nlon") +
    ylab("lat\n") +
    xlim((min(Detectors$lon) - 0.001), (max(Detectors$lon) + 0.001)) +
    ylim((min(Detectors$lat) - 0.002), (max(Detectors$lat) + 0.002)) +
    guides(fill ="legend") +
    theme_bw() +
    theme (legend.position = "right") +
    theme (axis.title.y = element_text(colour="black", size=18,
                                     face="bold")) +
    theme (axis.title.x = element_text(colour="black", size=18,
                                     face="bold")) +
    theme(strip.text.x = element_text(size=18, face="bold")) +
    theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_rect(colour="black", linetype="solid"),
        axis.line=element_line(size=0.5, colour="black",
                               linetype="solid")) +
    theme(axis.text.x = element_text(angle=90, size=16, hjust=1, vjust=0.5,
                                     
                                   colour = "black")) +
    theme(axis.text.y = element_text(size = 16, colour = "black"))

```

##### Page Break

**Median Nightly Pass Rate (bat passes/hr/night) throughout the survey period - represented by the size and colour of the point at each detector location.**
  
```{r, fig.width=10, fig.height=8}

Table <- df %>%
  dplyr::group_by(Spp, location_name, lat, lon) %>%
  dplyr::summarise(Median = median(passes.per.hour)) %>%
  dplyr::rename("Median.Pass.Rate" = Median)



Table %>%
    ggplot(aes(lon, lat)) +
    geom_point(aes(x = lon, y = lat, size= Median.Pass.Rate,
                   fill = Median.Pass.Rate),
               colour = "black", pch = 21) +
    scale_size_area(max_size = 10) +
    scale_fill_gradient(low = "yellow", high = "red") +
    xlab("\nLongitude") +
    ylab("Latitude\n") +
    xlim((min(Table$lon) - 0.001), (max(Table$lon) + 0.001)) +
    ylim((min(Table$lat) - 0.002), (max(Table$lat) + 0.002)) +
    guides(fill ="legend") +
    theme_bw() +
    theme (legend.position = "right") +
    theme (axis.title.y = element_text(colour="black", size=18,
                                     face="bold")) +
    theme (axis.title.x = element_text(colour="black", size=18,
                                     face="bold")) +
    theme(strip.text.x = element_text(size=18, face="bold")) +
    theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_rect(colour="black", linetype="solid"),
        axis.line=element_line(size=0.5, colour="black",
                               linetype="solid")) +
    theme(axis.text.x = element_text(angle=90, size=16, hjust=1, vjust=0.5,
                                   colour = "black")) +
    theme(axis.text.y = element_text(size = 16, colour = "black")) +
    facet_wrap(~Spp) 

 
```

##### Page Break

**Maximum Nightly Pass Rate (bat passes/hr/night) recorded in a single night throughout the survey period - represented by the size and colour of the point at each detector location.**

```{r, fig.width=10, fig.height=8}


Table <- df %>%
  dplyr::group_by(Spp, location_name, lat, lon) %>%
  dplyr::arrange(passes.per.hour) %>%
  dplyr::top_n(1, passes.per.hour) %>%
  dplyr::filter(row_number()==1) %>%
  dplyr::rename("Max.Pass.Rate" = passes.per.hour)

Table %>%
    ggplot(aes(lon, lat)) +
    geom_point(aes(x = lon, y = lat, size=Max.Pass.Rate,
                   fill = Max.Pass.Rate),
               colour = "black", pch = 21) +
    scale_size_area(max_size = 10) +
    scale_fill_gradient(low = "yellow", high = "red") +
    xlab("\nLongitude") +
    ylab("Latitude\n") +
    xlim((min(Table$lon) - 0.001), (max(Table$lon) + 0.001)) +
    ylim((min(Table$lat) - 0.002), (max(Table$lat) + 0.002)) +
    guides(fill ="legend") +
    theme_bw() +
    theme(legend.position = "right") +
    theme(axis.title.y = element_text(colour="black", size=18,
                                     face="bold")) +
    theme(axis.title.x = element_text(colour="black", size=18,
                                     face="bold")) +
    theme(strip.text.x = element_text(size=18, face="bold")) +
    theme(panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.border = element_rect(colour="black", linetype="solid"),
          axis.line=element_line(size=0.5, colour="black",
                               linetype="solid")) +
    theme(axis.text.x = element_text(angle=90, size=16, hjust=1, vjust=0.5,
                                   colour = "black")) +
    theme(axis.text.y = element_text(size = 16, colour = "black")) +
    facet_wrap(~Spp)

 
```

##### Page Break


## **PART 2B: Includes absences**

\newline

**THE NEXT SECTION OF THE REPORT FEATURES THE DATA SUPPLIED TO ECOBAT BUT TAKES INTO ACCOUNT SPECIES ABSENCES, AND THEREFORE INCLUDES 'ZERO DATA' FOR WHEN SPECIES WERE NOT DETECTED AT EACH DETECTOR ON A NIGHT. THIS DRAMATICALLY LOWERS THE MEANS AND MEDIANS OF THE DATA PRESENTED.**


##### Page Break


## Nightly Bat Pass Rate (Bat passes per hour)
# Median Per Detector

**The median Nightly Pass Rate (bat passes per hour, per night) of each species. If NA, then no bat passes.**

Bat pass rates are often highly variable between nights, with some nights having few or no passes and other nights having high activity.  In these circumstances, the median is likely to be a more useful summary of the 'average' activity than is the mean. For further information see: *Lintott, P. R., & Mathews, F. (2018). Basic mathematical errors may make ecological assessments unreliable. Biodiversity and Conservation, 27(1), 265-267.* <https://doi.org/10.1007/s10531-017-1418-5>

\newline  \newline

```{r}

Table <- df_zero %>%
  dplyr::group_by(Spp, location_name) %>%
  dplyr::summarise(Median = round(median(passes.per.hour), digits = 1)) %>%
  dplyr::rename("Species" = Spp, "Detector ID" = location_name, 
                "Median Pass Rate" = Median)

  
results='asis' #important to run this as it ensures the raw table output isn't processed further by knitr

knitr::kable(Table, align="l")

```

##### Page Break

## Nightly Bat Pass Rate (Bat passes per hour)
# Mean per Detector

**The mean Nightly Pass Rate (bat passes per hour, per night) of each species at each detector. Values are given to 1 decimal place.**

\newline

We recommend using the median values given above, for the reasons stated above, but provide the mean values in the table below.


```{r}

Table <- df_zero %>%
  dplyr::group_by(Spp, location_name) %>%
  dplyr::summarise(Mean = round(mean(passes.per.hour), digits = 1)) %>%
  dplyr::rename("Species" = Spp, "Detector ID" = location_name,
                "Mean Pass Rate" = Mean)

results='asis' #important to run this as it ensures the raw table output isn't processed further by knitr

knitr::kable(Table, align="l")

```

##### Page Break

# Nightly Bat Passes (Bat passes per hour)
## Per Detector - Figures

Figures show boxplots for the number of bat passes per hour each night, for each detector. The 'box' shows the interquartile range, which is where the middle 50% of the data lie. The line dividing the box is the median, the mid-point of the data. The 'whiskers' extend from the box and represent the ranges for the bottom 25% and the top 25% of the data values, excluding outliers. An outlier is any extreme value that lies further away from the box than 1.5 times the interquartile range. Outliers are shown as dots. Where very few passes are recorded it is not possible to produce the box, so the data are shown as a line.

```{r, fig.width=6, fig.height=5}

for (i in unique(df$Spp)) {
  
  new <- df_zero %>%
  dplyr::filter(Spp == i)
  
  print(new %>%
  ggplot2::ggplot(aes(location_name, passes.per.hour)) +
  geom_boxplot(aes(fill=location_name)) +
  ylab("Nightly Pass Rate (passes/hr/night)\n") +
  xlab("\nDetector ID") +
  {if (length(unique(new$location_name))>1)scale_fill_brewer(palette = "RdBu")} +
  {if (max(new$n) > 0 & max(new$n) <=1)ylim(0,2)} +
  {if (max(new$n) > 1 & max(new$n) <=2)ylim(0,3.0)} +
  {if (max(new$n) > 2 & max(new$n) <=5)ylim(0,6)} +  
  {if (max(new$n) > 5 & max(new$n) <=10)ylim(0,11)} +
  {if (max(new$n) > 10 & max(new$n) <=20)ylim(0,22)} +
  {if (max(new$n) > 20 & max(new$n) <=50)ylim(0,55)} +
  {if (max(new$n) > 50 & max(new$n) <=100)ylim(0,110)} +
  {if (max(new$n) > 100 & max(new$n) <=200)ylim(0,220)} +
  theme_bw() +
  theme (axis.title.y = element_text(colour="black", size=16,
                                     face="bold")) +
  theme (axis.title.x = element_text(colour="black", size=16,
                                     face="bold")) +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_rect(colour="black", linetype="solid"),
        axis.line=element_line(size=0.5, colour="black",
                               linetype="solid")) +
  theme(axis.text.x = element_text(angle = 90, size=14, hjust=0.5, vjust=1,
                                   colour = "black")) +
  theme(axis.text.y = element_text(size = 14, colour = "black")) +
  ggtitle(i) +
  theme(plot.title = element_text(face = "bold.italic", size = 20)) +
  theme(legend.position="none"))
  
}

```



##### Page Break

# Survey Effort
**The number of survey nights per month per detector.**

```{r}


Table <- All_data %>%
  dplyr::group_by(Month, location_name) %>%
  dplyr::summarise(count = n_distinct(Night)) %>%
  dplyr::arrange(Month, location_name) %>%
  dplyr::rename("No of Survey Nights" = count) %>%
  dplyr::rename("Detector ID" = location_name)

results='asis' #important to run this as it ensures the raw table output isn't processed further by knitr

knitr::kable(Table, align = "lc")

```

##### Page Break

## Nightly Bat Pass Rate for each Month 
# Median Per Detector

**The median Nightly Pass Rate (bat passes per hour, per night) of each species throughout each month. If NA, then no bat passes.**

Bat pass rates are often highly variable between nights, with some nights having few or no passes and other nights having high activity.  In these circumstances, the median is likely to be a more useful summary of the 'average' activity than is the mean. For further information see: *Lintott, P. R., & Mathews, F. (2018). Basic mathematical errors may make ecological assessments unreliable. Biodiversity and Conservation, 27(1), 265-267.* <https://doi.org/10.1007/s10531-017-1418-5>

\newline  \newline

```{r}


Table <- df_zero %>%
  dplyr::group_by(Spp, Month, location_name) %>%
  dplyr::summarise(Median = round(median(passes.per.hour), digits = 1)) %>%
  spread(Month, Median) %>%
  dplyr::rename("Species" = Spp, "Detector ID" = location_name)

  
results='asis' #important to run this as it ensures the raw table output isn't processed further by knitr

knitr::kable(Table)

```

##### Page Break

## Nightly Bat Pass Rate for each Month 
# Mean per Detector

**The mean Nightly Pass Rate (bat passes per hour, per night) of each species throughout each month. Values are given to 1 decimal place.**

\newline

We recommend using the median values given above, for the reasons stated above, but provide the mean values in the table below.


```{r}

Table <- df_zero %>%
  dplyr::group_by(Spp, Month, location_name) %>%
  dplyr::summarise(Mean = round(mean(passes.per.hour), digits = 1)) %>%
  spread(Month, Mean) %>%
  dplyr::rename("Species" = Spp, "Detector ID" = location_name)

results='asis' #important to run this as it ensures the raw table output isn't processed further by knitr

knitr::kable(Table, align="l")

```



##### Page Break

## Nightly Bat Pass Rate for each Month 
## Per Detector - Figures

Figures show boxplots for the number of bat passes per hour by detector, for each month. The 'box' shows the interquartile range, which is where the middle 50% of the data lie. The line dividing the box is the median, the mid-point of the data. The 'whiskers' extend from the box and represent the ranges for the bottom 25% and the top 25% of the data values, excluding outliers. An outlier is any extreme value that lies further away from the box than 1.5 times the interquartile range. Outliers are shown as dots. Where very few passes are recorded it is not possible to produce the box, so the data are shown as a line.

```{r, fig.width=10, fig.height=5}


for (i in unique(df$Spp)) {
  
  new <- df_zero %>%
  dplyr::filter(Spp == i)
  
  print(new %>%
  ggplot2::ggplot(aes(location_name, passes.per.hour)) +
  geom_boxplot(aes(fill=location_name)) +
  ylab("Nightly Pass Rate (passes/hr/night)\n") +
  xlab("\nDetector ID") +
  {if (length(unique(new$location_name))>1)scale_fill_brewer(palette = "RdBu")} +
  {if (max(new$n) > 0 & max(new$n) <=1)ylim(0,2)} +
  {if (max(new$n) > 1 & max(new$n) <=2)ylim(0,3.0)} +
  {if (max(new$n) > 2 & max(new$n) <=5)ylim(0,6)} +  
  {if (max(new$n) > 5 & max(new$n) <=10)ylim(0,11)} +
  {if (max(new$n) > 10 & max(new$n) <=20)ylim(0,22)} +
  {if (max(new$n) > 20 & max(new$n) <=50)ylim(0,55)} +
  {if (max(new$n) > 50 & max(new$n) <=100)ylim(0,110)} +
  {if (max(new$n) > 100 & max(new$n) <=200)ylim(0,220)} +
  theme_bw() +
  theme (axis.title.y = element_text(colour="black", size=16,
                                     face="bold")) +
  theme (axis.title.x = element_text(colour="black", size=18,
                                     face="bold")) +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_rect(colour="black", linetype="solid"),
        axis.line=element_line(size=0.5, colour="black",
                               linetype="solid")) +
  theme(axis.text.x = element_text(angle = 90, size=16, hjust=1, vjust=0.5,
                                   colour = "black")) +
  theme(axis.text.y = element_text(size = 14, colour = "black")) +
  facet_wrap(~Month) +
  theme(strip.text.x = element_text(size=16)) +
  ggtitle(i) +
  theme(plot.title = element_text(face = "bold.italic", size = 22)) +
  theme(legend.position="none"))
  
}

```


##### Page Break

# Bat Activity per Detector Location

**Detector ID reference:**

```{r, fig.width=10, fig.height=8}

Detectors <- df_zero %>%
  dplyr::group_by(location_name, lat, lon) %>%
  dplyr::summarise(n = sum(passes))
  

Detectors %>% 
  ggplot(aes(x=lon, y=lat)) +
  geom_point(aes(x=lon, y=lat), fill = "black", colour = "white") +
    geom_text(aes(x=lon, y=lat, label=location_name), size=10) +
    xlab("\nlon") +
    ylab("lat\n") +
    xlim((min(Detectors$lon) - 0.001), (max(Detectors$lon) + 0.001)) +
    ylim((min(Detectors$lat) - 0.002), (max(Detectors$lat) + 0.002)) +
    guides(fill ="legend") +
    theme_bw() +
    theme (legend.position = "right") +
    theme (axis.title.y = element_text(colour="black", size=18,
                                     face="bold")) +
    theme (axis.title.x = element_text(colour="black", size=18,
                                     face="bold")) +
    theme(strip.text.x = element_text(size=18, face="bold")) +
    theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_rect(colour="black", linetype="solid"),
        axis.line=element_line(size=0.5, colour="black",
                               linetype="solid")) +
    theme(axis.text.x = element_text(angle=90, size=16, hjust=1, vjust=0.5,
                                     
                                   colour = "black")) +
    theme(axis.text.y = element_text(size = 16, colour = "black"))

```

##### Page Break

**Median Nightly Pass Rate (bat passes/hr/night) throughout the survey period - represented by the size and colour of the point at each detector location.**
  
```{r, fig.width=10, fig.height=8}

Table <- df_zero %>%
  dplyr::group_by(Spp, location_name, lat, lon) %>%
  dplyr::summarise(Median = median(passes.per.hour)) %>%
  dplyr::rename("Median.Pass.Rate" = Median)



Table %>%
    ggplot(aes(lon, lat)) +
    geom_point(aes(x = lon, y = lat, size= Median.Pass.Rate,
                   fill = Median.Pass.Rate),
               colour = "black", pch = 21) +
    scale_size_area(max_size = 10) +
    scale_fill_gradient(low = "yellow", high = "red") +
    xlab("\nLongitude") +
    ylab("Latitude\n") +
    xlim((min(Table$lon) - 0.001), (max(Table$lon) + 0.001)) +
    ylim((min(Table$lat) - 0.002), (max(Table$lat) + 0.002)) +
    guides(fill ="legend") +
    theme_bw() +
    theme (legend.position = "right") +
    theme (axis.title.y = element_text(colour="black", size=18,
                                     face="bold")) +
    theme (axis.title.x = element_text(colour="black", size=18,
                                     face="bold")) +
    theme(strip.text.x = element_text(size=18, face="bold")) +
    theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_rect(colour="black", linetype="solid"),
        axis.line=element_line(size=0.5, colour="black",
                               linetype="solid")) +
    theme(axis.text.x = element_text(angle=90, size=16, hjust=1, vjust=0.5,
                                   colour = "black")) +
    theme(axis.text.y = element_text(size = 16, colour = "black")) +
    facet_wrap(~Spp) 

 
```

##### Page Break

**Maximum Nightly Pass Rate (bat passes/hr/night) recorded in a single night throughout the survey period - represented by the size and colour of the point at each detector location.**

```{r, fig.width=10, fig.height=8}


Table <- df_zero %>%
  dplyr::group_by(Spp, location_name, lat, lon) %>%
  dplyr::arrange(passes.per.hour) %>%
  dplyr::top_n(1, passes.per.hour) %>%
  dplyr::filter(row_number()==1) %>%
  dplyr::rename("Max.Pass.Rate" = passes.per.hour)

Table %>%
    ggplot(aes(lon, lat)) +
    geom_point(aes(x = lon, y = lat, size=Max.Pass.Rate,
                   fill = Max.Pass.Rate),
               colour = "black", pch = 21) +
    scale_size_area(max_size = 10) +
    scale_fill_gradient(low = "yellow", high = "red") +
    xlab("\nLongitude") +
    ylab("Latitude\n") +
    xlim((min(Table$lon) - 0.001), (max(Table$lon) + 0.001)) +
    ylim((min(Table$lat) - 0.002), (max(Table$lat) + 0.002)) +
    guides(fill ="legend") +
    theme_bw() +
    theme(legend.position = "right") +
    theme(axis.title.y = element_text(colour="black", size=18,
                                     face="bold")) +
    theme(axis.title.x = element_text(colour="black", size=18,
                                     face="bold")) +
    theme(strip.text.x = element_text(size=18, face="bold")) +
    theme(panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.border = element_rect(colour="black", linetype="solid"),
          axis.line=element_line(size=0.5, colour="black",
                               linetype="solid")) +
    theme(axis.text.x = element_text(angle=90, size=16, hjust=1, vjust=0.5,
                                   colour = "black")) +
    theme(axis.text.y = element_text(size = 16, colour = "black")) +
    facet_wrap(~Spp)

 
```


