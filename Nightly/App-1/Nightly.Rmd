---
title: "Nightly Bat Activity Analysis"
author: 'Author: `r params$Author`'
date: '`r strftime(Sys.time(), format = "%d/%m/%Y")`'
output: 
    word_document:
      reference_docx: stylesdoc.docx
params:
  n: NA
  Author: NA
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message=FALSE, comment=NULL)

#Libraries used
library(tidyverse) # Enables a consistent approach to data science
library(dplyr)
library(suncalc) # Suntimes
library(knitr)
library(lubridate) # best package for working with dates and times
library(ggplot2)
library(ggforce) # needed for facet_wrap_paginate for plotting graphs on diff pages
library(pander)
library(reshape2) # used for wide/short data format conversions
library(png)
library(grid)
library(janitor) # used to add totals rows to bottoms of tables
library(RColorBrewer) # used for colourblind friendly colour scales on figures


```

```{r}

# TESTING - load in test data

#B_data <- read.csv("../Data/RiggedHill.csv")

```

```{r}
# SHINY

#this is here for when the script is finalised and the Shiny app is deployed
#read data in from shiny
B_data <- params$n

```


```{r, echo=FALSE}

# IF CAN'T GET HEADER IN REF DOC TO WORK ADD A PHOTO LIKE THIS:

#fig.cap="This report was produced free of charge by the Mammal Society to support evidence-based conservation of bats."

#knitr::include_graphics("TMS_logo.png")

# \newline

#The analyses are based on data supplied by the user to the Mammal Society's Ecobat website.  The outputs are designed to assist decision-making, but do not replace expert interpretation by the user. The creation of the Ecobat tool was supported by the Natural Environment Research Council (NERC).
```

```{r}

# Standardize Variables - make names consistent for further manipulation; can do the same for other bat sound analysis software e.g. Kaleidoscope. Make time zone local e.g `"Europe/London"`; adjusts for daylight saving automatically.


# if there is a separate column for date and time then join together to form a new column called Timestamp
if (("Date" %in% colnames(B_data) == TRUE) &
  ("Time" %in% colnames(B_data) == TRUE)) {

B_data$Timestamp <- paste(B_data$Date, B_data$Time) }

  
#Make Time Zone Local
B_data$DateTime <- lubridate::dmy_hms(B_data$Timestamp, tz = "Europe/London")

# change any instances of spec. to spp. in the species column
#B_data$Species <- stringr::str_replace(B_data$Species, "spec.", "spp." )


B_data$SppDets <- paste(B_data$Species, B_data$Detector.ID, sep = ' : ')

```


```{r}

# Create Useful Variables
# `Night` date at dusk
# `Month` month of observation `Jan, Feb, Mar....`
# `JustTime` time hh:mm of bat observation (12 hours added so plots correctly as `Night` i.e. dusk to dawn)
# `bat_time` time in seconds bat present see <https://rbats-blog.updog.co/2018/06/19/a-bat-time-metric/>


# if there is no information about the calls of the bats do this:

if ("Calls" %in% colnames(B_data) == FALSE)
   {

  B_data2 <- B_data %>% 
  mutate(Night = DateTime - lubridate::hours(12)) %>% # DateTime minus 12 hours
  mutate(Night = lubridate::as_date(Night)) %>%
  mutate(Month = lubridate::month(Night, label = T)) %>% # Make Month of observation
  mutate(JustTime = DateTime + lubridate::hours(12)) %>%
  mutate(JustTime = hms::as.hms(stringr::str_sub(as.character(JustTime), start = 12, end = 19))) %>%
  #mutate(Bat_time = (Calls * (Length + Distance)) / 1000) %>% 
  #Remove NA observations 
  filter(!is.na(Species)) %>%
  select(Night, JustTime, DateTime, Species, Month, Latitude, Longitude, Detector.ID, SppDets)
}

# if call info is provided, calculate 'Bat_time'

if ("Calls" %in% colnames(B_data) == TRUE)
   {
  B_data2 <- B_data %>% 
  mutate(Night = DateTime - lubridate::hours(12)) %>% # DateTime minus 12 hours
  mutate(Night = lubridate::as_date(Night)) %>%
  mutate(Month = lubridate::month(Night, label = T)) %>% # Make Month of observation
  mutate(JustTime = DateTime + lubridate::hours(12)) %>%
  mutate(JustTime = hms::as.hms(stringr::str_sub(as.character(JustTime), start = 12, end = 19))) %>%
  mutate(Bat_time = (Calls * (Length + Distance)) / 1000) %>% 
  #Remove NA observations 
  filter(!is.na(Species)) %>%
  select(Night, JustTime, DateTime, Species, Bat_time, Month, Latitude, Longitude, Detector.ID, SppDets)
}

     
# Change the format of the date from Y-m-d to d-m-Y:

# B_data2$Night2 <- as.Date(as.character(B_data2$Night, tz = "Europe/London", "%d/%m/%Y"), "%Y-%m-%d")
# 
# B_data2$Night2 <- format(as.Date(B_data2$Night, format = "%Y-%m-%d"), format = "%d/%m/%Y")
# 
# B_data2$Night3 <- as.Date(B_data2$Night2, format = "%d/%m/%Y")
# 
# glimpse(B_data2)
# 
# # B_data2$Night2 <- format(B_data2$Night, format=c("%d-%m-%Y"))
# # B_data2$Night2 <- as.Date(B_data2$Night, format=c("%d-%m-%Y"))


```


```{r}

# Create suntimes

# Use package `suncalcs` to make `sunset` and `sunrise` columns for each `Night` and the location (`Latitude` and `Longitude`) of the bat survey.

# Get number nights between first and last bat observation (plus 1 for dawn)
num_nights <- as.integer(difftime(max(B_data2$Night) , 
                                  min(B_data2$Night) , 
                                  units = c("days"))) + 1

# Make a date vector of nights between first and last bat observation.
nightlist <- seq.Date(from=min(B_data2$Night), 
                   length.out = num_nights +1, 
                   by='days')

# Get suntimes for date vector and Location (Latitude and Longitude)
setdata <- getSunlightTimes(date = nightlist, 
                            lat = median(B_data2$Latitude, na.rm = T), 
                            lon = median(B_data2$Longitude, na.rm = T), 
                            tz = "Europe/London")

# Duplicate data.frame to make sunrise data
risedata <- setdata

# Select  sunset date and time
setdata2 <- setdata %>% 
  select(date, sunset) %>% 
  mutate(date = lubridate::as_date(date))

# Select  sunrise date and time
risedata2 <- risedata %>% 
  select(date, sunrise) %>% 
  mutate(date = lubridate::as_date(date)) %>%
  mutate(date = date - lubridate::days(1))


# Combine sunset and risedata by 
sun_data <- dplyr::full_join(setdata2, risedata2, by="date")

# Rename date as Night
colnames(sun_data) <- c("Night", "sunset", "sunrise")

sun_data <- sun_data %>% 
  mutate(night_length_hr = as.numeric(difftime(sunrise, sunset, units='hours')),
         night_length_min = as.numeric(difftime(sunrise, sunset, units='mins')))


# Join bat data with the sundata by Night
joined_data <- dplyr::left_join(B_data2, sun_data, by="Night")

```


```{r}
#  ## Create Variables Relative to Suntimes and Bat Observation 
# 
#  Variables relative to suntimes and bat observation   
# 
# * `post_set_min` bat observation time minutes after sunset  
#  * `pre_rise_min` bat observation time minutes before sunrise   
#  * `post_set_hr` bat observation time hours after sunset  
#  * `pre_rise_hr` bat observation time hours before sunrise   
#  * `post_set_hr_int` bat observation time as an integer (hour) after sunset  
#      + `-0.5` to `0.49` hours is `0` hour   
#      + `0.5` to `1.49` hours is `1` hour   
#      + `1.5` to `2.49` hours is `2` hour   
#      + `2.5` to `3.49` hours is `3` hour ect...  

#  * `pre_rise_hr_int` bat observation time as an integer (hour) before sunrise  
#      + `-0.5` to `0.49` hours is `0` hour   
#      + `0.5` to `1.49` hours is `1` hour   
#      + `1.5` to `2.49` hours is `2` hour   
#      + `2.5` to `3.49` hours is `3` hour ect...   
#  * `night_length_hr`  length of the night in hours    


# To make sure difference is in minutes/hours etc... use difftime 
All_data <- joined_data %>% 
  mutate(post_set_min = as.numeric(difftime(DateTime, sunset, units='mins')),
         pre_rise_min = as.numeric(difftime(sunrise, DateTime, units='mins')),
         post_set_hr = as.numeric(difftime(DateTime, sunset, units='hours')),
         pre_rise_hr = as.numeric(difftime(sunrise, DateTime, units='hours')),
         post_set_hr_int = as.integer(round(post_set_hr, digits = 0)),
         pre_rise_hr_int = as.integer(round(pre_rise_hr, digits = 0)))

```

```{r}
#Russ(2012) Bat roost emergence times minutes after sunset
Species <- c("Barbastella barbastellus",
                "Eptesicus serotinus",
                "Myotis alcathoe",
                "Myotis bechsteinii",
                "Myotis brandtii",
                "Myotis daubentonii",
                "Myotis mystacinus",
                "Myotis nattereri",
                "Myotis spp.",
                "Nyctalus leisleri",
                "Nyctalus noctula",
                "Nyctalus spp.",
                "Pipistrellus nathusii",
                "Pipistrellus pipistrellus",
                "Pipistrellus pygmaeus",
                "Pipistrellus spp.",
                "Plecotus auritus",
                "Plecotus austriacus",
                "Rhinolophus ferrumequinum",
                "Rhinolophus hipposideros")

Spp <- c("Barbastelle",
         "Serotine",
         "Alcathoe",
         "Bechstein's",
         "Brandt's",
         "Daubenton's",
         "Whiskered",
         "Natterer's",
         "Myotis spp.",
         "Leisler's",
         "Noctule",
         "Nyctalus spp.",
         "Nathusius'",
         "Common pipistrelle",
         "Soprano pipistrelle",
         "Pipistrellus spp.",
         "Brown long-eared",
         "Grey long-eared",
         "Greater horseshoe",
         "Lesser horseshoe")

lower <- c(25, 20, 30, 30, 30, 50, 30, 35, 30, 8, 5, 5, 18, 22, 22, 18, 40, 40, 35, 35)
upper <- c(60, 25, 35, 33, 35, 70, 35, 55, 70, 18, 9, 18, 28, 32, 28, 32, 60, 60, 48, 50)
russ <- tibble(Species, Spp, lower, upper)


```


```{r}
#Join with Jon Russ data with bat observation data All_data
All_data <- dplyr::left_join(All_data, russ, by = "Species")



# create lists to be used for tables and graphs later:

# list of all of the unique locations in the dataset
Dets <- c(unique(All_data$Detector.ID))

# list of all of the different species in the dataset
Species_list <- unique(All_data$Species)
Spp_list <- unique(All_data$Spp)

# list of all of the unique species-location combinations
SpDet <- c(unique(All_data$SppDets))

# dataframe of survey days 
Surv.days <- as.data.frame(unique(All_data$Night)) #all unique survey nights

Surv.days.N <- length(Surv.days$`unique(All_data$Night)`) #count of survey nights

Surv.days.M <- Surv.days %>%
mutate(Month = lubridate::month((unique(All_data$Night)), label = T)) %>%
  count(Month) #count of survey days per month


colourCount <- length(unique(All_data$Spp))
getPalette <- colorRampPalette(brewer.pal(9, "RdBu"))


All_data$Spp <- factor(All_data$Spp,levels=c("Pipistrellus spp.", "Common pipistrelle", "Soprano pipistrelle","Nathusius'", "Nyctalus spp.","Noctule", "Leisler's","Serotine", "Brown long-eared", "Grey long-eared", "Myotis spp.","Alcathoe", "Bechstein's",  "Brandt's", "Daubenton's","Whiskered", "Natterer's", "Barbastelle", "Greater horseshoe", "Lesser horseshoe"))
         
```

#Summary
Bat surveys were conducted on **`r Surv.days.N`** nights between **`r min(All_data$Night)`** and **`r max(All_data$Night)`**, using **`r (length(Dets))`** static bat detectors. Throughout this period **`r (length(Species_list))`** species were recorded. Detectors were placed at the following locations:

```{r}
Table <- All_data %>%
  select(Detector.ID, Latitude, Longitude) %>%
  group_by(Detector.ID, Latitude, Longitude) %>%
  distinct() %>%
  rename("Detector ID" = Detector.ID)

knitr::kable(Table)


```

# Survey Nights

```{r}

Table <- All_data %>%
  group_by(Detector.ID) %>%
  summarise(count = n_distinct(Night)) %>%
  arrange(Detector.ID) %>%
  rename("Detector ID" = Detector.ID) %>%
  rename("No. of nights" = count)

knitr::kable(Table)

```

##### Page Break

# Survey Nights
Horizontal bars show nights when acoustic detectors recorded bats.
\newline

```{r fig.width=12, fig.height=6}

Effort <- All_data %>%
  arrange(Detector.ID, Night) %>%
  group_by(Detector.ID, Night) %>%
  filter(row_number()==1) %>%
  ungroup() %>%
  select(Detector.ID, Night) %>%
  group_by(Detector.ID) %>%
  mutate(diff_days = round(as.numeric(difftime(Night, lag(Night), units='days')), digits = 1)) %>%
  replace(is.na(.), 0) %>%
  mutate(start = if_else(diff_days == 0 | diff_days > 1, paste(as.Date(Night)), "")) %>%
  mutate(end = if_else(start != "", paste(lag(as.Date(Night))), "")) %>%
  filter(start != "" & end != "") %>%
  mutate_at(c("end"), funs(lead), n=1) %>%
  replace(is.na(.), 0) %>%
  mutate_at(c("end"), funs(ifelse(. == 0, paste(as.Date(start)), .)))


Effort$start <- as.Date(Effort$start)
Effort$end <- as.Date(Effort$end)

Effort %>%
  ggplot() +
  geom_segment(aes(x=start, xend=end, y=Detector.ID, yend=Detector.ID), size = 6) +
  xlab("\nDate") +
  ylab("Detector ID\n") +
  scale_x_date(date_breaks = "1 week", date_labels = "%b %d") +
  theme_bw() +
  theme(legend.position = "none") +
  theme (axis.title.y = element_text(colour="black", size=16,
                                     face="bold")) +
  theme (axis.title.x = element_text(colour="black", size=16,
                                     face="bold")) +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_rect(colour="black", linetype="solid"),
        axis.line=element_line(size=0.5, colour="black",
                               linetype="solid")) +
  theme(axis.text.x = element_text(size=14, hjust=1, vjust=0.5,
                                   colour = "black", angle = 90)) +
  theme(axis.text.y = element_text(size = 14, colour = "black")) +
  theme(legend.text=element_text(size=14)) +
  theme(legend.title=element_text(size=16))

```



##### Page Break

# Sunrise and Sunset Times  
**The times of sunset and sunrise the following morning for surveys beginning on the date shown.**

```{r}
Table <- All_data %>% 
  select(Night, sunset, sunrise) %>% 
  distinct() %>% 
  mutate(night_length = round(as.numeric(difftime(sunrise, sunset, units='hours')), digits = 1),
         sunset = stringr::str_sub(as.character(sunset), 11, 16),
         sunrise = stringr::str_sub(as.character(sunrise), 11, 16)) %>%
  arrange(Night)

colnames(Table) <- c("Night (y-m-d)", "Sunset (hh:mm)", "Sunrise (hh:mm)", "Night Length (hours)")


knitr::kable(Table, align = "cccc")

```

##### Page Break

# Counts of Bat Passes
## All detectors

**The total number of passes recorded for each species across all of the detectors.**

\newline  \newline
```{r}

# Aggregate data into Species and count

  Table <- All_data %>%
  group_by(Spp) %>% 
  count() %>% 
  arrange(Spp) %>%
  ungroup() %>%
  mutate(Percentage = round((n / sum(n) *100), digits = 1)) %>%
  adorn_totals("row")


  

#Change column Names so more meaningful  
colnames(Table) <- c("Species", "Count (No)", "Percentage of total (%)")

# kable is a simple table generator
knitr::kable(Table, align = "llll")


```


`r if(length(Dets)>1) {'##### Page Break\n# Counts of Bat Passes\n## Per Detector\n **The number of passes recorded for each species at each detector.**\n\n' }`


```{r}

# Aggregate data into Species and count


# TO CREATE A SEPARATE TABLE FOR EACH LOCATION:

# for (i in Dets) {
# 
#   print(All_data %>%
#   filter(Detector.ID == i) %>%
#   group_by(Species, Detector.ID) %>% 
#   count() %>% 
#   arrange(desc(n)) %>%
#   ungroup() %>%
#   mutate(Percentage = n / sum(n) *100 ) %>%
#   rename(Location = Detector.ID))
#   }

if(length(Dets) >1) {


# TO CREATE A TABLE WITH LOCATION AS A COLUMN
  Table <- All_data %>%
  group_by(Spp, Detector.ID) %>% 
  count() %>% 
  arrange(Spp, Detector.ID) %>%
  ungroup() %>%
  group_by(Detector.ID) %>%
  mutate(Percentage = round((n / sum(n) *100), digits = 1)) 
  
#Change column Names so more meaningful  
colnames(Table) <- c("Species", "Detector ID", "Count (No)", "Percentage by Detector (%)")

# kable is a simple table generator
knitr::kable(Table, align = 'lccc')
}

```

##### Page Break

# Species Composition of Passes at each Detector

\newline

```{r fig.height=8, fig.width=10}

# stacked bar plot for proportion of calls by species for each detector

  Calls_perc <- All_data %>%
  group_by(Spp, Detector.ID) %>% 
  count() %>% 
  arrange(Detector.ID, desc(Spp)) %>%
  ungroup() %>%
  group_by(Detector.ID) %>%
  mutate(Percentage = round((n / sum(n) *100), digits = 1))

ggplot(Calls_perc, aes(x = Detector.ID, y = Percentage, fill = Spp)) +
  geom_bar(stat = "identity") +
  xlab("\nDetector ID") +
  ylab("Percentage of calls (%)\n") +
  scale_fill_manual(values = getPalette(colourCount)) +
  guides(fill=guide_legend(title="Species")) +
  theme_bw() +
  theme (axis.title.y = element_text(colour="black", size=20,
                                     face="bold")) +
  theme (axis.title.x = element_text(colour="black", size=20,
                                     face="bold")) +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_rect(colour="black", linetype="solid"),
        axis.line=element_line(size=0.5, colour="black",
                               linetype="solid")) +
  theme(axis.text.x = element_text(size=18, hjust=1, vjust=0.5,
                                   colour = "black", angle = 90)) +
  theme(axis.text.y = element_text(size = 18, colour = "black")) +
  theme(legend.text=element_text(size=18)) +
  theme(legend.title=element_text(size=20))

```


```{r}

# \newline  \newline
# 
# ***
# 
# \newline  \newline
# 
# # Total Bat Passes by Night 
# ## All Detectors  
# 
# \newline  \newline

# Table <- All_data %>%
#   group_by(Spp, Night) %>% 
#   count() %>% 
#   spread(Night, n)
# 
# # Make all NA's = 0
# Table[is.na(Table)] <- 0
# 
# 
# # code for having species as the rownames on the left
# Table2 <- Table %>%
#   remove_rownames %>%
#   column_to_rownames(var="Spp") 
# 
# # list <- c(unique(Table$Species))
# # Table3 <- as.data.frame(t(Table[,-1]))
# # colnames(Table3) <- list
# 
# results='asis' #important to run this as it ensures the raw table output isn't processed further by knitr
# 
# panderOptions('table.split.table', 120)
# 
# pander(Table2, style = "multiline", justify = "left")
# 

```

```{r}
# 
# `r if(length(Dets)>1) {'\n\n***\n\n# Total Bat Passes by Night\n\n' }`
# 
# if(length(Dets) >1) {
# 
# Table <- All_data %>%
#   group_by(SppDets, Night) %>% 
#   count() %>% 
#   spread(Night, n)
# 
# # Make all NA's = 0
# Table[is.na(Table)] <- 0
# 
# 
# # code for having species as the rownames on the left
# Table2 <- Table %>%
#   remove_rownames %>%
#   column_to_rownames(var="SppDets")
# 
# # if wanting species along the top:
# # list <- c(unique(Table$Species))
# # Table3 <- as.data.frame(t(Table[,-1]))
# # colnames(Table3) <- list
# 
# results='asis' #important to run this as it ensures the raw table output isn't processed further by knitr
# 
# panderOptions('table.split.table', 100)
# panderOptions('table.split.cells', 2)
# 
# pander(Table2, style = "multiline")
# 
# }

```

```{r}

# ## Mean Bat Passes per Hour
# 
# **Computed as (total bat passes per night)/(night length in hours).**
# 
# \newline  \newline
# 
# 
# Table <- All_data %>%
#   group_by(Spp, Night, night_length_hr) %>% 
#   # count number of passes per night by species - makes coloumn "n""
#   count() %>% 
#   # calculate average bat passes per hour for each Night and species
#   summarise(Act_per_hr = n / night_length_hr) %>%
#   # Remove Night Length column from the Table
#   select(-night_length_hr) %>% 
#   spread(Night, Act_per_hr)
# 
# # Make all NA's = 0
# Table[is.na(Table)] <- 0
# 
# Table2 <- Table %>% 
#   remove_rownames %>% 
#   column_to_rownames(var="Spp")
# 
# 
# results='asis' #important to run this as it ensures the raw table output isn't processed further by knitr
# 
# panderOptions('table.split.table', 100)
# panderOptions('round', 1)
# 
# pander(Table2, style = "multiline")

```


##### Page Break

# Bat Passes per Month 
## Per Detector

**The total number of bat passes of each species in each month at each detector.**

\newline 
```{r}
Table <- All_data %>%
  group_by(Spp, Month, Detector.ID) %>% 
  count() %>% 
  spread(Month, n) %>%
  rename("Detector ID" = Detector.ID) %>%
  rename("Species" = Spp)

# Make all NA's = 0
Table[is.na(Table)] <- 0

# Table2 <- Table %>% 
#   remove_rownames %>% 
#   column_to_rownames(var="Species")


results='asis' #important to run this as it ensures the raw table output isn't processed further by knitr

panderOptions('table.split.table', 100)

pander(Table, style = "multiline", justify = c("left", "centre", "centre", "centre", "centre"))

```


##### Page Break

## Nightly Bat Passes for each Month 
# Median Per Detector

**The median number of bat passes of each species throughout each month. If NA, then no bat passes.**

Bat pass rates are often highly variable between nights, with some nights having few or no passes and other nights having high activity.  In these circumstances, the median is likely to be a more useful summary of the 'average' activity than is the mean. For further information see: *Lintott, P. R., & Mathews, F. (2018). Basic mathematical errors may make ecological assessments unreliable. Biodiversity and Conservation, 27(1), 265-267.* <https://doi.org/10.1007/s10531-017-1418-5>

\newline  \newline

```{r}
Table <- All_data %>%
  group_by(Spp, Detector.ID, Month, Night) %>% 
  count()

Table2 <- Table %>%
  group_by(Spp, Month, Detector.ID) %>%
  summarise(Median = median(n)) %>%
  spread(Month, Median) %>%
  rename("Species" = Spp, "Detector ID" = Detector.ID)



results='asis' #important to run this as it ensures the raw table output isn't processed further by knitr

knitr::kable(Table2)

```

##### Page Break

## Nightly Bat Passes for each Month 
# Mean per Detector

**The mean number of bat passes of each species per night throughout each month. Calculated with (Number of passes each month) / (Number of survey nights each month) for each detector. Values are given to 1 decimal place.**
\newline
**We recommend using the median values given above, for the reasons stated above, but provide the mean values in the table below.**


# Survey Effort
**The number of survey nights per month per detector.**

```{r}

# print(paste("The number of survey nights per month is as folows:"))
# 
# for (i in (unique(All_data$Month))) { 
#     Survs <- All_data %>%
#     filter(Month == i) %>%
#     summarise(Surveys = n_distinct(Night)) %>%
#     mutate(Month = i)
#     print(paste(Survs$Month, "-", Survs$Surveys, "nights"))
#   }


Table <- All_data %>%
  group_by(Month, Detector.ID) %>%
  summarise(count = n_distinct(Night)) %>%
  arrange(Month, Detector.ID) %>%
  rename("No of Survey Nights" = count) %>%
  rename("Detector ID" = Detector.ID)

results='asis' #important to run this as it ensures the raw table output isn't processed further by knitr

knitr::kable(Table, align = "lc")

```

\newline
```{r}

Table <- All_data %>%
  group_by(Spp, Month, Detector.ID) %>% 
  count() %>%
  mutate(new = paste(Month, Detector.ID, sep = " "))

Table2 <- All_data %>%
  group_by(Month, Detector.ID) %>%
  summarise(count = n_distinct(Night)) %>%
  mutate(new = paste(Month, Detector.ID, sep = " "))

Table3 <- left_join(Table, Table2, by = "new") %>%
  mutate("Effort" = round((n/count), digits = 1)) %>%
  select(Month.x, Spp, Detector.ID.x, Effort) %>%
  spread(Month.x, Effort) %>%
  rename("Species" = Spp, "Detector ID" = Detector.ID.x) %>%
  replace(is.na(.), 0)

results='asis' #important to run this as it ensures the raw table output isn't processed further by knitr

knitr::kable(Table3, align="l")

```

##### Page Break


# Bat Passes per Month 
## Per Detector - Figures

Figures show boxplots for the number of bat passes by detector each month. The 'box' shows the interquartile range, which is where the middle 50% of the data lie. The line dividing the box is the median, the mid-point of the data. The 'whiskers' extend from the box and represent the ranges for the bottom 25% and the top 25% of the data values, excluding outliers. An outlier is any extreme value that lies further away from the box than 1.5 times the interquartile range. Outliers are shown as dots. Where very few passes are recorded it is not possible to produce the box, so the data are shown as a line.

```{r, fig.width=10, fig.height=8}

Night_month <- All_data %>%
  group_by(Spp, Night, Month, Detector.ID) %>% 
  count() 


for (i in unique(All_data$Spp)) {
  
  new <- Night_month %>%
  filter(Spp == i)
  
  print(new %>%
  ggplot(aes(Month, n, fill=Detector.ID)) +
  geom_boxplot(aes(fill=Detector.ID)) +
  scale_fill_brewer(palette = "RdBu") +
  ylab("Bat passes per night\n") +
  xlab("\nMonth") +
  {if (max(new$n) <=5)ylim(-0.5,5)} +  
  {if (max(new$n) > 5 & max(new$n) <=10)ylim(-1,10)} +
  {if (max(new$n) > 10 & max(new$n) <=20)ylim(-1,20)} +
  {if (max(new$n) > 20 & max(new$n) <=50)ylim(-1,50)} +  
  {if (max(new$n) > 50 & max(new$n) <=100)ylim(-1,100)} +
  {if (max(new$n) > 100 & max(new$n) <=200)ylim(-1,200)} +
  {if (max(new$n) > 200 & max(new$n) <=300)ylim(-1,300)} +
  {if (max(new$n) > 300 & max(new$n) <=500)ylim(-1,500)} +
  {if (max(new$n) > 500 & max(new$n) <=1000)ylim(-1,1000)} +
  geom_text(aes(y=(min(n)-1), x=Month, label=Detector.ID, group=Detector.ID),
            position=position_dodge(0.8), size=4) +
  theme_bw() +
  theme (axis.title.y = element_text(colour="black", size=18,
                                     face="bold")) +
  theme (axis.title.x = element_text(colour="black", size=18,
                                     face="bold")) +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_rect(colour="black", linetype="solid"),
        axis.line=element_line(size=0.5, colour="black",
                               linetype="solid")) +
  theme(axis.text.x = element_text(size=16, hjust=0.5, vjust=1,
                                   colour = "black")) +
  theme(axis.text.y = element_text(size = 16, colour = "black")) +
  ggtitle(i) +
  theme(plot.title = element_text(face = "bold.italic", size = 22)) +
  theme(legend.position="none"))
  
  # guides(fill=guide_legend(title="Detector ID")) +
  # theme(legend.text=element_text(size=18)) +
  # theme(legend.title=element_text(size=20)))
  #       
}

```





`r if("Bat_time" %in% colnames(All_data) == TRUE) {'##### Page Break\n## Time (Seconds) Bat Present\n **Calculated from...**\n\n'}`

```{r}

if("Bat_time" %in% colnames(All_data) == TRUE) {

Table <- All_data %>%
  group_by(Night, Spp) %>%
  summarise(total_act = sum(Bat_time)) %>%
  spread(Night, total_act)

# Make all NA's = ""
Table[is.na(Table)] <- 0

# simple table with 1 decimal point
knitr::kable(Table, digits = 1)

}

```


##### Page Break

# Distribution of Bat Passes Across Hours of the Night
## All Detectors

**The total number of bat passes occuring during each hour after sunset.**

\newline  \newline

###### Hours After Sunset
```{r}

Table <- All_data %>%
  group_by(Spp, Detector.ID, post_set_hr_int) %>% 
  count() %>% 
  spread(post_set_hr_int, n) %>%
  replace(is.na(.), 0) %>%
  rename("Species" = Spp, "Detector ID" = Detector.ID)


# simple table
knitr::kable(Table)


```

##### Page Break

# Distribution of Bat Activity Across the Night through Time
## Per Detector

**Timing of bat calls plotted as minutes before/after sunset, whereby 0 on the y axis represents sunset. Sunrise throughout the survey period is depicted as the red dashed line. Colours indicate kernel densities, with darkest colours showing peaks of activity. These colours are comparative only within each plot, and do not account for overall activity.**


```{r, fig.width=10, fig.height=8}


for (i in unique(All_data$Spp)) {

print(All_data %>%
        filter(Spp == i) %>%
        
  ggplot(aes(Night, post_set_min)) +
   stat_density2d(aes(alpha = ..level.., fill =..level..), geom="polygon") + 
   # geom_density2d() +
    scale_fill_gradient(low = "yellow", high = "red") +
   geom_point(size=2, alpha = 0.5) +
  geom_line(data = sun_data, aes(Night, night_length_min),
            linetype = "dashed", colour = "red") +
  xlab("\nDate") + 
  ylab("Minutes after sunset\n") +
  #scale_x_date(date_breaks = "1 month", date_labels = "%b %d") +
  theme_bw() +
  theme (legend.position = "none") +
  theme (axis.title.y = element_text(colour="black", size=18,
                                     face="bold")) +
  theme (axis.title.x = element_text(colour="black", size=18,
                                     face="bold")) +
  theme(strip.text.x = element_text(size=18, face="bold")) +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_rect(colour="black", linetype="solid"),
        axis.line=element_line(size=0.5, colour="black",
                               linetype="solid")) +
  theme(axis.text.x = element_text(angle=90, size=16, hjust=1, vjust=0.5,
                                   colour = "black")) +
  theme(axis.text.y = element_text(size = 16, colour = "black")) +
  facet_wrap(Detector.ID~.) +
  ggtitle(i) +
  theme(plot.title = element_text(face = "bold.italic", size = 18)))
 
}


#position = position_jitter(w = 1, h = 0)) +

```

##### Page Break

# Distribution of Bat Passes Across Hours of the Night
## All Detectors

**Cumulative number of bat passes throughout the night.**

\newline  \newline
```{r, fig.width=12, fig.height=8}

Table <- All_data %>%
  group_by(Spp, Detector.ID, post_set_hr_int) %>% 
  count() %>% 
  spread(post_set_hr_int, n) %>%
  replace(is.na(.), 0)

Table2 <- melt(Table)

Table3 <- Table2 %>%
  rename(ss_hr = variable, Passes = value) %>%
  arrange(Spp, Detector.ID, ss_hr) %>%
  group_by(Spp, Detector.ID) %>%
  mutate(cs = cumsum(Passes))


for (i in (unique(All_data$Spp))) {
  print(Table3 %>%
        filter(Spp == i) %>%
        ggplot(aes(x = ss_hr, y = cs, group =1)) +
        geom_point() +
        geom_line() +
        xlab("\nHours after Sunset") +
        ylab("Total number of passes\n") +
        scale_color_brewer(palette = "RdBu") +
        theme_bw() +
        theme (axis.title.y = element_text(colour="black", size=22,
                                     face="bold")) +
        theme (axis.title.x = element_text(colour="black", size=22,
                                     face="bold")) +
        theme(strip.text.x = element_text(size=22, face="bold")) +
        theme(axis.text.x = element_text(size=20, colour = "black")) +
        theme(axis.text.y = element_text(size = 20, colour = "black")) +
        facet_wrap(~Detector.ID) +
        ggtitle(i) +
        theme(plot.title = element_text(face = "bold.italic", size = 22))
)
}



```



##### Page Break

# Bat Activity per Detector Location

**Detector ID reference:**

```{r, fig.width=10, fig.height=8}

Detectors <- All_data %>%
  group_by(Detector.ID, Latitude, Longitude) %>%
  count()
  

Detectors %>% 
  ggplot(aes(x=Longitude, y=Latitude)) +
  geom_point(aes(x=Longitude, y=Latitude), fill = "black", colour = "white") +
    geom_text(aes(x=Longitude, y=Latitude, label=Detector.ID), size=10) +
    xlab("\nLongitude") +
    ylab("Latitude\n") +
    xlim((min(Detectors$Longitude) - 0.001), (max(Detectors$Longitude) + 0.001)) +
    ylim((min(Detectors$Latitude) - 0.002), (max(Detectors$Latitude) + 0.002)) +
    guides(fill ="legend") +
    theme_bw() +
    theme (legend.position = "right") +
    theme (axis.title.y = element_text(colour="black", size=18,
                                     face="bold")) +
    theme (axis.title.x = element_text(colour="black", size=18,
                                     face="bold")) +
    theme(strip.text.x = element_text(size=18, face="bold")) +
    theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_rect(colour="black", linetype="solid"),
        axis.line=element_line(size=0.5, colour="black",
                               linetype="solid")) +
    theme(axis.text.x = element_text(angle=90, size=16, hjust=1, vjust=0.5,
                                     
                                   colour = "black")) +
    theme(axis.text.y = element_text(size = 16, colour = "black"))

```

##### Page Break

**Median of the number of bat calls per night throughout the survey period - represented by the size and colour of the point at each detector location.**
  
```{r, fig.width=10, fig.height=8}

Table <- All_data %>%
  group_by(Spp, Detector.ID, Night, Latitude, Longitude) %>% 
  count()

Table2 <- Table %>%
  group_by(Spp, Detector.ID, Latitude, Longitude) %>%
  summarise(Median = median(n))



Table2 %>%
    ggplot(aes(Longitude, Latitude)) +
    geom_point(aes(x = Longitude, y = Latitude, size= Median, fill = Median),
               colour = "black", pch = 21, position = position_jitter()) +
    scale_size_area(max_size = 10) +
    scale_fill_gradient(low = "yellow", high = "red") +
    xlab("\nLongitude") +
    ylab("Latitude\n") +
    xlim((min(Table$Longitude) - 0.001), (max(Table$Longitude) + 0.001)) +
    ylim((min(Table$Latitude) - 0.002), (max(Table$Latitude) + 0.002)) +
    guides(fill ="legend") +
    theme_bw() +
    theme (legend.position = "right") +
    theme (axis.title.y = element_text(colour="black", size=18,
                                     face="bold")) +
    theme (axis.title.x = element_text(colour="black", size=18,
                                     face="bold")) +
    theme(strip.text.x = element_text(size=18, face="bold")) +
    theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_rect(colour="black", linetype="solid"),
        axis.line=element_line(size=0.5, colour="black",
                               linetype="solid")) +
    theme(axis.text.x = element_text(angle=90, size=16, hjust=1, vjust=0.5,
                                   colour = "black")) +
    theme(axis.text.y = element_text(size = 16, colour = "black")) +
    facet_wrap(~Spp) 

 
```

##### Page Break

**Maximum number of bat calls recorded in a single night throughout the survey period - represented by the size and colour of the point at each detector location.**

```{r, fig.width=10, fig.height=8}

# Table <- All_data %>%
#   group_by(Spp, Detector.ID, Night, Latitude, Longitude) %>% 
#   count() %>%
#   ungroup() %>%
#   group_by(Spp, Detector.ID, Latitude, Longitude) %>%
#   filter(n == max(n))


Table2 <- All_data %>%
  group_by(Spp, Detector.ID, Night, Latitude, Longitude) %>% 
  count() %>%
  ungroup() %>%
  group_by(Spp, Detector.ID, Latitude, Longitude) %>%
  top_n(1) %>%
  filter(row_number()==1)

Table2 %>%
    ggplot(aes(Longitude, Latitude)) +
    geom_point(aes(x = Longitude, y = Latitude, size=n, fill = n),
               colour = "black", pch = 21, position = position_jitter()) +
    scale_size_area(max_size = 10) +
    scale_fill_gradient(low = "yellow", high = "red") +
   # borders(reg="UK", colour = "white", fill="#7f7f7f", alpha=1/4) +
    xlab("\nLongitude") +
    ylab("Latitude\n") +
    xlim((min(Table$Longitude) - 0.001), (max(Table$Longitude) + 0.001)) +
    ylim((min(Table$Latitude) - 0.002), (max(Table$Latitude) + 0.002)) +
    guides(fill ="legend") +
    theme_bw() +
    theme (legend.position = "right") +
    theme (axis.title.y = element_text(colour="black", size=18,
                                     face="bold")) +
    theme (axis.title.x = element_text(colour="black", size=18,
                                     face="bold")) +
    theme(strip.text.x = element_text(size=18, face="bold")) +
    theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_rect(colour="black", linetype="solid"),
        axis.line=element_line(size=0.5, colour="black",
                               linetype="solid")) +
    theme(axis.text.x = element_text(angle=90, size=16, hjust=1, vjust=0.5,
                                   colour = "black")) +
    theme(axis.text.y = element_text(size = 16, colour = "black")) +
    facet_wrap(~Spp)

 
```

##### Page Break

# Roost Emergence Time and Bat Observation

Based on: _Russ, Jon. 2012. British Bat Calls a Guide to Species Identification._ 
_Pelagic Publishing._

For more information see <https://rbats-blog.updog.co/2018/05/29/bat-emergence/>

\newline  \newline


## Bat Passes Potentially Indicating Close Proximity to a Roost (Russ 2012) - Table

**Number of bat calls recorded within the species-specific emergence time range, and which therefore may potentially indicate the presence of a nearby roost.**

\newline  \newline
```{r}
Table <- All_data %>% 
  filter(post_set_min <= upper) %>% 
  group_by(Night, Spp, Detector.ID) %>% 
  count() %>% 
  spread(Night, n) %>%
  arrange(Spp, Detector.ID) %>%
  rename("Detector ID" = Detector.ID) %>%
  rename("Species" = Spp)

# Make all NA's = 0
Table[is.na(Table)] <- 0

# simple table
knitr::kable(Table)
```

##### Page Break

### Bat Passes Potentially Indicating Close Proximity to a Roost (Russ 2012) - Figures

**Figures show time from 15 minutes before to 90 minutes after sunset. Species-specific emergence time ranges are shown as grey bars. Bat passes overlapping species-specific grey bars may potentially indicate the presence of a nearby roost.**

\newline  \newline

```{r fig.width=22, fig.height=15}


for (i in seq_len(length(unique(All_data$Detector.ID)))) {
  
print(ggplot(All_data, aes(x=post_set_min, y=Spp, colour=Spp)) +
    geom_segment(aes(x=lower, xend=upper, y=Spp, yend=Spp),
                 size = 25, colour="grey") +
  geom_point(size=5, alpha=0.7,  position = position_jitter(height = 0.3)) +
  xlab("\nTime after sunset (mins)") +
  scale_x_continuous(breaks=c(-15, 0, 15, 30, 45, 60, 75, 90),
                     limits = c(-15, 90)) +
  geom_hline(yintercept = c(seq_len(length(Spp_list)-1) + 0.5),
             colour = "black", linetype = "dotted") +
  scale_y_discrete(drop=TRUE) +
  scale_colour_brewer(palette = "Paired") +
  theme_bw() +
  theme(legend.position = "none") +
  theme(plot.caption = element_text(colour = "black", size = 34)) +
  theme(strip.text.x = element_text(size=34, face="bold")) +
  theme(axis.title.y = element_blank()) +
  theme(axis.title.x = element_text(colour = "black", size = 34,
                                     face = "bold")) +
  theme(axis.text.x = element_text(size = 28, hjust=0.5, vjust=1,
                                   colour = "black",
                                   face = "bold")) +
  theme(axis.text.y = element_text(size = 28, colour = "black",
                                   face = "bold")) +
  theme(panel.background = element_rect(fill = "white")) +
  theme(panel.grid.major.x = element_line(colour = "black",
                                          linetype = "dotted"), 
        panel.grid.minor.x = element_blank(),
        panel.grid.major.y = element_blank(), 
        panel.grid.minor.y = element_blank()) +
  theme (axis.ticks = element_blank()) +
  facet_wrap_paginate(~Detector.ID, ncol=1, nrow=1, page=i))
}


```

```{r}

# adding a column for Day-Month to be used to see if maternity period is included or not

sun_data$month <- lubridate::month(sun_data$Night, label = TRUE)
sun_data$nday <- lubridate::day(sun_data$Night)
sun_data$Day <- paste(sun_data$nday, sun_data$month, sep = "-")


# also add this to All_data - WILL ADD CURRENT YEAR AS YEAR SO NEEDS CHANGING IN GGPLOT CODE BELOW AT THE TURN OF EACH NEW YEAR
All_data$month <- lubridate::month(All_data$Night)
All_data$nday <- lubridate::day(All_data$Night)
All_data$Day <- as.Date(paste(All_data$nday, All_data$month, sep = "-"), format = "%d-%m")

```

`r if ((is.element("15-Jun", sun_data$Day) == TRUE) || (is.element("30-Jul", sun_data$Day) == TRUE)) {'##### Page Break\n### Bat Passes Potentially Indicating Close Proximity to a Roost (Maternity Period Only)\n **Table:** \n *Maternity period defined as 15th June - 30th July.*' }`

```{r}

if((is.element("15-Jun", sun_data$Day) == TRUE) || (is.element("30-Jul", sun_data$Day) == TRUE)) {
  
  Maternity <- All_data %>% 
  filter(Day >= "2019-06-15" & Day <= "2019-07-30") %>%
  filter(post_set_min <= upper) %>% 
  group_by(Night, Spp, Detector.ID) %>% 
  count() %>% 
  spread(Night, n) %>%
  arrange(Spp, Detector.ID) %>%
  rename("Detector ID" = Detector.ID) %>%
  rename("Species" = Spp) %>%
  replace(is.na(.), 0) 
}

if(nrow(Maternity) > 0) {
  knitr::kable(Maternity) 
}
  
```
`r if (nrow(Maternity) == 0) {'During the maternity period, no bat calls were detected at a time that would indicate proximity to a roost. Please see the figures below for a visual representation.'}`


```{r}

# if(nrow(Maternity) > 0) {
#   knitr::kable(Maternity) 
# } else {
#     ("No records near a roost during maternity period")
#   }


```


`r if ((is.element("15-Jun", sun_data$Day) == TRUE) || (is.element("30-Jul", sun_data$Day) == TRUE)) {'##### Page Break\n### Bat Passes Potentially Indicating Close Proximity to a Roost (Maternity Period Only)\n **Figures:** *Maternity period defined as 15th June - 30th July.*' }`

```{r fig.width=22, fig.height=15}


if ((is.element("15-Jun", sun_data$Day) == TRUE) || (is.element("30-Jul", sun_data$Day) == TRUE)) {
  
for (i in seq_len(length(unique(All_data$Detector.ID)))) {
  
 print(All_data %>%
    filter(Day >= "2019-06-15" & Day <= "2019-07-30") %>% #NEEDS CHANGING EACH YEAR!
    ggplot(aes(x=post_set_min, y=Spp, colour=Spp)) +
    geom_segment(aes(x=lower, xend=upper, y=Spp, yend=Spp),
                 size = 25, colour="grey") +
  geom_point(size=5, alpha=0.7,  position = position_jitter(height = 0.3)) +
  xlab("\nTime after sunset (mins)") +
  scale_x_continuous(breaks=c(-15, 0, 15, 30, 45, 60, 75, 90),
                     limits = c(-15, 90)) +
  geom_hline(yintercept = c(seq_len(length(Spp_list)-1) + 0.5),
             colour = "black", linetype = "dotted") +
  scale_y_discrete(drop=TRUE) +
  scale_colour_brewer(palette = "Paired") +
  theme_bw() +
  theme(legend.position = "none") +
  theme(plot.caption = element_text(colour = "black", size = 34)) +
  theme(strip.text.x = element_text(size=34, face="bold")) +
  theme(axis.title.y = element_blank()) +
  theme(axis.title.x = element_text(colour = "black", size = 34,
                                     face = "bold")) +
  theme(axis.text.x = element_text(size = 28, hjust=0.5, vjust=1,
                                   colour = "black",
                                   face = "bold")) +
  theme(axis.text.y = element_text(size = 28, colour = "black",
                                   face = "bold")) +
  theme(panel.background = element_rect(fill = "white")) +
  theme(panel.grid.major.x = element_line(colour = "black",
                                          linetype = "dotted"), 
        panel.grid.minor.x = element_blank(),
        panel.grid.major.y = element_blank(), 
        panel.grid.minor.y = element_blank()) +
  theme (axis.ticks = element_blank()) +
  facet_wrap_paginate(~Detector.ID, ncol=1, nrow=1, page=i))
}

}


```


